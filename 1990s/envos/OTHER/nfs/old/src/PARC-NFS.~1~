(DEFINE-FILE-INFO READTABLE "INTERLISP" PACKAGE "INTERLISP")(FILECREATED " 7-Sep-89 21:20:50" "{piglet/n}<piglet>nfs>sources>PARC-NFS;9" 4072         changes to%:  (VARS PARC-NFSCOMS) (FUNCTIONS IP.DEFAULT.CONFIGURATION)      previous date%: "24-Aug-89 14:03:27" "{piglet/n}<piglet>nfs>sources>PARC-NFS;7")(* "Copyright (c) 1988, 1989 by Xerox Corporation.  All rights reserved.")(PRETTYCOMPRINT PARC-NFSCOMS)(RPAQQ PARC-NFSCOMS ((FUNCTIONS IP.DEFAULT.CONFIGURATION) (DECLARE%: DONTEVAL@LOAD DOCOPY (VARS (TCP.ALWAYS.READ.HOSTS.FILE NIL)) (P (LET* ((*UPPER-CASE-FILE-NAMES* NIL) (OLDYP (INFILEP "{dsk}yp.init")) (NEWYP (INFILEP (PACKFILENAME.STRING (QUOTE BODY) "yp.init;" (QUOTE BODY) (FULLNAME (INPUT)))))) (COND ((AND NEWYP (OR (NULL OLDYP) (< (GETFILEINFO OLDYP (QUOTE ICREATIONDATE)) (GETFILEINFO NEWYP (QUOTE ICREATIONDATE))))) (PROMPTPRINT "Copying YP.INIT to {DSK}") (COPYFILE NEWYP (OR OLDYP "{dsk}yp.init")))))) (FILES NFS NFSVOLUME) (P (SET (CL:FIND-SYMBOL "*USE-VOLUME-MAP*" (QUOTE NFS)) T) (SET (CL:FIND-SYMBOL "*NS-TO-YP-DOMAIN*" (QUOTE NFS)) (QUOTE (("EuroPARC" ("RX" . "PARC"))))) (* ; "Let EuroPARC folks use PARC id's") (SET (CL:FIND-SYMBOL "*AUTO-MOUNT-NAMES*" (QUOTE NFS)) (QUOTE (("net" . :NET) ("import" . "unixutils.bylocation.sun4")))) (SET (CL:FIND-SYMBOL "*GIDS-FROM-USER-MAP*" (QUOTE YP)) "gid.byuser"))) (DECLARE%: EVAL@COMPILE DONTCOPY (* ; "For access to NSHOSTNUMBER record") (FILES ETHERRECORDS TCPEXPORTS)) (PROP (FILETYPE MAKEFILE-ENVIRONMENT) PARC-NFS)))(CL:DEFUN IP.DEFAULT.CONFIGURATION NIL (DECLARE (GLOBAL \LOCALNDBS \MY.NSHOSTNUMBER)) (* ;; "Infer the hosts's IP configuration from its Pup Address.  This works on the Xerox Internet = 13.x.x.x.  Also, don't bother with hosts file, since we use YP service.") (AND (EQ (OR \PUP.READY (ASSURE.PUP.READY)) T) (LET (PUPADDR PUP-NET-NUMBER) (TO 90 WHILE (EQL 0 (SETQ PUP-NET-NUMBER (LDB (BYTE 8 8) (SETQ PUPADDR (ETHERHOSTNUMBER))))) DO (* ; "Wait until PUP gets initialized enough to know our net") (DISMISS 500) FINALLY (RETURN (IF (EQL PUP-NET-NUMBER 0) THEN (PRINTOUT PROMPTWINDOW T "Pup network number unknown, so can't infer IP address") NIL ELSE (LET ((NSHOST \MY.NSHOSTNUMBER) (IPNET (LOGOR (LLSH 13 24) (* ; "PARC is class A net 13") (LLSH PUP-NET-NUMBER 10) (* ; "low 10 bits is host, middle 14 bits is subnet")))) (CREATE IPINIT LOCAL.ADDRESSES _ (LIST (\IP.ADDRESS.TO.STRING (LOGOR IPNET (LDB (BYTE 8 0) PUPADDR)))) LOCAL.NETWORKS _ (LIST (CONS (\IP.ADDRESS.TO.STRING IPNET) (fetch (NDB NETTYPE) of \LOCALNDBS))) HOSTNAME _ (OR (ETHERHOSTNAME) (LET ((NSHOST \MY.NSHOSTNUMBER)) (* ; "Make up a name like db345123 based on low 18 bits of processor number") (CL:FORMAT NIL "d~A~o" (CASE (MACHINETYPE) (DANDELION #\l) (DAYBREAK #\b) (T #\x)) (+ (LLSH (LOGAND (fetch NSHOST1 of NSHOST) 3) 16) (fetch NSHOST2 of NSHOST))))) SUBNETMASK _ (LIST "13.255.252.0") LOCAL.NSHOSTNUMBER _ NSHOST))))))))(DECLARE%: DONTEVAL@LOAD DOCOPY (RPAQQ TCP.ALWAYS.READ.HOSTS.FILE NIL)(LET* ((*UPPER-CASE-FILE-NAMES* NIL) (OLDYP (INFILEP "{dsk}yp.init")) (NEWYP (INFILEP (PACKFILENAME.STRING (QUOTE BODY) "yp.init;" (QUOTE BODY) (FULLNAME (INPUT)))))) (COND ((AND NEWYP (OR (NULL OLDYP) (< (GETFILEINFO OLDYP (QUOTE ICREATIONDATE)) (GETFILEINFO NEWYP (QUOTE ICREATIONDATE))))) (PROMPTPRINT "Copying YP.INIT to {DSK}") (COPYFILE NEWYP (OR OLDYP "{dsk}yp.init")))))(FILESLOAD NFS NFSVOLUME)(SET (CL:FIND-SYMBOL "*USE-VOLUME-MAP*" (QUOTE NFS)) T)(SET (CL:FIND-SYMBOL "*NS-TO-YP-DOMAIN*" (QUOTE NFS)) (QUOTE (("EuroPARC" ("RX" . "PARC")))))(* ; "Let EuroPARC folks use PARC id's")(SET (CL:FIND-SYMBOL "*AUTO-MOUNT-NAMES*" (QUOTE NFS)) (QUOTE (("net" . :NET) ("import" . "unixutils.bylocation.sun4"))))(SET (CL:FIND-SYMBOL "*GIDS-FROM-USER-MAP*" (QUOTE YP)) "gid.byuser"))(DECLARE%: EVAL@COMPILE DONTCOPY (FILESLOAD ETHERRECORDS TCPEXPORTS))(PUTPROPS PARC-NFS FILETYPE :COMPILE-FILE)(PUTPROPS PARC-NFS MAKEFILE-ENVIRONMENT (:READTABLE "INTERLISP" :PACKAGE "INTERLISP"))(PUTPROPS PARC-NFS COPYRIGHT ("Xerox Corporation" 1988 1989))(DECLARE%: DONTCOPY  (FILEMAP (NIL)))STOP