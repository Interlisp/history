(DEFINE-FILE-INFO READTABLE "XCL" PACKAGE "INTERLISP")(FILECREATED "11-Sep-87 20:05:30" {ERIS}<SHIH>F>CODE>TEXECFIXES.\;1 16683        |changes| |to:|  (VARS TEXECFIXESCOMS)                       (FNS JUNK2FN)); Copyright (c) 1987 by Xerox Corporation.  All rights reserved.(PRETTYCOMPRINT TEXECFIXESCOMS)(RPAQQ TEXECFIXESCOMS ((COMS                     (* |;;| "To support development and compilation")                             (DECLARE\: DONTCOPY (FILES (LOADCOMP)                                                        ATERM TEDITDECLS)))                       (COMS                     (* |;;| "Patch file to fix Lyric TExec")                             (FNS TEXEC.FILLBUFFER))))(* |;;| "To support development and compilation")(DECLARE\: DONTCOPY (FILESLOAD (LOADCOMP)       ATERM TEDITDECLS))(* |;;| "Patch file to fix Lyric TExec")(DEFINEQ(TEXEC.FILLBUFFER  (LAMBDA (FILLTYPE)                                         (* \; "Edited 21-Aug-87 14:49 by jds")(* |;;;| "While filling the line, the current file pointer is the end of the line.  When the line is closed, this is made the eof.  --- #CURRENTRDTBL# is used for syntactic delimiters and paren counting on READ and RATOM calls but isn't referenced (or bound) for READC")    (DECLARE (USEDFREE \#CURRENTRDTBL# \\PRIMTERMTABLE *READ-NEWLINE-SUPPRESS* \\TERM.OFD)           (SPECVARS RSNX TCLASS RTBLSA RAISEDCHAR FILLTYPE RAISEDCHAR PEEKEDECHOED C))    (\\RESETLINE)(* |;;;| "If ERROR or RESET, move STARTINGEOF to end of text (TEXTLEN)")    (RESETLST (RESETSAVE NIL (LIST (FUNCTION (LAMBDA NIL                                               (COND                                                  (RESETSTATE                                                              (* \;                                      "Point to end of text and clearout linebuffer on RESET or ERROR")                                                         (PROG* ((TEXOBJ (|fetch| (TEXTSTREAM TEXTOBJ                                                                                         )                                                                            |of| \\TERM.OFD))                                                                 (SEL (|fetch| SEL |of| TEXOBJ)))                                                                (TEXTPROP TEXOBJ 'STARTINGEOF                                                                       (|fetch| TEXTLEN |of| TEXOBJ))                                                                (|replace| (STREAM REVALIDATEFLG)                                                                   |of| \\LINEBUF.OFD)                                                                (\\RESETTERMINAL)                                                                (\\SHOWSEL SEL)                                                                (|replace| CH# |of| SEL                                                                   |with| (ADD1 (|fetch| TEXTLEN                                                                                   |of| TEXOBJ)))                                                                (|replace| CHLIM |of| SEL                                                                   |with| (ADD1 (|fetch| TEXTLEN                                                                                   |of| TEXOBJ)))                                                                (|replace| POINT |of| SEL                                                                   |with| 'LEFT)                                                                (|replace| DCH |of| SEL |with| 0)                                                                (|replace| SET |of| SEL |with| T)                                                                (\\FIXSEL SEL TEXOBJ))))))))           (PROG* ((RTBLSA (|fetch| READSA |of| \#CURRENTRDTBL#))                   (CONTROLTON (|fetch| CONTROLFLG |of| \\PRIMTERMTABLE))                   (TEXOBJ (|fetch| (TEXTSTREAM TEXTOBJ) |of| \\TERM.OFD))                   (SEL (|fetch| SEL |of| TEXOBJ))                   (WINDOW (|fetch| \\WINDOW |of| TEXOBJ))                   (LINES (|fetch| LINES |of| TEXOBJ))                   RSNX TCLASS C RAISEDCHAR PEEKEDECHOED TTYWINDOW FN TCH INSCH# CHNO ADDEDEOL)(* |;;;| "STARTINGEOF is the beginning of the current text being entered which gets returned to READ so that \\TEXEC.TEXTBOUT knows where to output any text including ^T")(* |;;;| "TCLASS is terminal syntax class, RSNX is read-table code")                  (TEXTPROP TEXOBJ 'STARTINGEOF (|fetch| TEXTLEN |of| TEXOBJ))                                                             (* \; "Keep STARTINGEOF in sync")                  (COND                     ((SETQ C (|fetch| (LINEBUFFER PEEKEDCHAR) |of| \\LINEBUF.OFD))                                                             (* \; "Account for peeked character")                      (SETQ C (IABS C))                      (* \;           "The peeked char may be negative because it was BIN'ed earlier.  Make sure it is positive.")                      (|replace| (LINEBUFFER PEEKEDCHAR) |of| \\LINEBUF.OFD |with| NIL)                      (SETQ PEEKEDECHOED T)                      (SETQ RAISEDCHAR (\\RAISECHAR C))                      (COND                         ((EQ FILLTYPE READ.FT)                          (TEXTPROP TEXOBJ 'STARTINGEOF (SUB1 (TEXTPROP TEXOBJ 'STARTINGEOF)))))                                                             (* \;  "Backup one in textstream to start the input before the peeked and echoed character if doing a READ")                      ))                  (COND                     ((AND CONTROLTON (EQ FILLTYPE READC.FT))                      (TEXEC.INSERTCHAR TEXOBJ C)            (* \;                                                              "Read single char and check for echoing")                      (GO EXIT)))                            (* \;                                                      "If in CONTROL T mode and reading a single char")                  (COND                     (C                     (* |;;| "Working on the previously-peeked char, so skip the keyboard read.  Since the peeked char  has been inserted in the TEdit buffer already, back up the starting-eof counter to include it.")                        (TEXTPROP TEXOBJ 'STARTINGEOF (SUB1 (TEXTPROP TEXOBJ 'STARTINGEOF)))                    (* |;;| "Then go skip the kbd read.")                        (GO NEXTTCLASS)))                    (* |;;| "- - -")                    (* |;;| "Top of the next-character loop")                    (* |;;| "- - -")                  NEXT                  (SETQ C (TEXEC.GETKEY TEXOBJ))             (* \;                                                              "read next character from keyboard")                  NEXTTCLASS                  (SETQ TCLASS (|fetch| TERMCLASS |of| (\\SYNCODE \\PRIMTERMSA (SETQ RAISEDCHAR                                                                                (\\RAISECHAR C)))))                  REDO(* |;;;| "Handle Terminal Class characters")                  (SELECTQ (TEXEC.FILLBUFFER.TCLASS TEXOBJ SEL)                      (NEXT (GO NEXT))                      (EXIT (GO EXIT))                      NIL)(* |;;;| "Here if it isn't a terminal class.")                  (COND                     (PEEKEDECHOED (SETQ PEEKEDECHOED NIL))                     (T (TEXEC.INSERTCHAR TEXOBJ C)))                  (AND (EQ FILLTYPE READC.FT)                       (GO NEXT))                  (COND                     ((EQ ESCAPE.RC (SETQ RSNX (\\SYNCODE RTBLSA RAISEDCHAR)))                      (COND                         ((EQ CTRLV.TC (SETQ TCLASS (|fetch| TERMCLASS |of| (\\SYNCODE \\PRIMTERMSA                                                                                   (SETQ RAISEDCHAR                                                                                    (TEXEC.INSERTCHAR                                                                                     TEXOBJ))))))                          (GO REDO)))                      (GO NEXT)))                  (SELECTC FILLTYPE                      (RATOM/RSTRING.FT                            (COND                              ((AND CONTROLTON (|fetch| STOPATOM |of| RSNX))                               (GO EXIT))))                      (READ.FT (SELECTC RSNX                                   ((LIST RIGHTPAREN.RC RIGHTBRACKET.RC LEFTPAREN.RC LEFTBRACKET.RC                                           STRINGDELIM.RC)                                         (COND                                           ((NOT (TEXEC.EOTP TEXOBJ))                                            (|replace| (STREAM REVALIDATEFLG) |of| \\LINEBUF.OFD                                               |with| T)     (* \;                "Inserting a paren/bracket in the middle of the input, invalidate paren/bracket count")                                            ))                                        (SELECTC RSNX                                            ((LIST RIGHTPAREN.RC RIGHTBRACKET.RC)                                                  (TEXEC.FLASHCARET TEXOBJ (TEXEC.PARENMATCH TEXOBJ                                                                                  RSNX)))                                            NIL))                                   NIL)                               (COND                                  ((AND CONTROLTON (ZEROP (|fetch| (LINEBUFFER LBRKCOUNT)                                                             |of| \\LINEBUF.OFD))                                        (ZEROP (|fetch| (LINEBUFFER LPARCOUNT) |of| \\LINEBUF.OFD))                                        (|fetch| STOPATOM |of| RSNX)                                        (SELECTC RSNX                                            ((LIST LEFTPAREN.RC LEFTBRACKET.RC RIGHTBRACKET.RC                                                    RIGHTPAREN.RC)                                                  NIL)                                            (STRINGDELIM.RC                                                  (COND                                                    ((|fetch| (LINEBUFFER INSTRINGP) |of|                                                                                         \\LINEBUF.OFD                                                            )                                                     (|replace| (LINEBUFFER INSTRINGP) |of|                                                                                         \\LINEBUF.OFD                                                        |with| NIL)                                                     T)))                                            (NOT (|fetch| (LINEBUFFER INSTRINGP) |of| \\LINEBUF.OFD))                                         ))                    (* |;;| "READ is reading an atom.  Return when atom ends, but also obey bracket/paren exception noted on page 14.33 of manual.")                                   (GO EXIT)))                               (COND                                  ((TEXEC.EOTP TEXOBJ)                                   (COND                                      ((|fetch| (STREAM REVALIDATEFLG) |of| \\LINEBUF.OFD)                                       (TEXEC.PARENCOUNT TEXOBJ)                                                             (* \;                                                              "text needs recount of parens/brackets")                                       ))                                   (COND                                      ((\\INCPARENCOUNT RSNX)                                       (COND                                          ((STREAMPROP \\TERM.OFD 'FIXFLG)                                           (STREAMPROP \\TERM.OFD 'FIXFLG NIL)                                                             (* \;                               "Expression is being FIXed by user, reset FIXFLG and go for more input")                                           (GO NEXT)))                    (* |;;| "Parens balance--throw the carriage if the closing paren or bracket character was not a CR, and if FLG argument of READ is NIL.  (We know we are under a READ call because of FILLTYPE)")                                                             (* \;                                              "copy the chars from the textstream into the linebuffer")                                       (TEXEC.TEXTSTREAM.TO.LINEBUF TEXOBJ (TEXTPROP TEXOBJ                                                                                  'STARTINGEOF)                                              \\LINEBUF.OFD FILLTYPE)                                                             (* \;                              "AND (EQ FILLTYPE READ.FT) (TEXEC.FIX?  TEXOBJ \\LINEBUF.OFD) (GO NEXT)")                                                             (* \;                                             "If it was a PA FIX command handle it, and allow editing")                                                             (* \;                                       "now reset the new STARTINGEOF to start at the end of the text")                                       (TEXTPROP TEXOBJ 'STARTINGEOF (|fetch| TEXTLEN |of| TEXOBJ))                                       (\\CLOSELINE)                                       (AND (NEQ RAISEDCHAR (CHARCODE EOL))                                            (NOT *READ-NEWLINE-SUPPRESS*)                                            (\\OUTCHAR \\TERM.OFD (CHARCODE EOL)))                                                             (* \;                                                     "\\CLOSELINE first so dribble happens before EOL")                                       (RETURN))                                      ((EQ IMMEDIATE.RMW (|fetch| WAKEUP |of| RSNX))                                                             (* \; "Immediate read-macro")                                       (RETURN))))))                      (SHOULDNT))                  (GO NEXT)                  EXIT                  (COND                     ((STREAMPROP \\TERM.OFD 'FIXFLG)                      (STREAMPROP \\TERM.OFD 'FIXFLG NIL)                      (COND                         ((NEQ RAISEDCHAR (CHARCODE EOL))    (* \;                               "Expression is being FIXed by user, reset FIXFLG and go for more input")                          (GO NEXT)))))                  (COND                     ((AND (EQ FILLTYPE READ.FT)                           (EQ RAISEDCHAR (CHARCODE EOL))                           (EQ (SUB1 (|fetch| TEXTLEN |of| TEXOBJ))                               (TEXTPROP TEXOBJ 'STARTINGEOF)))                      (\\LINEBUFBOUT \\LINEBUF.OFD (CAR (GETSYNTAX 'RIGHTBRACKET \#CURRENTRDTBL#)))                    (* |;;| "If doing a READ, force a lone CR to terminate the READ by handing back a RIGHTBRACKET into the LINEBUFFER")                      )                     (T (TEXEC.TEXTSTREAM.TO.LINEBUF TEXOBJ (TEXTPROP TEXOBJ 'STARTINGEOF)                               \\LINEBUF.OFD FILLTYPE)))                  (TEXTPROP TEXOBJ 'STARTINGEOF (|fetch| TEXTLEN |of| TEXOBJ))                                                             (* \;                              "AND (EQ FILLTYPE READ.FT) (TEXEC.FIX?  TEXOBJ \\LINEBUF.OFD) (GO NEXT)")                                                             (* \;                                             "If it was a PA FIX command handle it, and allow editing")                  (\\CLOSELINE)                  (AND (NEQ RAISEDCHAR (CHARCODE EOL))                       (NOT CONTROLTON)                       (NOT *READ-NEWLINE-SUPPRESS*)                       (\\OUTCHAR \\TERM.OFD (CHARCODE EOL))))))))(PUTPROPS TEXECFIXES COPYRIGHT ("Xerox Corporation" 1987))(DECLARE\: DONTCOPY  (FILEMAP (NIL (906 16601 (TEXEC.FILLBUFFER 916 . 16599)))))STOP