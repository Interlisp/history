(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)(FILECREATED "27-Jul-90 07:39:38" {DSK}<usr>local>lde>loops>src>SYSTEM>LOADLOOPS.;2 15136        changes to%:  (VARS LOADLOOPSCOMS)      previous date%: " 6-Jul-88 11:19:16" {DSK}<usr>local>lde>loops>src>SYSTEM>LOADLOOPS.;1)(* ; "Copyright (c) 1983, 1984, 1985, 1986, 1987, 1988, 1990 by Venue & Xerox Corporation.  All rights reserved.")(PRETTYCOMPRINT LOADLOOPSCOMS)(RPAQQ LOADLOOPSCOMS ((* ;;; "Loops loadup stuff") (* ;; "Bootstrap function until LOOPSBROWSE is loaded") (P (PUTD (QUOTE UpdateClassBrowsers) (GETD (QUOTE NILL)))) (FNS LOADLOOPS LoadLispUsers UnMarkChanges) (* ;; "JRB - LAMBDATRAN is no longer necessary; ICONW lives in Lyric") (* ;; "JRB - Remember to remove SEDIT-PATCH for Medley") (VARS (LispUserFilesForLoops (QUOTE (GRAPHER))) (LoopsPatchFiles NIL) (*DEFAULT-CLEANUP-COMPILER* (QUOTE CL:COMPILE-FILE)) (LOOPSFILES (QUOTE (LOADLOOPS LOOPSSITE BLOCKLOOKUP LOOPSSPEEDUP LOOPSDATATYPES LOOPSSTRUC LOOPSPRINT LOOPS-FILEPKG LOOPSACCESS LOOPSUID LOOPSEDIT LOOPSMETHODS LOOPSKERNEL LOOPSACTIVEVALUES LOOPSUTILITY LOOPSINSPECT LOOPSWINDOW LOOPSBROWSE LOOPSDEBUG LOOPSUSERINTERFACE LOOPS-TTYEDIT SEDIT-PATCH INSPECT-PATCH)))) (* ;; "Loopsms is being moved to the library.") (* ;; "Loops version decl's") (VARS (LoopsVersion (QUOTE Lyric/Medley))) (* ;; "Some utility functions and macros we like having around - these are actually used in Loops") (FNS PromptEval PromptRead) (MACROS MenuGetOrCreate) (* ; "NiceMenu is used all over the place. It really doesn't belong in this file") (FNS NiceMenu) (* ;; "Load the site specific file. Note that this assumes that the file is easily found, say on the same directory as this file. If no file is found, that is OK, it is assumed that there is no site file.") (* ; "The ugly RESETLST stuff is to prevent the TTY window from hanging.") (P (RESETLST (RESETSAVE (WINDOWPROP \TopLevelTtyWindow (QUOTE PAGEFULLFN) (FUNCTION NILL)) (LIST (FUNCTION WINDOWPROP) \TopLevelTtyWindow (QUOTE PAGEFULLFN) (WINDOWPROP \TopLevelTtyWindow (QUOTE PAGEFULLFN)))) (FILESLOAD (NOERROR) LoopsSite))) (* ;; "Some reasonable defaults, in case they wern't set by the site file") (INITVARS (LoadLoopsForms NIL) (OptionalLispuserFiles NIL) (* ;; "All this stuff now gets set by the LOOPS.DFASL file... YAAAY!") (LOOPSDIRECTORY (LET ((thisFile (FULLNAME (GETSTREAM NIL (QUOTE INPUT))))) (PACKFILENAME (QUOTE HOST) (FILENAMEFIELD thisFile (QUOTE HOST)) (QUOTE DEVICE) (FILENAMEFIELD thisFile (QUOTE DEVICE)) (QUOTE DIRECTORY) (FILENAMEFIELD thisFile (QUOTE DIRECTORY))))) (* ;; "If LOOPSDIRECTORY happens to end in %"SOURCES>%" or %"SYSTEM>%", construct the library, users, and rules directory pathnames by replacing it with %"LIBRARY>%", %"USERS>%", and %"USERS>RULES>%" respectively.  Otherwise punt and set them the same as LOOPSDIRECTORY.") (LOOPSLIBRARYDIRECTORY (LET ((POSSOURCES (OR (STRPOS "SOURCES>" LOOPSDIRECTORY NIL NIL T NIL NIL T) (STRPOS "SYSTEM>" LOOPSDIRECTORY NIL NIL T NIL NIL T)))) (IF POSSOURCES THEN (MKATOM (CONCAT (SUBSTRING LOOPSDIRECTORY 1 (SUB1 POSSOURCES)) "LIBRARY>")) ELSE LOOPSDIRECTORY))) (LOOPSUSERSDIRECTORY (LET ((POSSOURCES (OR (STRPOS "SOURCES>" LOOPSDIRECTORY NIL NIL T NIL NIL T) (STRPOS "SYSTEM>" LOOPSDIRECTORY NIL NIL T NIL NIL T)))) (IF POSSOURCES THEN (MKATOM (CONCAT (SUBSTRING LOOPSDIRECTORY 1 (SUB1 POSSOURCES)) "USERS>")) ELSE LOOPSDIRECTORY))) (LOOPSUSERSRULESDIRECTORY (LET ((POSSOURCES (OR (STRPOS "SOURCES>" LOOPSDIRECTORY NIL NIL T NIL NIL T) (STRPOS "SYSTEM>" LOOPSDIRECTORY NIL NIL T NIL NIL T)))) (IF POSSOURCES THEN (MKATOM (CONCAT (SUBSTRING LOOPSDIRECTORY 1 (SUB1 POSSOURCES)) "USERS>RULES>")) ELSE LOOPSDIRECTORY))))))(* ;;; "Loops loadup stuff")(* ;; "Bootstrap function until LOOPSBROWSE is loaded")(PUTD (QUOTE UpdateClassBrowsers) (GETD (QUOTE NILL)))(DEFINEQ(LOADLOOPS  [LAMBDA (sysout-dir load-option)                        (* ; "Edited 28-Jun-88 18:08 by JAMES.PA")    (DECLARE (GLOBALVARS LoopsPatchFiles LOOPSFILES LoadLoopsForms LOOPSDIRECTORY LoopsDate                     *FEATURES*))    (CNDIR LOOPSDIRECTORY)    [RESETLST                     (* ;; "stop the tty window from hanging up while loading files")           [RESETSAVE (WINDOWPROP \TopLevelTtyWindow 'PAGEFULLFN (FUNCTION NILL))                  (LIST (FUNCTION WINDOWPROP)                        \TopLevelTtyWindow                        'PAGEFULLFN                        (WINDOWPROP \TopLevelTtyWindow 'PAGEFULLFN]                                                             (* ;                            "Binding the variables LISPXHIST and LISPXHISTORY so history is not saved")           (RESETVARS (LISPXHISTORY)                      (PROG ((DIRECTORIES (CONS NIL (CONS (DIRECTORYNAME T T)                                                          DIRECTORIES)))                             LISPXHIST)                    (* ;; "Load the files")                            (if LoopsPatchFiles then (for file in LoopsPatchFiles when (ATOM file)                                                          do                                                          (PUTPROP (ROOTFILENAME file)                                                                 'FILEDATES NIL))                                (DOFILESLOAD LoopsPatchFiles))                            (LoadLispUsers)                            (DOFILESLOAD (CONS (MKLIST (OR load-option 'COMPILED))                                               LOOPSFILES))                            (if (EQ MAKESYSNAME ':MEDLEY)                                then                         (* ; "This load must be conditionalized here since the file will be compiled in Medley and not loadable in Lyric at all.")                                (FILESLOAD MEDLEY-PATCH.DFASL))                            (if (EQ MAKESYSNAME ':LYRIC)                                then                         (* ; "This is only needed in Lyric, a fix to make sure that LLSH compiles inline.  Important for the method and IV cache routines.")                                (FILESLOAD LOOPS-PATCH.DFASL))                    (* ;; "Replace any boot-strapping stuff with the real thing")                            (MOVD 'FullInstallMethod 'InstallMethod)                            (MOVD 'FullNameObject 'NameObject)                            (FILEPKGTYPE 'FNS 'WHENCHANGED (NCONC1 (FILEPKGTYPE 'FNS 'WHENCHANGED)                                                                  'FnOrMethodChanged))                    (* ;; "Remember info about the state of the system")                            (push *FEATURES* 'LOOPS :LOOPS)                            (SETQ LoopsDate (DATE))                    (* ;; "Now do any user specified initialization")                            (for form in LoadLoopsForms do (EVAL form]    (COND       (sysout-dir (SETQ FILELST NIL)              (SETQ LOGINHOST/DIR NIL)              (SETQ INITIALSLST)              (SETQ USERNAME NIL)              (SETQ FIRSTNAME 'SirOrMadam)              (CLEARW \TopLevelTtyWindow)              (UnMarkChanges)              (ENDLOADUP)              (COND                 ((NEQ T sysout-dir)                  (/CNDIR sysout-dir)))              (MAKESYS 'LOOPS.SYSOUT (PACK* 'LOOPS "/" MAKESYSNAME)))       (T (for file in LOOPSFILES do (change FILELST (DREMOVE file DATUM])(LoadLispUsers  [LAMBDA NIL                                                (* edited%: " 4-Apr-86 10:35")                    (* * Load the usual Lispusers files for Loops)    (DOFILESLOAD (CONS '(SYSLOAD FROM VALUEOF LISPUSERSDIRECTORIES) OptionalLispuserFiles))    (DOFILESLOAD (CONS '(SYSLOAD FROM VALUEOF LISPUSERSDIRECTORIES) LispUserFilesForLoops])(UnMarkChanges  [LAMBDA (FILES)                                            (* smL "10-Dec-86 19:19")                    (* * Unmark all changes that have been made and forget files to list and           compile)    (SETQ NOTLISTEDFILES NIL)    (SETQ NOTCOMPILEDFILES NIL)    (UPDATEFILES)    [SETQ OLDCHANGES (for file in FILELST first (SETQ $$VAL (FILEPKGCHANGES))                          when                          (OR (NULL FILES)                              (FMEMB file FILES))                          join                          (CDR (GETPROP file 'FILE]    [for COM in OLDCHANGES when (NEQ COMMENTFLG (CAR COM))         do         (for ITEM in (CDR COM)              do              (UNMARKASCHANGED ITEM (CAR COM]    OLDCHANGES]))(* ;; "JRB - LAMBDATRAN is no longer necessary; ICONW lives in Lyric")(* ;; "JRB - Remember to remove SEDIT-PATCH for Medley")(RPAQQ LispUserFilesForLoops (GRAPHER))(RPAQQ LoopsPatchFiles NIL)(RPAQQ *DEFAULT-CLEANUP-COMPILER* CL:COMPILE-FILE)(RPAQQ LOOPSFILES (LOADLOOPS LOOPSSITE BLOCKLOOKUP LOOPSSPEEDUP LOOPSDATATYPES LOOPSSTRUC LOOPSPRINT LOOPS-FILEPKG LOOPSACCESS LOOPSUID LOOPSEDIT LOOPSMETHODS LOOPSKERNEL LOOPSACTIVEVALUES LOOPSUTILITY LOOPSINSPECT LOOPSWINDOW LOOPSBROWSE LOOPSDEBUG LOOPSUSERINTERFACE LOOPS-TTYEDIT SEDIT-PATCH INSPECT-PATCH))(* ;; "Loopsms is being moved to the library.")(* ;; "Loops version decl's")(RPAQQ LoopsVersion Lyric/Medley)(* ;; "Some utility functions and macros we like having around - these are actually used in Loops")(DEFINEQ(PromptEval  [LAMBDA (promptString window sameLine?)                    (* ; "Edited 17-Nov-87 10:26 by jrb:")                    (* Printout promptString in promptwindow and return value of expression read           there)    (PROG [NEWVALUE (mainWindow (WINDOWPROP window 'MAINWINDOW]          (RESETLST (RESETSAVE (TTYDISPLAYSTREAM (OR window PROMPTWINDOW)))                 (RESETSAVE (TTY.PROCESS (THIS.PROCESS)))                 (CLRPROMPT)                 (RESETSAVE (PRINTLEVEL 4 3))                 (printout T promptString T "The expression read will be EVALuated.")                 (if sameLine? then (printout T "> ")                     else                     (printout T T "> "))                    (* ;; "Make sure that buttoning the main window drags the TTY back here if window is an attachedwindow, and that closing it kills us")                 (if mainWindow then (WINDOWPROP mainWindow 'PROCESS (WINDOWPROP window 'PROCESS))                     (WINDOWADDPROP mainWindow 'CLOSEFN 'Don'tCloseIfBusy 'FIRST))                 (CL:UNWIND-PROTECT (SETQ NEWVALUE (LISPX (LISPXREAD T T)                                                          '>))                        (AND mainWindow (WINDOWPROP mainWindow 'PROCESS NIL)))                                                             (* clear tty buffer because it                                                              sometimes has stuff left.)                 (CLEARBUF T T))          (RETURN NEWVALUE])(PromptRead  [LAMBDA (promptString window sameLine?)                    (* ; "Edited 17-Nov-87 10:23 by jrb:")                                                             (* ;                     "Printout promptString in promptwindow and return value of expression read there")    (PROG [NEWVALUE (mainWindow (WINDOWPROP window 'MAINWINDOW]          [RESETLST (RESETSAVE (TTYDISPLAYSTREAM (OR window PROMPTWINDOW)))                 (RESETSAVE (TTY.PROCESS (THIS.PROCESS)))                 (CLRPROMPT)                 (RESETSAVE (PRINTLEVEL 4 3))                 (printout T promptString)                 (if sameLine? then (printout T "> ")                     else                     (printout T T "> "))                 (CLEARBUF T T)                              (* ;                                               "clear tty buffer because it sometimes has stuff left.")                    (* ;; "Make sure that buttoning the main window drags the TTY back here if window is an attachedwindow, and that it won't close until done")                 (if mainWindow then (WINDOWPROP mainWindow 'PROCESS (WINDOWPROP window 'PROCESS))                     (WINDOWADDPROP mainWindow 'CLOSEFN 'Don'tCloseIfBusy 'FIRST))                 (ALLOW.BUTTON.EVENTS)                 (CL:UNWIND-PROTECT [SETQ NEWVALUE (CAR (ERSETQ (TTYINREAD T T]                        (AND mainWindow (WINDOWPROP mainWindow 'PROCESS NIL]          (RETURN NEWVALUE]))(DECLARE%: EVAL@COMPILE (PUTPROPS MenuGetOrCreate MACRO ((name items) (COND ((type? MENU (GETTOPVAL (QUOTE name))) name) (T (SETTOPVAL (QUOTE name) (create MENU CHANGEOFFSETFLG _ T ITEMS _ items)))))))(* ; "NiceMenu is used all over the place. It really doesn't belong in this file")(DEFINEQ(NiceMenu  [LAMBDA (items title)                                      (* dgb%: " 1-Feb-85 13:15")    (COND       ((NULL items)        (PROMPTPRINT "No items for " title)        NIL)       (T (MENU (create MENU CHANGEOFFSETFLG _ T ITEMS _ items TITLE _ title MENUCOLUMNS _                       (IPLUS 1 (IQUOTIENT (FLENGTH items)                                       35]))(* ;; "Load the site specific file. Note that this assumes that the file is easily found, say on the same directory as this file. If no file is found, that is OK, it is assumed that there is no site file.")(* ; "The ugly RESETLST stuff is to prevent the TTY window from hanging.")(RESETLST (RESETSAVE (WINDOWPROP \TopLevelTtyWindow (QUOTE PAGEFULLFN) (FUNCTION NILL)) (LIST (FUNCTION WINDOWPROP) \TopLevelTtyWindow (QUOTE PAGEFULLFN) (WINDOWPROP \TopLevelTtyWindow (QUOTE PAGEFULLFN)))) (FILESLOAD (NOERROR) LoopsSite))(* ;; "Some reasonable defaults, in case they wern't set by the site file")(RPAQ? LoadLoopsForms NIL)(RPAQ? OptionalLispuserFiles NIL)(RPAQ? LOOPSDIRECTORY (LET ((thisFile (FULLNAME (GETSTREAM NIL (QUOTE INPUT))))) (PACKFILENAME (QUOTE HOST) (FILENAMEFIELD thisFile (QUOTE HOST)) (QUOTE DEVICE) (FILENAMEFIELD thisFile (QUOTE DEVICE)) (QUOTE DIRECTORY) (FILENAMEFIELD thisFile (QUOTE DIRECTORY)))))(RPAQ? LOOPSLIBRARYDIRECTORY (LET ((POSSOURCES (OR (STRPOS "SOURCES>" LOOPSDIRECTORY NIL NIL T NIL NIL T) (STRPOS "SYSTEM>" LOOPSDIRECTORY NIL NIL T NIL NIL T)))) (IF POSSOURCES THEN (MKATOM (CONCAT (SUBSTRING LOOPSDIRECTORY 1 (SUB1 POSSOURCES)) "LIBRARY>")) ELSE LOOPSDIRECTORY)))(RPAQ? LOOPSUSERSDIRECTORY (LET ((POSSOURCES (OR (STRPOS "SOURCES>" LOOPSDIRECTORY NIL NIL T NIL NIL T) (STRPOS "SYSTEM>" LOOPSDIRECTORY NIL NIL T NIL NIL T)))) (IF POSSOURCES THEN (MKATOM (CONCAT (SUBSTRING LOOPSDIRECTORY 1 (SUB1 POSSOURCES)) "USERS>")) ELSE LOOPSDIRECTORY)))(RPAQ? LOOPSUSERSRULESDIRECTORY (LET ((POSSOURCES (OR (STRPOS "SOURCES>" LOOPSDIRECTORY NIL NIL T NIL NIL T) (STRPOS "SYSTEM>" LOOPSDIRECTORY NIL NIL T NIL NIL T)))) (IF POSSOURCES THEN (MKATOM (CONCAT (SUBSTRING LOOPSDIRECTORY 1 (SUB1 POSSOURCES)) "USERS>RULES>")) ELSE LOOPSDIRECTORY)))(PUTPROPS LOADLOOPS COPYRIGHT ("Venue & Xerox Corporation" 1983 1984 1985 1986 1987 1988 1990))(DECLARE%: DONTCOPY  (FILEMAP (NIL (3861 8649 (LOADLOOPS 3871 . 7484) (LoadLispUsers 7486 . 7861) (UnMarkChanges 7863 . 8647)) (9465 12510 (PromptEval 9475 . 11014) (PromptRead 11016 . 12508)) (12807 13211 (NiceMenu 12817 . 13209)))))STOP