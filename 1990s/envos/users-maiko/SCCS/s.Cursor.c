h10348s 00018/00009/00193d D 1.14 93/02/08 14:40:31 sybalsky 14 13c Big VM (and new CDR coding) changes for 3.0 \nes 00010/00003/00192d D 1.13 92/05/27 19:11:15 sybalsky 13 12c fixing SCCS headers \nes 00002/00002/00193d D 1.12 92/04/27 18:36:28 nilsson 12 11c Fix of Xdisplay deps.es 00002/00002/00193d D 1.11 92/04/27 10:32:22 nilsson 11 10c fix.es 00024/00022/00171d D 1.10 92/04/27 10:29:12 nilsson 10 9c Removed global display dependencieses 00009/00004/00184d D 1.9 92/04/22 12:35:07 sybalsky 9 8c SGI portes 00001/00001/00187d D 1.8 92/04/21 16:54:57 sybalsky 8 7c shortening file names for DOS \nes 00120/00048/00068d D 1.7 90/11/09 17:18:19 gadener 7 6c Merging of Bob Banes Code /Matsudaes 00050/00118/00066d D 1.6 90/10/23 18:21:27 gadener 6 5c Fixes crash after a week bug in X-versiones 00032/00022/00152d D 1.5 90/09/18 23:26:10 sybalsky 5 4c Retrofit changes from AIX, DEC3100, PS/2es 00000/00008/00174d D 1.4 90/08/30 10:26:37 sybalsky 4 3c Make X cursors 1 bit deepes 00112/00040/00070d D 1.3 90/08/21 17:12:57 sybalsky 3 2c Retrofit AIX changes from IBMes 00000/00000/00110d D 1.2 90/04/20 01:05:58 sybalsky 2 1c AIX:  shortening file names, bulk change.es 00110/00000/00000d D 1.1 90/03/01 15:29:58 osamu 1 0c date and time created 90/03/01 15:29:58 by osamueuUf e 0tTI 1D 3/* %Z% %M% Version %I% (%G%). copyright venue & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%	(venue & Fuji Xerox)";E 3I 3D 5/* @(#) Cursor.c Version 1.2 (4/20/90). copyright venue & Fuji Xerox  */static char *id = "@(#) Cursor.c	1.2 4/20/90	(venue & Fuji Xerox)";E 5I 5D 6/* %Z% %M% Version %I% (%G%). copyright venue & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%	(venue & Fuji Xerox)";E 6I 6D 7/* @(#) Cursor.c Version 1.2 (4/20/90). copyright venue & Fuji Xerox  */static char *id = "@(#) Cursor.c	1.2 4/20/90	(venue & Fuji Xerox)";E 7I 7/* @(#) Cursor.c Version 1.5 (9/18/90). copyright venue & Fuji Xerox  */static char *id = "@(#) Cursor.c	1.5 9/18/90	(venue & Fuji Xerox)";E 7E 6E 5E 3/**** Copyright (C) 1988 by Fuji Xerox co.,Ltd. All rights reserved.**		Author: Mitsunori Matsuda*		Date  : August 12, 1988*I 10D 13*		Removed global dependency on ``dispaly'' /jarl 92-apr-27E 13I 13*		Removed global dependency on ``display'' /jarl 92-apr-27E 13E 10*/I 7I 9E 9/************************************************************************//*									*/D 9/*	Copyright 1989, 1990 Venue, Fuji Xerox Co., Ltd, Xerox Corp.	*/E 9I 9/*	(C) Copyright 1989-92 Venue. All Rights Reserved.		*//*	Manufactured in the United States of America.			*/E 9/*									*/D 9/*	This file is work-product resulting from the Xerox/Venue	*//*	Agreement dated 18-August-1989 for support of Medley.		*/E 9I 9/*	The contents of this file are proprietary information 		*//*	belonging to Venue, and are provided to you under license.	*//*	They may not be further distributed or disclosed to third	*//*	parties without the specific permission of Venue.		*/E 9/*									*//************************************************************************/I 9E 9E 7I 3D 6/************************************************************************//*									*//*	Copyright 1989, 1990 Venue, Fuji Xerox Co., Ltd, Xerox Corp.	*//*									*//*	This file is work-product resulting from the Xerox/Venue	*//*	Agreement dated 18-August-1989 for support of Medley.		*//*									*//************************************************************************/E 6E 3#include <stdio.h>#include <X11/Xlib.h>#include <X11/Xutil.h>#include "lispemul.h"I 7D 8#include "lisptypes.h"E 8I 8#include "lsptypes.h"E 8E 7I 5D 6#include "lisptypes.h"E 6E 5#include "display.h"I 7#include "dbprint.h"E 7I 5D 6#include "dbprint.h"E 6E 5#include "XVersion.h"#include "MyWindow.h"D 10extern Display *Xdisplay;E 10extern MyWindow Lisp_Window;extern XGCValues gcv;extern int Lisp_Xinitialized	 , Video_Inverted	 , Bitmap_Pad	 , Default_Depth;extern unsigned long Black_Pixel	           , White_Pixel;XImage CursorImage;Pixmap CursorPixmap_source     , CursorPixmap_mask;GC cursor_source_gc , cursor_mask_gc;XColor cursor_fore_xcsd     , cursor_back_xcsd     , xced;D 9Colormap Colors;E 9I 9extern Colormap Colors;E 9I 7/************************************************************************//*									*//*			i n i t _ X c u r s o r				*//*									*//*	Initialization code for X-windows cursors.			*//*									*//************************************************************************/E 7I 3D 6/************************************************************************//*									*//*			i n i t _ X c u r s o r				*//*									*//*	Initialization code for X-windows cursors.			*//*									*//************************************************************************/E 6E 3D 10init_Xcursor()E 10I 10init_Xcursor(display)D 11     display *Xdisplay;E 11I 11D 12     display *Display;E 12I 12     Display *display;E 12E 11E 10{D 5#ifdef TRACED 3	printf( "TRACE: init_Xcursor()\n" );E 3I 3    printf( "TRACE: init_Xcursor()\n" );E 3#endifE 5I 5D 6    TPRINT(( "TRACE: init_Xcursor()\n" ));E 6I 6D 7#ifdef TRACE	printf( "TRACE: init_Xcursor()\n" );#endifE 7I 7    TPRINT(( "TRACE: init_Xcursor()\n" ));E 7E 6E 5I 13	XLOCK;	/* Take no X signals during this activity (ISC 386) */E 13D 3	CursorImage.width   = CURSORWIDTH;	CursorImage.height  = CURSORHEIGHT;	CursorImage.xoffset = 0;	CursorImage.format  = XYBitmap;E 3I 3D 6    CursorImage.width   = CURSORWIDTH;    CursorImage.height  = CURSORHEIGHT;    CursorImage.xoffset = 0;    CursorImage.format  = XYBitmap;E 3D 5#ifdef XV11R1E 5I 5#if (defined (XV11R1) || defined(BYTESWAP))E 5D 3	CursorImage.byte_order  = LSBFirst;E 3I 3    CursorImage.byte_order  = LSBFirst;E 3D 5#else XV11R1E 5I 5#else XV11R1 | BYTESWAPE 5D 3	CursorImage.byte_order  = MSBFirst;E 3I 3    CursorImage.byte_order  = MSBFirst;E 3D 5#endif XV11R1E 5I 5#endif XV11R1 | BYTESWAPE 6I 6D 7	CursorImage.width   = CURSORWIDTH;	CursorImage.height  = CURSORHEIGHT;	CursorImage.xoffset = 0;	CursorImage.format  = XYBitmap;#ifdef XV11R1	CursorImage.byte_order  = LSBFirst;#else XV11R1	CursorImage.byte_order  = MSBFirst;#endif XV11R1	CursorImage.bitmap_unit = BITSPER_DLWORD;	CursorImage.bitmap_pad  = Bitmap_Pad;	CursorImage.depth       = 1;	CursorImage.bytes_per_line = BITSPER_DLWORD/8; 	CursorImage.bitmap_bit_order = MSBFirst;E 7I 7    CursorImage.width   = CURSORWIDTH;    CursorImage.height  = CURSORHEIGHT;    CursorImage.xoffset = 0;    CursorImage.format  = XYBitmap;#if (defined (XV11R1) || defined(BYTESWAP))    CursorImage.byte_order  = LSBFirst;D 14#else XV11R1 | BYTESWAPE 14I 14#else /* XV11R1 | BYTESWAP */E 14    CursorImage.byte_order  = MSBFirst;D 14#endif XV11R1 | BYTESWAPE 14I 14#endif /* XV11R1 | BYTESWAP */E 14E 7E 6I 14E 14E 5D 3	CursorImage.bitmap_unit = BITSPER_DLWORD;	CursorImage.bitmap_pad  = Bitmap_Pad;	CursorImage.depth       = 1;	CursorImage.bytes_per_line = BITSPER_DLWORD/8; 	CursorImage.bitmap_bit_order = MSBFirst;	CursorPixmap_source = XCreatePixmap( Xdisplay, Lisp_Window.win				, CURSORWIDTH, CURSORHEIGHT, Default_Depth );	CursorPixmap_mask   = XCreatePixmap( Xdisplay, Lisp_Window.win				, CURSORWIDTH, CURSORHEIGHT, Default_Depth );E 3I 3D 6    CursorImage.bitmap_unit = BITSPER_DLWORD;#ifdef AIXD 5    CursorImage.bitmap_pad  = 16;E 5I 5    CursorImage.bitmap_pad  = 32;E 5#else    CursorImage.bitmap_pad  = Bitmap_Pad;#endif AIX    CursorImage.depth       = 1;    CursorImage.bytes_per_line = BITSPER_DLWORD/8;     CursorImage.bitmap_bit_order = MSBFirst;E 6I 6D 7	gcv.function = Video_Inverted ? GXcopyInverted : GXcopy;        gcv.foreground = Black_Pixel;        gcv.background = White_Pixel;E 7I 7    CursorImage.bitmap_unit = BITSPER_DLWORD;#ifdef AIX    CursorImage.bitmap_pad  = 32;#else    CursorImage.bitmap_pad  = Bitmap_Pad;D 14#endif AIXE 14I 14#endif /* AIX */E 14    CursorImage.depth       = 1;    CursorImage.bytes_per_line = BITSPER_DLWORD/8;     CursorImage.bitmap_bit_order = MSBFirst;E 7E 6I 5E 5D 6    CursorPixmap_source = XCreatePixmap( Xdisplay, Lisp_Window.win				, CURSORWIDTH, CURSORHEIGHT,D 4#ifdef AIXE 4				1);D 4#else				Default_Depth );#endif AIXE 4    CursorPixmap_mask   = XCreatePixmap( Xdisplay, Lisp_Window.win				, CURSORWIDTH, CURSORHEIGHT, D 4#ifdef AIXE 4				1);D 4#else				Default_Depth );#endif AIXE 4E 3D 3	gcv.function = Video_Inverted ? GXcopyInverted : GXcopy;        gcv.foreground = Black_Pixel;        gcv.background = White_Pixel;E 3I 3    gcv.function = Video_Inverted ? GXcopyInverted : GXcopy;    gcv.foreground = Black_Pixel;    gcv.background = White_Pixel;#ifdef AIX    gcv.plane_mask = 1;#endif AIXE 3D 3	cursor_source_gc = XCreateGC( Xdisplay, Lisp_Window.winE 3I 3    cursor_source_gc = XCreateGC( Xdisplay, Lisp_Window.winE 6I 6D 7	cursor_source_gc = XCreateGC( Xdisplay, Lisp_Window.winE 7I 7D 10    CursorPixmap_source = XCreatePixmap( Xdisplay, Lisp_Window.winE 10I 10    CursorPixmap_source = XCreatePixmap( display, Lisp_Window.winE 10				, CURSORWIDTH, CURSORHEIGHT,				1);D 10    CursorPixmap_mask   = XCreatePixmap( Xdisplay, Lisp_Window.winE 10I 10    CursorPixmap_mask   = XCreatePixmap( display, Lisp_Window.winE 10				, CURSORWIDTH, CURSORHEIGHT, 				1);    gcv.function = Video_Inverted ? GXcopyInverted : GXcopy;    gcv.foreground = Black_Pixel;    gcv.background = White_Pixel;#ifdef AIX    gcv.plane_mask = 1;D 14#endif AIXE 14I 14#endif /* AIX */E 14I 14E 14D 10    cursor_source_gc = XCreateGC( Xdisplay, Lisp_Window.winE 10I 10    cursor_source_gc = XCreateGC( display, Lisp_Window.winE 10E 7E 6E 3				, GCForeground|GCBackground|GCFunctionI 7#ifdef AIX					|GCPlaneMaskD 14#endif AIXE 14I 14#endif /* AIX */E 14E 7I 3D 6#ifdef AIX					|GCPlaneMask#endif AIXE 6E 3				, &gcv );D 3	cursor_mask_gc   = XCreateGC( Xdisplay, Lisp_Window.winE 3I 3D 6    cursor_mask_gc   = XCreateGC( Xdisplay, Lisp_Window.winE 6I 6D 7	cursor_mask_gc   = XCreateGC( Xdisplay, Lisp_Window.winE 7I 7D 10    cursor_mask_gc   = XCreateGC( Xdisplay, Lisp_Window.winE 10I 10    cursor_mask_gc   = XCreateGC( display, Lisp_Window.winE 10E 7E 6E 3				, GCForeground|GCBackground|GCFunctionI 7#ifdef AIX					|GCPlaneMaskD 14#endif AIXE 14I 14#endif /* AIX */E 14E 7I 3D 6#ifdef AIX					|GCPlaneMask#endif AIXE 6E 3				, &gcv );D 3	XAllocNamedColor( Xdisplay, Colors, "black" E 3I 3D 6    XAllocNamedColor( Xdisplay, Colors, "black" E 6I 6D 7	XAllocNamedColor( Xdisplay, Colors, "black" E 7I 7D 10    XAllocNamedColor( Xdisplay, Colors, "black" E 10I 10    XAllocNamedColor( display, Colors, "black" E 10E 7E 6E 3			, &cursor_fore_xcsd, &xced );D 3	XAllocNamedColor( Xdisplay, Colors, "white" E 3I 3D 6    XAllocNamedColor( Xdisplay, Colors, "white" E 6I 6D 7	XAllocNamedColor( Xdisplay, Colors, "white" E 7I 7D 10    XAllocNamedColor( Xdisplay, Colors, "white" E 10I 10    XAllocNamedColor( display, Colors, "white" E 10E 7E 6E 3			, &cursor_back_xcsd, &xced );I 13	XUNLOCK;	/* OK to take signals again */E 13D 3} /* end init_Xcursor */E 3I 3D 6  } /* end init_Xcursor */E 6I 6D 7} /* end init_Xcursor */E 7I 7  } /* end init_Xcursor */E 7E 6E 3I 3D 6/************************************************************************//*									*//*			s e t _ X c u r s o r				*//*									*//*									*//*									*//************************************************************************/E 3D 5set_Xcursor( bitmap, hotspot_x, hotspot_y, return_cursor )D 3char *bitmap;int hotspot_x  , hotspot_y;Cursor *return_cursor;{E 3I 3  char *bitmap;E 5I 5set_Xcursor( bitmap, hotspot_x, hotspot_y, return_cursor, from_lisp )  unsigned char *bitmap;E 5  int hotspot_xD 5    , hotspot_y;E 5I 5    , hotspot_y    , from_lisp;E 5  Cursor *return_cursor;  {D 5#ifdef AIX  extern unsigned char reversedbits[];  unsigned char image[32];  int i;  Pixmap Cursor_src, Cursor_msk;         for ( i=0; i<32; i++) image[i] = reversedbits[bitmap[i]];E 5I 5    extern unsigned char reversedbits[];    unsigned char image[32];    int i;    Pixmap Cursor_src, Cursor_msk;#ifdef BYTESWAP       if (from_lisp) for (i=0; i<32; i++) image[i] = reversedbits[bitmap[i^3]];    else for ( i=0; i<32; i++) image[i] = reversedbits[bitmap[i]];#else    for ( i=0; i<32; i++) image[i] = reversedbits[bitmap[i]];#endif BYTESWAPE 5         Cursor_src = XCreatePixmapFromBitmapData(Xdisplay, Lisp_Window.win,						  image, 16, 16, 1, 0, 1),         Cursor_msk = XCreatePixmapFromBitmapData(Xdisplay, Lisp_Window.win,						  image, 16, 16, 1, 0, 1);D 5#elseE 5I 5#ifdef NEVERE 6I 6D 7set_Xcursor( bitmap, hotspot_x, hotspot_y, return_cursor )char *bitmap;int hotspot_x  , hotspot_y;Cursor *return_cursor;{E 7I 7/************************************************************************//*									*//*			s e t _ X c u r s o r				*//*									*//*									*//*									*//************************************************************************/D 10set_Xcursor( bitmap, hotspot_x, hotspot_y, return_cursor, from_lisp )  unsigned char *bitmap;  int hotspot_x    , hotspot_y    , from_lisp;  Cursor *return_cursor;E 10I 10set_Xcursor( display, bitmap, hotspot_x, hotspot_y, return_cursor, from_lisp )D 11     display *Xdisplay;E 11I 11D 12     display *Display;E 12I 12     Display *display;E 12E 11     unsigned char *bitmap;     int hotspot_x       , hotspot_y       , from_lisp;     Cursor *return_cursor;E 10  {    extern unsigned char reversedbits[];    unsigned char image[32];    int i;    Pixmap Cursor_src, Cursor_msk;#ifdef BYTESWAP       if (from_lisp) for (i=0; i<32; i++) image[i] = reversedbits[bitmap[i^3]];    else for ( i=0; i<32; i++) image[i] = reversedbits[bitmap[i]];#else    for ( i=0; i<32; i++) image[i] = reversedbits[bitmap[i]];D 14#endif BYTESWAPE 14I 14#endif /* BYTESWAP */E 14I 14E 14D 10         Cursor_src = XCreatePixmapFromBitmapData(Xdisplay, Lisp_Window.win,E 10I 10D 13         Cursor_src = XCreatePixmapFromBitmapData(display, Lisp_Window.win,E 13I 13	XLOCK;    Cursor_src = XCreatePixmapFromBitmapData(display, Lisp_Window.win,E 13E 10						  image, 16, 16, 1, 0, 1),D 10         Cursor_msk = XCreatePixmapFromBitmapData(Xdisplay, Lisp_Window.win,E 10I 10D 13         Cursor_msk = XCreatePixmapFromBitmapData(display, Lisp_Window.win,E 13I 13    Cursor_msk = XCreatePixmapFromBitmapData(display, Lisp_Window.win,E 13E 10						  image, 16, 16, 1, 0, 1);#ifdef NEVERE 7E 6E 5E 3#ifdef TRACE D 3	printf( "TRACE: set_Xcursor()\n" );E 3I 3D 6    printf( "TRACE: set_Xcursor()\n" );E 6I 6D 7	printf( "TRACE: set_Xcursor()\n" );E 7I 7    printf( "TRACE: set_Xcursor()\n" );E 7E 6E 3#endifD 3	CursorImage.data = (char*) bitmap;	XPutImage( Xdisplay, CursorPixmap_source, cursor_source_gc		, &CursorImage, 0, 0, 0, 0, CURSORWIDTH, CURSORHEIGHT );	XPutImage( Xdisplay, CursorPixmap_mask  , cursor_mask_gc		, &CursorImage, 0, 0, 0, 0, CURSORWIDTH, CURSORHEIGHT );E 3I 3D 6    CursorImage.data = (char*) bitmap;E 6I 6D 7	CursorImage.data = (char*) bitmap;	CursorPixmap_source = XCreatePixmap( Xdisplay, Lisp_Window.win				, CURSORWIDTH, CURSORHEIGHT, Default_Depth );	CursorPixmap_mask   = XCreatePixmap( Xdisplay, Lisp_Window.win				, CURSORWIDTH, CURSORHEIGHT, Default_Depth );	XPutImage( Xdisplay, CursorPixmap_source, cursor_source_gc		, &CursorImage, 0, 0, 0, 0, CURSORWIDTH, CURSORHEIGHT );	XPutImage( Xdisplay, CursorPixmap_mask  , cursor_mask_gc		, &CursorImage, 0, 0, 0, 0, CURSORWIDTH, CURSORHEIGHT );E 7I 7    CursorImage.data = (char*) bitmap;E 7E 6I 5E 5D 6    XPutImage( Xdisplay, CursorPixmap_source, cursor_source_gc	     , &CursorImage, 0, 0, 0, 0, CURSORWIDTH, CURSORHEIGHT );    XPutImage( Xdisplay, CursorPixmap_mask  , cursor_mask_gc	     , &CursorImage, 0, 0, 0, 0, CURSORWIDTH, CURSORHEIGHT );D 5#endif AIXE 5I 5#endif NEVERE 5E 3D 3	*return_cursor = XCreatePixmapCursor( XdisplayE 3I 3    *return_cursor = XCreatePixmapCursor( XdisplayD 5#ifndef AIXE 5I 5#ifdef NEVERE 6I 6D 7	*return_cursor = XCreatePixmapCursor( XdisplayE 7I 7D 10    XPutImage( Xdisplay, CursorPixmap_source, cursor_source_gcE 10I 10    XPutImage( display, CursorPixmap_source, cursor_source_gcE 10	     , &CursorImage, 0, 0, 0, 0, CURSORWIDTH, CURSORHEIGHT );D 10    XPutImage( Xdisplay, CursorPixmap_mask  , cursor_mask_gcE 10I 10    XPutImage( display, CursorPixmap_mask  , cursor_mask_gcE 10	     , &CursorImage, 0, 0, 0, 0, CURSORWIDTH, CURSORHEIGHT );D 14#endif NEVERE 14I 14#endif /* NEVER */E 14I 14E 14D 10    *return_cursor = XCreatePixmapCursor( XdisplayE 10I 10    *return_cursor = XCreatePixmapCursor( displayE 10#ifdef NEVERE 7E 6E 5E 3			, CursorPixmap_source, CursorPixmap_maskI 7#else			, Cursor_src, Cursor_mskD 14#endif NEVERE 14I 14#endif /* NEVER */E 14E 7I 3D 6#else			, Cursor_src, Cursor_mskD 5#endif AIXE 5I 5#endif NEVERE 6E 5E 3			, &cursor_fore_xcsd, &cursor_back_xcsd			, hotspot_x, hotspot_y );D 3	XFlush( Xdisplay );} /* end set_Xcursor */E 3I 3D 6    XFlush( Xdisplay );E 6I 6	/* Should free these now (doc says server may not copy them) */D 7	XFreePixmap(Xdisplay, CursorPixmap_source);	XFreePixmap(Xdisplay, CursorPixmap_mask);E 7I 7D 10	XFreePixmap(Xdisplay, Cursor_src);	XFreePixmap(Xdisplay, Cursor_msk);E 10I 10	XFreePixmap(display, Cursor_src);	XFreePixmap(display, Cursor_msk);E 10E 7E 6D 6  } /* end set_Xcursor */E 6I 6D 7	XFlush( Xdisplay );} /* end set_Xcursor */E 7I 7D 10    XFlush( Xdisplay );E 10I 10    XFlush( display );I 13    XUNLOCK;E 13E 10E 7I 7  } /* end set_Xcursor */E 7E 6E 3E 1