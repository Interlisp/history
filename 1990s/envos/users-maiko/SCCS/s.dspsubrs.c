h18145s 00024/00012/00292d D 2.15 92/11/25 21:03:41 sybalsky 17 16c Fixing endif's with extra text => comment. \nes 00001/00001/00303d D 2.14 92/04/21 17:10:05 sybalsky 16 15c shortening file names for DOS \nes 00003/00001/00301d D 2.13 90/06/13 15:43:53 sybalsky 15 14c AIX compatibility changes.es 00028/00002/00274d D 2.12 90/05/25 11:59:43 osamu 14 13c Chnages for INIT. c cursor operation doesn't references EmCursorX68k, EmCursorY68k, EmCursorBitMap68k c When running for INIT. c I change flip_cursor(), DSP_SetMousePos(), DSP_Cursor()es 00002/00002/00274d D 2.11 90/04/20 01:28:07 sybalsky 13 12c ng file names, bulk change.es 00001/00000/00275d D 2.10 90/03/02 21:43:00 sybalsky 12 11c fixes for 386es 00055/00052/00220d D 2.9 90/03/02 11:13:51 sybalsky 11 10c add comments, reformat, check for 386 changes.es 00036/00000/00236d D 2.8 90/03/01 12:57:19 osamu 10 9c Mitsunori Matsuda adds XWindow functionality.es 00023/00001/00213d D 2.7 89/02/14 13:32:01 snow 9 8c added IFDEF to flipcursor for makeinites 00009/00010/00205d D 2.6 89/01/09 17:18:50 shih 8 7c spellinges 00058/00002/00157d D 2.5 89/01/04 16:56:49 shimizu 7 6c For C-Cursor trackinges 00008/00017/00151d D 2.4 88/09/29 14:22:25 charnley 6 5c removed calls to pr_rop.es 00007/00001/00161d D 2.3 88/07/21 10:45:09 masinter 5 4c Make sure VIDEOCOLOR() returns NIL; comment out (dangerous, not-working) codees 00010/00004/00152d D 2.2 88/06/21 16:03:51 masinter 4 3c allow DSP_cursor to take hotspot argumentses 00000/00000/00156d D 2.1 88/05/17 09:23:29 hayata 3 2c Version up to 2.1es 00002/00002/00154d D 1.2 88/03/13 14:44:46 hayata 2 1c Add SCCS key id (%Z%)es 00156/00000/00000d D 1.1 88/02/24 16:56:23 hayata 1 0c date and time created 88/02/24 16:56:23 by hayataeuUtTI 1D 2/* This is G-file %M% Version %I% (%G%). copyright Xerox & Fuji Xerox  */static char *id = "%M%	%I% %G%";E 2I 2D 8/* This is G-file %Z% %M% Version %I% (%G%). copyright Xerox & Fuji Xerox  */E 8I 8D 15/* %Z% %M% Version %I% (%G%). copyright envos & Fuji Xerox  */E 15I 15/* %Z% %M% Version %I% (%G%). copyright Venue & Fuji Xerox  */E 15E 8static char *id = "%Z% %M%	%I% %G%";E 2/*** ADOPTED NEW VERSION ***/D 11/* *	Copyright (C) 1987 by Fuji Xerox Co., Ltd. All rights reserved. *D 8 *	Auther	:	Osamu Nakamura	E 8I 8 *	Author	:	Osamu NakamuraE 8 */E 11I 11/************************************************************************//*									*//*	Copyright 1989, 1990 Venue, Fuji Xerox Co., Ltd, Xerox Corp.	*//*									*//*	This file is work-product resulting from the Xerox/Venue	*//*	Agreement dated 18-August-1989 for support of Medley.		*//*									*//************************************************************************/E 11#include <stdio.h>I 15#ifndef NOPIXRECTE 15#include <sunwindow/window_hs.h>#include <pixrect/memvar.h>I 15D 17#endif NOPIXRECTE 17I 17#endif /* NOPIXRECT */E 17E 15I 17E 17#include "lispemul.h"I 12D 16#include "lisptypes.h"E 16I 16#include "lsptypes.h"E 16E 12#include "lispmap.h"#include "display.h"I 4#include "arith.h"E 4extern int DebugDSP;extern int DisplayWidth, DisplayHeight;D 6extern struct pixrect *ScreenBitMap;E 6I 10#ifdef XWINDOWextern int Mouse_Included;D 17#endif XWINDOWE 17I 17#endif /* XWINDOW */E 17I 17E 17E 10/**************************************************** * *	DSP_dspbout() entry of SUBRCALL 9 1 *			called from (DSPBOUT X) * ****************************************************/DSP_dspbout( args )LispPTR	*args;		/* args[0] :	charcode	*/D 11{D 8E 8	putc( (args[0] & 0xFFFF) & 0x7f, BCPLDISPLAY );}E 11I 11  {    putc( (args[0] & 0xFFFF) & 0x7f, BCPLDISPLAY );  }E 11/**************************************************** * *	DSP_showdisplay() entry of SUBRCALL 19 2 *			called from (SHOWDISPLAY BASE RASTERWIDTH) * ****************************************************/extern int DisplayInitialized ;DSP_showdisplay( args )LispPTR	*args;{D 11	DisplayInitialized = 1;E 11I 11    DisplayInitialized = 1;E 11}/**************************************************** * *	DSP_VideoColor() entry of SUBRCALL 66 1 *			called from (VIDEOCLOR BLACKFLG) * ****************************************************/DSP_VideoColor( args )LispPTR	*args;		/* args[0] :	black flag	*/{I 10D 11	int invert;E 11I 11    int invert;E 11#ifdef SUNDISPLAYE 10D 5	if( args[0] & 0xFFFF )E 5I 5D 11	return NIL;E 11I 11    return NIL;E 11I 10D 17#endif SUNDISPLAYE 17I 17#endif /* SUNDISPLAY */E 17E 10I 17E 17I 10#ifdef XWINDOWD 11	invert = args[0] & 0xFFFF;	lisp_Xvideocolor( invert );	if( invert )E 11I 11    invert = args[0] & 0xFFFF;    lisp_Xvideocolor( invert );    if( invert )E 11		return ATOM_T;D 11	elseE 11I 11    elseE 11		return NIL;D 17#endif XWINDOWE 17I 17#endif /* XWINDOW */E 17E 10D 6/* this doesn't work; I don't know what it was supposed to do (LMM)if( args[0] & 0xFFFF )E 5		(mpr_d(ScreenBitMap))->md_flags |= MP_REVERSEVIDEO;	else		(mpr_d(ScreenBitMap))->md_flags &= ~MP_REVERSEVIDEO;		pr_rop(ScreenBitMap, 0, 0, DisplayWidth, DisplayHeight, PIX_SRC,	       ScreenBitMap, 0, 0);I 5*/E 6E 5}D 8extern struct cursor CurrentCursor;	E 8I 8extern struct cursor CurrentCursor;E 8extern int LispWindowFd;extern int errno;/**************************************************** * *	DSP_Cursor() entry of SUBRCALL 64 2 *			called from \HARDCURSORUP etc. * ****************************************************/D 4DSP_Cursor( args )LispPTR *args;		/* args[0] :	hot sopt XE 4I 4DSP_Cursor( args , argnum)LispPTR *args;	int argnum;			/* args[0] :	hot sopt XE 4			 * args[1] :	hot spot Y			 */{I 7D 11	extern int ScreenLocked;	extern DLword *EmCursorX68K,*EmCursorY68K;	extern int LastCursorX,LastCursorY;	static int Init=T;E 11I 11    extern int ScreenLocked;    extern DLword *EmCursorX68K,*EmCursorY68K;    extern int LastCursorX,LastCursorY;    static int Init=T;E 11I 10#ifdef SUNDISPLAYE 10E 7I 4D 8 	if (argnum == 2) {E 8I 8D 11	if (argnum == 2) {E 11I 11    if (argnum == 2) {E 11E 8	CurrentCursor.cur_xhot=args[0] & 0xffff;	CurrentCursor.cur_yhot=args[1] & 0xffff;	};E 4I 7#ifdef OLD_CURSORE 7D 11	win_setcursor( LispWindowFd, &CurrentCursor );E 11I 11    win_setcursor( LispWindowFd, &CurrentCursor );E 11I 7#elseI 14#ifndef INITE 14D 11	ScreenLocked =T;	if(!Init){E 11I 11    ScreenLocked =T;    if(!Init){E 11	  taking_mouse_down();	  taking_mouse_up(*EmCursorX68K,*EmCursorY68K);	}D 8	else{ E 8I 8D 11	else{E 11I 11    else{E 11E 8	  Init=NIL;	  cursor_hidden_bitmap(0,0);	  taking_mouse_up(0,0);	  *EmCursorX68K=LastCursorX=0;	  *EmCursorY68K=LastCursorY=0;	}/****D 11	  taking_mouse_down();	  taking_mouse_up(*EmCursorX68K,*EmCursorY68K);E 11I 11      taking_mouse_down();      taking_mouse_up(*EmCursorX68K,*EmCursorY68K);E 11***/D 11	ScreenLocked=NIL;E 11I 11    ScreenLocked=NIL;E 11D 14E 14I 14#else/* Init specific lde only */    ScreenLocked =T;    if(!Init){	  taking_mouse_down();	  taking_mouse_up(0,0);	}    else{	  Init=NIL;	  cursor_hidden_bitmap(0,0);	  taking_mouse_up(0,0);	}/****      taking_mouse_down();      taking_mouse_up(0,0);***/    ScreenLocked=NIL;D 17#endif INITE 17I 17#endif /* INIT */E 17E 14#endifI 10D 17#endif SUNDISPLAYE 17I 17#endif /* SUNDISPLAY */E 17E 10D 8	E 8I 8I 17E 17I 10#ifdef XWINDOWD 11	Set_DisplayCursor( (int)(args[0]&0xFFFF), (int)(args[1]&0xFFFF) );E 11I 11D 13    Set_DisplayCursor( (int)(args[0]&0xFFFF), (int)(args[1]&0xFFFF) );E 13I 13    Set_XCursor( (int)(args[0]&0xFFFF), (int)(args[1]&0xFFFF) );E 13E 11D 17#endif XWINDOWE 17I 17#endif /* XWINDOW */E 17I 17E 17E 10E 8E 7}/**************************************************** * *	DSP_SetMousePos() entry of SUBRCALL 65 2 *			called from macro \SETMOUSEXY etc. * ****************************************************/DSP_SetMousePos( args )D 7LispPTR *args;		/* args[0] :	X posE 7I 7register LispPTR *args;	/* args[0] :	X posE 7			 * args[1] :	Y pos			 */{I 10#ifdef SUNDISPLAYE 10D 7E 7I 7#ifdef OLD_CURSORD 11	register int x ,y;	x=GetSmalldata(args[0]);	y=GetSmalldata(args[1]); /* debug */E 7D 4	win_setmouseposition(LispWindowFd, (args[0] & 0xFFFF) % DisplayWidth,			                   (args[1] & 0xFFFF) % DisplayHeight );E 4I 4	win_setmouseposition(LispWindowFd, GetSmalldata(args[0]),E 11I 11    register int x ,y;    x=GetSmalldata(args[0]);    y=GetSmalldata(args[1]); /* debug */    win_setmouseposition(LispWindowFd, GetSmalldata(args[0]),E 11			                   GetSmalldata(args[1]));I 7#elseD 11	extern int ScreenLocked;	extern DLword *EmCursorX68K,*EmCursorY68K,*EmMouseX68K,*EmMouseY68K;	register int x ,y;	ScreenLocked=T;	x=GetSmalldata(args[0]);	y=GetSmalldata(args[1]);	/* for Suntool's invisible cursor */	win_setmouseposition(LispWindowFd, x,y);	/* for REAL cursor image */	taking_mouse_down();	taking_mouse_up(x,y);E 11I 11    extern int ScreenLocked;    extern DLword *EmCursorX68K,*EmCursorY68K,*EmMouseX68K,*EmMouseY68K;    register int x ,y;    ScreenLocked=T;    x=GetSmalldata(args[0]);    y=GetSmalldata(args[1]);    /* for Suntool's invisible cursor */    win_setmouseposition(LispWindowFd, x,y);    /* for REAL cursor image */    taking_mouse_down();    taking_mouse_up(x,y);E 11I 14#ifndef INITE 14D 11	*EmMouseX68K=x;	*EmMouseY68K=y;/***	*EmCursorX68K= x;D 8	*EmCursorY68K= y; ************/ E 8I 8	*EmCursorY68K= y; ************/E 8	ScreenLocked=NIL;E 11I 11    *EmMouseX68K=x;    *EmMouseY68K=y;I 14#endifE 14    ScreenLocked=NIL;E 11D 8#endif E 8I 8#endifI 10D 17#endif SUNDISPLAYE 17I 17#endif /* SUNDISPLAY */E 17I 17E 17#ifdef XWINDOWD 11	if( Mouse_Included )E 11I 11    if( Mouse_Included )E 11		set_Xmouseposition( (int)(GetSmalldata(args[0]))				  , (int)(GetSmalldata(args[1])) );D 17#endif XWINDOWE 17I 17#endif /* XWINDOW */E 17E 10E 8E 7E 4}/**************************************************** * *	DSP_ScreenWidth() entry of SUBRCALL 67 0 *			called from  \Katana.DisplayWidth. * ****************************************************/DSP_ScreenWidth( args )LispPTR *args;{	return( S_POSITIVE | (0xFFFF & DisplayWidth) );}/**************************************************** * *	DSP_ScreenHight() entry of SUBRCALL 68 0 *			called from  \Katana.DisplayHeight. * ****************************************************/DSP_ScreenHight( args )LispPTR *args;{	return( S_POSITIVE | (0xFFFF & DisplayHeight) );}/**************************************************** *D 8 *	flip_cursor() E 8I 8 *	flip_cursor()E 8 * ****************************************************/D 6extern struct pixrect *CursorBitMap;E 6I 6extern DLword *EmCursorBitMap68K;I 9extern int for_makeinit;E 9E 6flip_cursor(){D 6	pr_rop( CursorBitMap, 0, 0, CURSORWIDTH, CURSORHEIGHT, 		PIX_NOT(PIX_SRC), CursorBitMap, 0, 0 );	E 6I 6register DLword *word;register int cnt;	word = EmCursorBitMap68K;I 9#ifdef INIT	/* since this is called frequently, and you don't want to have	   to build a different LDE to run the 2 parts of a Loadup, there is 	   an ifdef AND a test.  This way we don't generate	   extra code for anybody elses building an LDE	   except those who want to try building loadups.  */	if (!for_makeinit){		for (cnt = CURSORHEIGHT;(cnt--);)		   {D 11			*(word++) ^= 0xFFFF;E 11I 11			GETWORD(word++) ^= 0xFFFF;E 11	 	   };	};#elseE 9	for (cnt = CURSORHEIGHT;(cnt--);)	  {D 11	    *(word++) ^= 0xFFFF;E 11I 11	    GETWORD(word++) ^= 0xFFFF;E 11D 9	  }E 9I 9	  };#endifI 10#ifdef SUNDISPLAYE 10E 9I 7#ifdef OLD_CURSORE 7E 6	win_setcursor( LispWindowFd, &CurrentCursor );I 7#else	ScreenLocked=T;	taking_mouse_down();I 14#ifndef INITE 14	taking_mouse_up(*EmCursorX68K,*EmCursorY68K);I 14#else	if(!for_makeinit)	  taking_mouse_up(*EmCursorX68K,*EmCursorY68K);	else	  taking_mouse_up(0,0);D 17#endif INITE 17I 17#endif /* INIT */E 17E 14	ScreenLocked=NIL;#endifI 10D 17#endif SUNDISPLAYE 17I 17#endif /* SUNDISPLAY */E 17I 17E 17#ifdef XWINDOWD 13	Set_DisplayCursor( 0, 0 );E 13I 13	Set_XCursor( 0, 0 );E 13D 17#endif XWINDOWE 17I 17#endif /* XWINDOW */E 17E 10E 7}D 14E 14E 1