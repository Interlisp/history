/* This is G-file @(#) initdisplay.c Version 2.6 (8/9/88). copyright Xerox & Fuji Xerox  */static char *id = "@(#) initdisplay.c	2.6 8/9/88";/* *	Copyright (C) 1987 by Fuji Xerox Co., Ltd. All rights reserved. *	file	:	initdisplay.c *	Author	:	Osamu Nakamura	 */#include <stdio.h>#include <sunwindow/window_hs.h>#include <sunwindow/cms.h>#include <sys/ioctl.h>#include <sys/mman.h>#include <sunwindow/win_ioctl.h>#include <pixrect/pixrect_hs.h>#include <sun/fbio.h>#include <sys/ioctl.h>#include <sys/file.h>#include "lispemul.h"#include "lispmap.h"#include "address.h"#include "address68k.h"#include "lispglobal.h"#include "emulglobal.h"#include "display.h"struct screen LispScreen;struct pixrect *ScreenBitMap, *CursorBitMap, *InvisibleCursorBitMap;struct pixrect *SrcPixRect, *DestPixRect, *TexturePixRect;struct pixrect *BlackTexturePixRect, *WhiteTexturePixRect;int LispWindowFd;int FrameBufferFd;int DisplayWidth, DisplayHeight, DisplayRasterWidth; short *DisplayRegion68k;	/* 68k addr of #{}22,0 */struct cursor CurrentCursor, InvisibleCursor;struct winlock DisplayLockArea;extern DLword *EmCursorBitMap68K;extern int errno;int DebugDSP = T;init_display(lisp_display_addr, display_max)	int lisp_display_addr, display_max;{	int mmapstat, size;	char *texture_base, *malloc();	struct fbtype my_screen;	if( (LispWindowFd = win_screennew( &LispScreen )) == -1){		fprintf( stderr, "init_display: can't create LispWindow\n");		exit( -1 );	}	else {#ifdef KBINT		int_io_open(LispWindowFd);#endif		fcntl(LispWindowFd, F_SETFL, fcntl(LispWindowFd, F_GETFL, 0)| FNDELAY);	}		DisplayRegion68k = (short *) Addr68k_from_LADDR( lisp_display_addr );	if( (FrameBufferFd = open( LispScreen.scr_fbname, 2 )) == -1){		fprintf( stderr, "init_display: can't open FrameBuffer\n");		exit( -1 );	}	/* initialize Display parameters */        if (ioctl(FrameBufferFd, FBIOGTYPE , &my_screen)== -1) {        fprintf( stderr, "init_display: can't find screen parameters\n");                exit( -1 );        }        DisplayWidth = my_screen.fb_width;        DisplayHeight = my_screen.fb_height;        DisplayRasterWidth = DisplayWidth / BITSPER_DLWORD;	if ((DisplayWidth * DisplayHeight) > display_max){		DisplayHeight = display_max / DisplayWidth;	}#ifdef  DEBUG	printf("Display = %d x %d\n",DisplayWidth,DisplayHeight);#endif	if (my_screen.fb_depth > 1 ) {#ifdef  DEBUG	   printf("color screen(!), depth: %d", my_screen.fb_depth );#endif	/*	fprintf( stderr, "init_display: color display not supported\n");		exit( -1 ); */	}	DisplayLockArea.wl_rect.r_width = DisplayWidth;	DisplayLockArea.wl_rect.r_height = DisplayHeight;		init_cursor(); 	size = ((DisplayWidth * DisplayHeight / 8 + (getpagesize()-1) ) 			& -getpagesize());#ifdef  DEBUG	printf("Display Addr: 0x%x\n",DisplayRegion68k);	printf("length: 0x%x\n",size);	printf("page size: 0x%x\n",getpagesize());#endif	mmapstat = 		mmap( DisplayRegion68k,		      size,		      PROT_READ | PROT_WRITE, MAP_SHARED, FrameBufferFd, 0 );	#ifdef  DEBUG	printf("after mmap: 0x%x\n",mmapstat);#endif	if(mmapstat != 0){		fprintf( stderr, "init_display: ERROR at mmap system call\n");		fprintf( stderr, "errno = %d\n\n", errno );		exit( 0 );	}	ScreenBitMap = mem_point( DisplayWidth, DisplayHeight, 1,				  DisplayRegion68k );	#ifdef  DEBUG	printf("after mem_point, ScreenBitMap =  0x%x\n",ScreenBitMap);#endif	/* clear display */	pr_rop( ScreenBitMap, 0, 0, DisplayWidth, DisplayHeight, PIX_CLR,		ScreenBitMap, 0, 0);#ifdef  DEBUG	printf("after PIX_CLR\n");#endif	/* initialize pixrect using in pilotbitblt */	SrcPixRect = mem_point( 0, 0, 1, NULL );	DestPixRect = mem_point( 0, 0, 1, NULL );	TexturePixRect = mem_create( 16, 32, 1 );	BlackTexturePixRect = mem_create( 16, 16, 1);	pr_rop( BlackTexturePixRect, 0, 0, 16, 16, PIX_SET,		BlackTexturePixRect, 0, 0);	WhiteTexturePixRect = mem_create( 16, 16, 1);	pr_rop( WhiteTexturePixRect, 0, 0, 16, 16, PIX_CLR,		WhiteTexturePixRect, 0, 0);#ifdef  DEBUG	printf("before set_cursor\n");#endif}init_cursor(){	CursorBitMap = mem_create( CURSORWIDTH, CURSORHEIGHT, 1 );	mpr_mdlinebytes(CursorBitMap) = CURSORWIDTH >> 3;/* 2(byte) */	CurrentCursor.cur_xhot = 0;	CurrentCursor.cur_yhot = 0;	CurrentCursor.cur_shape = CursorBitMap;	CurrentCursor.cur_function = PIX_SRC | PIX_DST;		/*  Invisible Cursor */	InvisibleCursorBitMap = mem_create( 0, 0, 1 );	InvisibleCursor.cur_xhot = 0;	InvisibleCursor.cur_yhot = 0;	InvisibleCursor.cur_shape = InvisibleCursorBitMap;	InvisibleCursor.cur_function = /*PIX_SRC |*/ PIX_DST;	pr_rop( InvisibleCursorBitMap, 0, 0, CURSORWIDTH, CURSORHEIGHT, PIX_CLR,		InvisibleCursorBitMap, 0, 0);	win_setcursor( LispWindowFd, &InvisibleCursor);	win_setmouseposition(LispWindowFd, 0, 0);}set_cursor(){	(mpr_d(CursorBitMap))->md_image = 			(short *)(IOPage->dlcursorbitmap);				/* BitmapBase of CurrentCursor				 * is set to IOPage->dlcursorbitmap				 */	if(win_setcursor( LispWindowFd, &CurrentCursor )== -1)		perror("SET Cursor");	if(win_setmouseposition(LispWindowFd, 0, 0)==-1)		perror("SET Mouse POS");#ifdef  DEBUG	printf("After Set cursor\n");#endif}display_before_exit(){	/* clear display */	pr_rop( ScreenBitMap, 0, 0, DisplayWidth, DisplayHeight, PIX_CLR,		ScreenBitMap, 0, 0);	 	pr_close( ScreenBitMap );  /*      win_remove( LispWindowFd ); */        win_screendestroy( LispWindowFd );#ifdef KBINT		int_io_close(LispWindowFd);#endif        close( LispWindowFd ); }