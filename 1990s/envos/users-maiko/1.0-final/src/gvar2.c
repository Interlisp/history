/* This is G-file @(#) gvar2.c Version 2.2 (5/25/88). copyright Xerox & Fuji Xerox  */static char *id = "@(#) gvar2.c	2.2 5/25/88";/* *	Copyright (C) 1987 by Fuji Xerox Co., Ltd. All rights reserved. * *	Auther	:	Hiroshi Hayata	 */#include <stdio.h>#include "lispemul.h"#include "lispglobal.h"#include "address68k.h"#include "gc.h"#include "emulglobal.h"struct xpointer{	unsigned	flags:8;	unsigned	addr:24;};/************************************************************ N_OP_gvar_	entry		GVAR_		OPCODE[027]	1.	atom_index: offset of argued slot from Valspace.	2.	address of GVAR slot is Valspace+offset.	3.	call gclookup with DELREF and address of GVAR slot.	4.	call gclookup with ADDREF and TopOFStack.	5.	replace GVAR slot with tos.	6.	If Hash Table is overflow, call fn1ext.***********************************************************/ LispPTR N_OP_gvar_(tos, atom_index)	register LispPTR tos;	unsigned int atom_index;{register LispPTR *pslot;	/* pointer to argued GVAR slot */register LispPTR old;		/* old contents of argued GVAR slot */#ifdef	TRACE	printPC();	printf("TRACE: N_OP_gvar_()\n");#endif	pslot = (LispPTR *) Valspace + atom_index;	old = 0xFFFFFF & *pslot;	GCLOOKUP(0x8000, DELREF, old); 	GCLOOKUP(0x8000, ADDREF, 0xFFFFFF & tos );	((struct xpointer*)pslot)->addr = tos;	return(tos);}/************************************************************ N_OP_rplptr	entry		RPLPTR		OPCODE[024]	1.	alpha : offset of argued slot from tos_m_1.	2.	address of slot is tos_m_1+offset.	3.	call gclookup with DELREF and address of slot.	4.	call gclookup with ADDREF and tos.	5.	replace slot with tos.***********************************************************/ LispPTR N_OP_rplptr(tos_m_1, tos, alpha)	register LispPTR tos, tos_m_1;	unsigned int alpha;{register DLword	*pslot;		/* pointer to argued slot (68 address) */register LispPTR old;		/* old contents of argued slot */#ifdef	TRACE	printPC();	printf("TRACE: N_OP_rplptr()\n");#endif	pslot = Addr68k_from_LADDR( (0xFFFFFF & tos_m_1) + alpha );	old = 0xFFFFFF & (*((LispPTR *)pslot));	GCLOOKUP(0x8000,DELREF, old);	GCLOOKUP(0x8000,ADDREF, old = 0xFFFFFF & tos );	((struct xpointer*)pslot)->addr = tos;	return(tos_m_1);}