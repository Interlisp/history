/* This is G-file @(#) rs232c.c Version 2.2 (6/24/88). copyright Xerox & Fuji Xerox  */static char *id = "@(#) rs232c.c	2.2 6/24/88";/*** ADOPTED NEW VERSION ***//** RS232C driver of Xerox Lisp on SUN.** Copyright (C) 1987 by Fuji Xerox Co.,Ltd.. All rights reserved.***/#include "rs232c.h"DLRS232C_HDW_CONF 	 	*HardWareConfig;DLRS232C_IOP_GET_FLAG 	 	*RS232CGetFlag;DLRS232C_IOP_PUT_FLAG 	 	*RS232CPutFlag;DLRS232C_IOP_MISC_CMD    	*RS232CMiscCommand;DLRS232C_PARAMETER_OUTCOME 	*RS232CParameterOutcome;DLword	*RS232CGetCSB      ,	*RS232CPutCSB      ,	*RS232CParameterCSB;extern int LispReadFds;int	RS232C_Fd;char 	*RS232C_Dev;char 	*RS232C_WrBufAddr   , 	*RS232C_RdBufAddr;short 	RS232C_WrMaxCount    , 	RS232C_WrCount    , 	RS232C_WrStat    , 	RS232C_RdMaxCount    , 	RS232C_RdCount    , 	RS232C_RdStat;struct sgttyb RS232C_Mode;DLRS232C_IOCB *RS232C_WrIOCB            , *RS232C_RdIOCB;rs232c_init(){#ifdef TRACE	printf( "TRACE: rs232c_init()\n" );#endif	RS232C_Dev = "/dev/ttyb"; /*Modify for target system */	RS232C_Fd  = (-1);	/* Pointer to IOPAGE */	RS232CMiscCommand      = (DLRS232C_IOP_MISC_CMD*)      Addr68k_from_LADDR(IOPAGE_OFFSET+24);	RS232CPutFlag          = (DLRS232C_IOP_PUT_FLAG*)      Addr68k_from_LADDR(IOPAGE_OFFSET+25);	RS232CGetFlag          = (DLRS232C_IOP_GET_FLAG*)      Addr68k_from_LADDR(IOPAGE_OFFSET+26);	RS232CPutCSB           = (DLword*)                     Addr68k_from_LADDR(IOPAGE_OFFSET+49);	RS232CGetCSB           = (DLword*)                     Addr68k_from_LADDR(IOPAGE_OFFSET+51);	RS232CParameterOutcome = (DLRS232C_PARAMETER_OUTCOME*) Addr68k_from_LADDR(IOPAGE_OFFSET+54);	HardWareConfig         = (DLRS232C_HDW_CONF*)          Addr68k_from_LADDR(IOPAGE_OFFSET+100);	RS232CParameterCSB     = (DLword*)                     Addr68k_from_LADDR(IOPAGE_OFFSET+112);	HardWareConfig->rs232c_absent = 0; /* Oprion Board Exist */	RS232C_WrStat = INACTIVE;	RS232C_RdStat = INACTIVE;	RS232C_WrIOCB = NULL;	RS232C_RdIOCB = NULL;	RS232C_WrBufAddr = NULL;	RS232C_RdBufAddr = NULL;} /* rs232c_init end */rs232c_open(){	int stat;#ifdef TRACE	printf("TRACE: rs232c_open()\n");#endif	if ( RS232C_Fd < 0) {		if (( RS232C_Fd = open( RS232C_Dev,O_RDWR )) >= 0) {			stat = ioctl( RS232C_Fd, TIOCGETP, &RS232C_Mode );			RS232C_Mode.sg_flags = RAW;			stat = ioctl( RS232C_Fd, TIOCSETP, &RS232C_Mode );			RS232C_WrStat = INACTIVE;			RS232C_RdStat = INACTIVE;			LispReadFds |= ( 1 << RS232C_Fd );#ifdef RS232INT			int_io_open(RS232C_Fd);#endif		} else {			RS232C_Fd = (-1);			error( "RS232C: rs232c_open" );		}	}} /* rs232c_open end */	rs232c_close(){#ifdef TRACE	printf( "TRACE: rs232c_close()\n" );#endif	if ( RS232C_Fd >= 0 ) {		rs232c_abortinput();		rs232c_readcomp();		rs232c_abortoutput();		rs232c_writecomp();		LispReadFds &= ~( 1 << RS232C_Fd );#ifdef RS232INT		int_io_close(RS232C_Fd);#endif		close( RS232C_Fd );		RS232C_Fd = (-1);	}} /* rs232c_close end */RS232C_readinit(){#ifdef TRACE	printf( "TRACE: rs232c_readinit()\n" );#endif	if ( RS232CGetFlag->busy && ( RS232C_Fd >= 0 ) 				 && ( RS232C_RdStat == INACTIVE ) ) {		RS232C_RdIOCB     = (DLRS232C_IOCB*) Addr68k_from_LADDR(((*(RS232CGetCSB+1) & 0xff)<<16) + *RS232CGetCSB );		RS232C_RdBufAddr  = (char*)          Addr68k_from_LADDR(((RS232C_RdIOCB->block_pointer_hi & 0xff)<<16) + RS232C_RdIOCB->block_pointer_lo );		RS232C_RdMaxCount = RS232C_RdIOCB->byte_count;		RS232C_RdCount    = 0;		if ( !RS232C_RdIOCB->put ) {			RS232C_RdStat = ACTIVE;		} else {			RS232C_RdStat = TERMINATED;		}	}} /* RS232C_readinit end */RS232C_writeinit(){#ifdef TRACE	printf( "TRACE: rs232c_writeinit()\n" );#endif	if ( RS232CPutFlag->busy && ( RS232C_Fd >= 0 ) 				 && ( RS232C_WrStat == INACTIVE ) ) {		RS232C_WrIOCB     = (DLRS232C_IOCB*) Addr68k_from_LADDR(((*(RS232CPutCSB+1) & 0xff)<<16) + *RS232CPutCSB  );		RS232C_WrBufAddr  = (char*)          Addr68k_from_LADDR(((RS232C_WrIOCB->block_pointer_hi & 0xff)<<16) + RS232C_WrIOCB->block_pointer_lo );		RS232C_WrMaxCount = RS232C_WrIOCB->byte_count;		RS232C_WrCount    = 0;		if ( RS232C_WrIOCB->put ) {			RS232C_WrStat = ACTIVE;		} else {			RS232C_WrStat = TERMINATED;		}	}} /* RS232C_writeinit end */RS232C_readcont(){	short    size		,count;	char    *bufaddr;#ifdef TRACE	printf( "TRACE: rs232c_readcont()\n" );#endif	if  ( RS232C_RdStat == ACTIVE ) {		bufaddr = RS232C_RdBufAddr + RS232C_RdCount;		size    = RS232C_RdMaxCount - RS232C_RdCount;		if ((count = read( RS232C_Fd, bufaddr, size)) > 0) {			RS232C_RdCount += count;			RS232C_RdStat = TERMINATED;		}		rs232c_readcomp();	}} /* RS232C_readcont end */RS232C_writecont(){	short    size	        ,count;	char    *bufaddr;#ifdef TRACE	printf( "TRACE: rs232c_writecont()\n" );#endif	if  ( RS232C_WrStat == ACTIVE ) {		bufaddr = RS232C_WrBufAddr + RS232C_WrCount;		size    = RS232C_WrMaxCount - RS232C_WrCount;		if (size > 64)  size = 64;		if (( count = write( RS232C_Fd, bufaddr, size )) > 0) {			RS232C_WrCount += count;			if ( RS232C_WrCount == RS232C_WrMaxCount ) {				RS232C_WrStat = TERMINATED;			}		}		rs232c_writecomp();	}} /* RS232C_writecont end */RS232C_cmd(){	short command;#ifdef TRACE	printf("TRACE: rs232c_cmd()\n");#endif	if ( RS232CMiscCommand->busy ) {		RS232CParameterOutcome->success = 0; /* success flag off */		if      ( RS232CMiscCommand->command == ON )                   rs232c_open();		else if ( RS232CMiscCommand->command == OFF )                  rs232c_close();		else if ( RS232CMiscCommand->command == BREAK_ON )             rs232c_breakon();		else if ( RS232CMiscCommand->command == BREAK_OFF )            rs232c_breakoff();		else if ( RS232CMiscCommand->command == ABORT_INPUT )          rs232c_abortinput();		else if ( RS232CMiscCommand->command == ABORT_OUTPUT )         rs232c_abortoutput();		else if ( RS232CMiscCommand->command == GET_STATUS )           rs232c_getstatus();		else if ( RS232CMiscCommand->command == MAJOR_SET_PARAMETERS ) rs232c_majorparam();		else if ( RS232CMiscCommand->command == MINOR_SET_PARAMETERS ) rs232c_minorparam();		else			error( "RS232C : rs232c_cmd" );	}	/* success flag */	RS232CParameterOutcome->success = 1;		RS232CMiscCommand->busy = 0;} /* RS232C_cmd end */rs232c_breakon(){	int stat;#ifdef TRACE	printf( "TRACE: rs232c_breakon()\n" );#endif	if (RS232C_Fd >= 0) {		stat = ioctl( RS232C_Fd, TIOCSBRK, 0 );	}} /* rs232c_breakon end */rs232c_breakoff(){	int stat;#ifdef TRACE	printf( "TRACE: rs232c_breakoff()\n" );#endif	if ( RS232C_Fd >= 0 ) {		stat = ioctl( RS232C_Fd, TIOCCBRK, 0 );	}} /* rs232c breakoff end */rs232c_abortinput(){#ifdef TRACE	printf( "TRACE: rs232c_abortinput()\n" );#endif	if ( RS232C_RdStat == ACTIVE ) {		RS232C_RdStat = TERMINATED;		}} /* rs232c_abortinput end */rs232c_abortoutput(){#ifdef TRACE	printf( "TRACE: rs232c_abortoutput()\n" );#endif	if ( RS232C_WrStat == ACTIVE ) {		RS232C_WrStat = TERMINATED;		}} /* rs232c_abortoutput end */rs232c_getstatus(){#ifdef TRACE	printf( "TRACE: rs232c_getstatus()\n" );#endif} /* rs232c_getstatus end */rs232c_majorparam(){	DLRS232C_PARAMETER_CSB *param;	char baudrate;	int stat;#ifdef TRACE	printf( "TRACE: rs232c_majorparam()\n" );#endif	if ( RS232C_Fd >= 0 ) {		param = (DLRS232C_PARAMETER_CSB*) RS232CParameterCSB;				/* Baudrate */		if (( baudrate = rs232c_baudtosymbol( (int) param->line_speed )) != -1 ) {			RS232C_Mode.sg_ispeed = baudrate;			RS232C_Mode.sg_ospeed = baudrate;		} else {			error( "RS232C : rs232c_majorparam" );		}		/* Xon/Xoff Control */		if ( param->flowcontrol_on ) {			RS232C_Mode.sg_flags |= TANDEM;		} else {			RS232C_Mode.sg_flags &=~TANDEM;		}		stat = ioctl(RS232C_Fd,TIOCSETP,&RS232C_Mode);			}} /* rs232c_majorparm end */ rs232c_baudtosymbol( aBaud )        short aBaud;{#ifdef TRACE        printf( "TRACE: rs232c_baudtosymbol(%#x)\n", aBaud );#endif        if( aBaud ==  0 ) return( B50 );        if( aBaud ==  1 ) return( B75 );        if( aBaud ==  2 ) return( B110 );        if( aBaud ==  3 ) return( B134 );        if( aBaud ==  4 ) return( B150 );        if( aBaud ==  5 ) return( B300 );        if( aBaud ==  6 ) return( B600 );        if( aBaud ==  7 ) return( B1200 );        if( aBaud ==  8 ) return( B2400 );        if( aBaud == 10 ) return( B4800 );        if( aBaud == 12 ) return( B9600 );        if( aBaud == 13 ) return( EXTA );        return( -1 );} /* rs232c_baudtosymbol end */rs232c_minorparam(){        DLRS232C_PARAMETER_CSB *param;	int stat;        #ifdef TRACE        printf( "TRACE: rs232c_minoreparam()\n" );#endif	if ( RS232C_Fd >= 0 ) {		param = (DLRS232C_PARAMETER_CSB*) RS232CParameterCSB;		/* DTR */		if ( param->data_terminal_ready ) {			stat = ioctl( RS232C_Fd, TIOCSDTR, 0 );		} else {			stat = ioctl( RS232C_Fd, TIOCCDTR, 0 );		}	}} /* rs232c_minorparam end */rs232c_readcomp(){	DLRS232C_IOCB_TRANSFER_STATUS *temp;#ifdef TRACE        printf( "TRACE: rs232c_readcomp()\n" );#endif	if ( RS232C_RdStat == TERMINATED ) {		temp = (DLRS232C_IOCB_TRANSFER_STATUS*) (&(RS232C_RdIOCB->transfer_status));		temp->success = 1;		RS232C_RdIOCB->returned_byte_count = RS232C_RdCount;		RS232C_RdIOCB->completed           = 1;		RS232C_RdStat                      = INACTIVE;		RS232CGetFlag->busy                = 0;	}} /* rs232c_readcomp end */rs232c_writecomp(){	DLRS232C_IOCB_TRANSFER_STATUS *temp;#ifdef TRACE	printf( "TRACE: rs232c_writecomp()\n" );#endif	if ( RS232C_WrStat == TERMINATED ) {		temp = (DLRS232C_IOCB_TRANSFER_STATUS*) (&(RS232C_WrIOCB->transfer_status));		temp->success = 1;		RS232C_WrIOCB->returned_byte_count = RS232C_WrCount;		RS232C_WrIOCB->completed           = 1;		RS232C_WrStat                      = INACTIVE;		RS232CPutFlag->busy                = 0;	}} /* rs232c_writecomp end */rs232c_debug( name, sw )        char *name;	int  sw;{        struct sgttyb mode;	if ( sw == 1 ) {        printf("DEBUG: %s\n",name);        printf("DEBUG: \t\tRS232C_Dev = %s\n", RS232C_Dev);        printf("DEBUG: \t\tRS232C_Fd  = %d\n", RS232C_Fd);        if ( RS232C_Fd >= 0 ) {                ioctl( RS232C_Fd, TIOCGETP, &mode );        printf("DEBUG: \t\tRS232C_Mode.sg_ispeed = %#x\n", mode.sg_ispeed );        printf("DEBUG: \t\tRS232C_Mode.sg_ospeed = %#x\n", mode.sg_ospeed );        printf("DEBUG: \t\tRS232C_Mode.sg_erase  = %#x\n", mode.sg_erase  );        printf("DEBUG: \t\tRS232C_Mode.sg_kill   = %#x\n", mode.sg_kill   );        printf("DEBUG: \t\tRS232C_Mode.sg_flags  = %#x\n", mode.sg_flags  );        } /* if(RS232C_Fd) end */	} /* if(sw) end */	if ( sw == 2 ) {        printf("DEBUG: %s\n",name);	printf("DEBUG:\n");	printf("DEBUG: \t\tSymbol             Address    Contents\n");        printf("DEBUG: \t\tIOPAGE             %#x\n",Addr68k_from_LADDR(IOPAGE_OFFSET));         printf("DEBUG: \t\tHardWareConfig     %#x    %#x\n", HardWareConfig, *(DLword*) HardWareConfig);         printf("DEBUG: \t\tRS232CGetFlag      %#x    %#x\n", RS232CGetFlag, *(DLword*) RS232CGetFlag);         printf("DEBUG: \t\tRS232CPutFlag      %#x    %#x\n", RS232CPutFlag, *(DLword*) RS232CPutFlag);         printf("DEBUG: \t\tRS232CMiscCommand  %#x    %#x\n", RS232CMiscCommand, *(DLword*) RS232CMiscCommand);         printf("DEBUG: \t\tRS232CGetCSB       %#x    %#x\n", RS232CGetCSB, (LispPTR) (((*(RS232CGetCSB+1) & 0xff)<<16) + *RS232CGetCSB ));         printf("DEBUG: \t\tRS232CPutCSB       %#x    %#x\n", RS232CPutCSB, (LispPTR) (((*(RS232CPutCSB+1) & 0xff)<<16) + *RS232CPutCSB ));        printf("DEBUG: \t\tRS232CParameterCSB %#x    %#x\n", RS232CParameterCSB, *(DLword*) RS232CParameterCSB);        printf("DEBUG: \t\t                              %#x\n", *(DLword*) (RS232CParameterCSB+1));        printf("DEBUG: \t\t                              %#x\n", *(DLword*) (RS232CParameterCSB+2));        printf("DEBUG: \t\t                              %#x\n", *(DLword*) (RS232CParameterCSB+3));        printf("DEBUG: \t\t                              %#x\n", *(DLword*) (RS232CParameterCSB+4));        printf("DEBUG: \t\t                              %#x\n", *(DLword*) (RS232CParameterCSB+5));        printf("DEBUG: \t\t                              %#x\n", *(DLword*) (RS232CParameterCSB+6));        printf("DEBUG: \t\t                              %#x\n", *(DLword*) (RS232CParameterCSB+7));        if( RS232C_WrIOCB != NULL )         printf("DEBUG: \t\tRS232C_WrIOCB      %#x    %#x\n", RS232C_WrIOCB, *((LispPTR*)RS232C_WrIOCB));        if( RS232C_RdIOCB != NULL )         printf("DEBUG: \t\tRS232C_RdIOCB      %#x    %#x\n", RS232C_RdIOCB, *((LispPTR*)RS232C_RdIOCB)); 	/*        if( RS232C_WrBufAddr != NULL )         printf("DEBUG: \t\tRS232C_WrBufAddr   %s\n" , RS232C_WrBufAddr);        if( RS232C_WrBufAddr != NULL )         printf("DEBUG: \t\tRS232C_RdBufAddr   %s\n" , RS232C_RdBufAddr);	*/	} /* if(sw) end */ } /* rs232c_debug end */ 