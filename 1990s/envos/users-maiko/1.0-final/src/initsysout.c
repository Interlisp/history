/* This is G-file @(#) initsysout.c Version 2.5 (7/18/88). copyright Xerox & Fuji Xerox  */static char *id = "@(#) initsysout.c	2.5 7/18/88";/*	 *	Copyright (C) 1987 by Fuji Xerox Co., Ltd. All rights reserved. */#include <stdio.h>#include <string.h>#include "machineconfig.h"#include "lispemul.h"#include "lispglobal.h"#include "lisptypes.h"#include "lispmap.h"#include "address68k.h"#include "ifpage.h"#include "iopage.h"#include "cell.h"#include "systematoms.h"/********** definitions for bitblt. add by osamu**********/DLword	TEXTURE_atom; DLword	MERGE_atom; DLword	INPUT_atom; DLword	INVERT_atom; DLword	ERASE_atom; DLword	PAINT_atom; DLword	REPLACE_atom; /************ end definitions for bitblt.*****************/init_ifpage(sysout_size)	int sysout_size;{    extern long MDate;    /*      Initialize IFPAGE      */    InterfacePage->machinetype = KATANA;	/* 3 is katana */    init_ifpage_ether();	/* store ethernet ID in IF page */    InterfacePage->dl24bitaddressable = (sysout_size == 32? 0xffff : 0);    InterfacePage->dllastvmempage = LASTVMEMPAGE;    /* unfortunately, Lisp only looks at a 16 bit serial number */    InterfacePage->serialnumber = 0xffff & gethostid();     /* get user name and stuff into vmem; this is the VMEM buffer ;    This is a BCPL string -- it starts with a length count. C strings    are null terminated instead */    {char *s;    s = (char*)Addr68k_from_LADDR(0155001);    cuserid(s+1);    *s = (char)strlen(s+1);    }     /* sec from Oct-13-87 12:00  It's My birthday(take) */     /* MDate may be set by makefile(by makevdate.c) */    InterfacePage->rversion = (MDate - 561150000)/ (60*60*24);}init_iopage(){    /*     * Initialize IOPAGE      */    IOPage->dlkbdad0 = 65535;	/* ALL UP */    IOPage->dlkbdad1 = 65535;	/* ALL UP */    IOPage->dlkbdad2 = 65535;	/* ALL UP */    IOPage->dlkbdad3 = 65535;	/* ALL UP */    IOPage->dlkbdad4 = 65535;	/* ALL UP */    IOPage->dlkbdad5 = 65535;	/* ALL UP */    IOPage->dlutilin = 65535;	/* ALL UP */ }build_lisp_map(){   DLword index;    Atomspace = (DLword *) Addr68k_from_LADDR(ATOMS_OFFSET);    Stackspace = (DLword *) Addr68k_from_LADDR(STK_OFFSET);    Plistspace = (DLword *) Addr68k_from_LADDR(PLIS_OFFSET);    DTDspace = (DLword *) Addr68k_from_LADDR(DTD_OFFSET);    MDStypetbl = (DLword *) Addr68k_from_LADDR(MDS_OFFSET);    AtomHT = (DLword *) Addr68k_from_LADDR(ATMHT_OFFSET);    Pnamespace = (DLword *) Addr68k_from_LADDR(PNP_OFFSET);    Defspace = (DLword *) Addr68k_from_LADDR(DEFS_OFFSET);    Valspace = (DLword *) Addr68k_from_LADDR(VALS_OFFSET);    Spospspace = (unsigned short *) Addr68k_from_LADDR(S_POSITIVE);    Snegspace = (DLword *) Addr68k_from_LADDR(S_NEGATIVE);	ListpDTD = (struct dtd *)GetDTD(TYPE_LISTP) ;    FPtoVP = (DLword *) Addr68k_from_LADDR(FPTOVP_OFFSET);    PAGEMap = (DLword *) Addr68k_from_LADDR(PAGEMAP_OFFSET);    PageMapTBL = (DLword *) Addr68k_from_LADDR(PAGEMAPTBL_OFFSET);    LockedPageTable = (DLword *) Addr68k_from_LADDR(LOCKEDPAGETBL_OFFSET);    IOCBPage = (DLword *) Addr68k_from_LADDR(IOCBPAGE_OFFSET);    IOPage = (IOPAGE *) Addr68k_from_LADDR(IOPAGE_OFFSET);    InterfacePage = (IFPAGE *) Addr68k_from_LADDR(IFPAGE_OFFSET);    MiscStats = (MISCSTATS *) Addr68k_from_LADDR(MISCSTATS_OFFSET);    UFNTable = (DLword *) Addr68k_from_LADDR(UFNTBL_OFFSET);    DisplayRegion = (DLword *) Addr68k_from_LADDR(DISPALY_OFFSET);    HTmain = (DLword *) Addr68k_from_LADDR(HTMAIN_OFFSET);    HToverflow = (DLword *) Addr68k_from_LADDR(HTOVERFLOW_OFFSET);    HTbigcount = (DLword *) Addr68k_from_LADDR(HTBIG_OFFSET);    HTcoll = (DLword *) Addr68k_from_LADDR(HTCOLL_OFFSET);    Arrayspace = (DLword *) Addr68k_from_LADDR(ARRAY_OFFSET);    MDS_space_bottom = (DLword *) Addr68k_from_LADDR(MDS_BOTTOM_OFFSET);/**** cache values *****/   index = make_atom("\\NxtMDSPage",0,11,0);   Next_MDSpage_word  =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET+(index<<1));   index = make_atom("\\NxtArrayPage",0,13,0);   Next_Array_word =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET+(index<<1));   index = make_atom("\\MDSFREELISTPAGE",0,16,0);   MDS_free_page_word =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET+(index <<1));   index = make_atom("\\RECLAIM.COUNTDOWN",0,18,0);   Reclaim_cnt_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index <<1));   /*** cashe values for gcreclaimer : added by T. Teruuchi 30-Sep-1987 ***/   index = make_atom("\\GCDISABLED",0,11,0);   GcDisabled_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("CDRCODING",0,9,0);   CdrCoding_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));    /*** following cache values are the solution for array reclaimer ***/   index = make_atom("\\FREEBLOCKBUCKETS",0,17,0);   FreeBlockBuckets_word = (LispPTR *)Addr68k_from_LADDR(					VALS_OFFSET + (index << 1));   index = make_atom("ARRAYBLOCKCHECKING",0,18,0);   Array_Block_Checking_word = (LispPTR *)Addr68k_from_LADDR(					VALS_OFFSET + (index << 1));   index = make_atom("\\ARRAYMERGING",0,13,0);   ArrayMerging_word = (LispPTR *)Addr68k_from_LADDR(					VALS_OFFSET + (index << 1));   index = make_atom("\\ARRAYSPACE",0,11,0);   ArraySpace_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\ARRAYSPACE2",0,12,0);   ArraySpace2_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\ArrayFrLst",0,11,0);   ArrayFrLst_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\ArrayFrLst2",0,12,0);   ArrayFrLst2_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));      index = make_atom("\\HUNKING\?",0,9,0);   Hunk_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("SYSTEMBUFFERLIST",0,16,0);   System_Buffer_List_word = (LispPTR *)Addr68k_from_LADDR(					VALS_OFFSET + (index << 1));   /*** The addition of cache values is over. by Tomtom 30-Sep-1987 ***/   /*** The following cashe values are for the top level reclaimer ***/   index = make_atom("GCMESS",0,6,0);   GcMess_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\RECLAIMMIN",0,11,0);   ReclaimMin_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET +							(index << 1));   index = make_atom("\\GCTIME1",0,8,0);   GcTime1_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\GCTIME2",0,8,0);   GcTime2_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\MaxTypeNumber",0,14,0);   MaxTypeNumber_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET +							(index << 1));   /*** The following caches are for medley version April-28,1988 Tomtom ***/    index = make_atom("*PACKAGE-FROM-INDEX*",0,20,0);   Package_from_Index_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET +						(index << 1));   index = make_atom("*PACKAGE-FROM-NAME*",0,19,0);   Package_from_Name_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET +						(index << 1));   index = make_atom("*KEYWORD-PACKAGE*",0,17,0);   Keyword_Package_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET +						(index << 1));	   index = get_package_atom("*CLOSURE-CACHE-ENABLED*", 23, "SI", 2, NIL);   Closure_Cache_Enabled_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET +						(index << 1));   index = get_package_atom("*CLOSURE-CACHE*", 15, "SI", 2, NIL);   Closure_Cache_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET +						(index << 1));   index = get_package_atom("*DELETED-IMPLICIT-HASH-SLOT*", 28, "XCL", 3,NIL);   Deleted_Implicit_Hash_Slot_word = (LispPTR *)Addr68k_from_LADDR(		VALS_OFFSET + (index << 1));   index = get_package_atom("FIRST", 5, "KEYWORD", 7, T);   First_index = index;   /*** The above cache values are for closure-caching in Medley ***/ /*** THE following CACHE values are added by Take. ***/    STORAGEFULLSTATE_index = make_atom("\\STORAGEFULLSTATE",0,17,0);    STORAGEFULLSTATE_word= (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + ( STORAGEFULLSTATE_index << 1));   index = make_atom("\\STORAGEFULL",0,12,0);   STORAGEFULL_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\PENDINGINTERRUPT",0,17,0);   PENDINGINTERRUPT_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\LeastMDSPage",0,13,0);   LeastMDSPage_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\SecondMDSPage",0,14,0);   SecondMDSPage_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\SecondArrayPage",0,16,0);   SecondArrayPage_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\INTERRUPTSTATE",0,15,0);   INTERRUPTSTATE_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\SYSTEMCACHEVARS",0,16,0);   SYSTEMCACHEVARS_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\MACHINETYPE",0,12,0);   MACHINETYPE_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\LASTVMEMFILEPAGE",0,17,0);   LASTVMEMFILEPAGE_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\VMEM.FULL.STATE",0,16,0);   VMEM_FULL_STATE_word = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1)); /*** The followinfs are STK-OVER-FLOW staff * Take **/  index = make_atom("\\STACKOVERFLOW",0,14,0);  STACKOVERFLOW_word=(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\GuardStackAddr",0,15,0);  GuardStackAddr_word=(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));    index = make_atom("\\LastStackAddr",0,14,0);  LastStackAddr_word=(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));    index = make_atom("\\NEED.HARDRESET.CLEANUP",0,23,0);  NeedHardreturnCleanup_word=(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));  /*** The addition of cashe values for Bitblt by osamu April 13, 1988 ***/  TEXTURE_atom = make_atom("TEXTURE",0,7,0);  MERGE_atom = make_atom("MERGE",0,5,0);  INPUT_atom = make_atom("INPUT",0,5,0);  INVERT_atom = make_atom("INVERT",0,6,0);  ERASE_atom = make_atom("ERASE",0,5,0);  PAINT_atom = make_atom("PAINT",0,5,0);  REPLACE_atom = make_atom("REPLACE",0,7,0); /*** temp **/ init_for_keyhandle(); init_for_bltchar();}/****************/init_for_keyhandle(){ LispPTR index; extern DLword *CTopKeyevent ; extern LispPTR *KEYBOARDEVENTQUEUE68k; extern LispPTR *KEYBUFFERING68k;extern LispPTR DOBUFFEREDTRANSITION_index;extern LispPTR INTERRUPTFRAME_index;extern LispPTR *TIMER_INTERRUPT_PENDING68k;extern LispPTR *PENDINGINTERRUPT68k;extern LispPTR *MOUSECHORDTICKS68k;extern  LispPTR *LASTUSERACTION68k;extern LispPTR ATOM_STARTED;extern LispPTR *CLastUserActionCell68k;extern LispPTR *CURSORDESTHEIGHT68k;extern LispPTR *CURSORDESTWIDTH68k;extern LispPTR *CURSORHOTSPOTX68k;extern LispPTR *CURSORHOTSPOTY68k;extern LispPTR *SOFTCURSORUPP68k;extern LispPTR *PERIODIC_INTERRUPT68k;extern LispPTR *PERIODIC_INTERRUPT_FREQUENCY68k;extern LispPTR PERIODIC_INTERRUPTFRAME_index;extern LispPTR DORECLAIM_index;  index = MAKEATOM("\\CURSORDESTHEIGHT");   CURSORDESTHEIGHT68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));  index = MAKEATOM("\\CURSORDESTWIDTH");   CURSORDESTWIDTH68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));  index = MAKEATOM("\\CURSORHOTSPOTX");  CURSORHOTSPOTX68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));  index = MAKEATOM("\\CURSORHOTSPOTY");  CURSORHOTSPOTY68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));  index = MAKEATOM("\\SOFTCURSORUPP");  SOFTCURSORUPP68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   ATOM_STARTED= make_atom("STARTED",0,7,0);   index = make_atom("\\KEYBOARDEVENTQUEUE",0,19,0);   KEYBOARDEVENTQUEUE68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\KEYBUFFERING",0,13,0);   KEYBUFFERING68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\PENDINGINTERRUPT",0,17,0);   PENDINGINTERRUPT68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = MAKEATOM("\\MOUSECHORDTICKS");   MOUSECHORDTICKS68k=(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   index = make_atom("\\LASTUSERACTION",0,15,0);   LASTUSERACTION68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));   CLastUserActionCell68k= (LispPTR*)Addr68k_from_LADDR(*LASTUSERACTION68k& 0xffffff);   DOBUFFEREDTRANSITION_index = make_atom("\\DOBUFFEREDTRANSITIONS",0,22,0);   INTERRUPTFRAME_index = make_atom("\\INTERRUPTFRAME",0,15,0);    CTopKeyevent= (DLword*)Addr68k_from_LADDR(*KEYBOARDEVENTQUEUE68k);  index = MAKEATOM("\\PERIODIC.INTERRUPT");  PERIODIC_INTERRUPT68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));  index = MAKEATOM("\\PERIODIC.INTERRUPT.FREQUENCY");  PERIODIC_INTERRUPT_FREQUENCY68k =(LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));  PERIODIC_INTERRUPTFRAME_index = MAKEATOM("\\PERIODIC.INTERRUPTFRAME");  DORECLAIM_index = MAKEATOM("\\DORECLAIM"); } init_for_bltchar(){ LispPTR index; extern LispPTR        *TOPWDS68k; extern LispPTR         BLTCHAR_index;   BLTCHAR_index = get_package_atom("\\MAIKO.PUNTBLTCHAR", 18, "INTERLISP", 9, NIL); index = MAKEATOM("\\TOPWDS"); TOPWDS68k = (LispPTR *)Addr68k_from_LADDR(VALS_OFFSET + (index << 1));}