h00449s 00014/00007/00375d D 1.6 93/02/08 14:45:48 sybalsky 6 5c Big VM (and new CDR coding) changes for 3.0 \nes 00003/00001/00379d D 1.5 92/07/24 10:45:33 sybalsky 5 4c retrofit of SGI & DEC OSF1 changes \nes 00009/00005/00371d D 1.4 92/05/26 16:49:14 sybalsky 4 3c Xdefaults.h => Xdeflt.hes 00012/00000/00364d D 1.3 92/04/29 12:49:07 nilsson 3 2c Banes fixes to maxpage.es 00252/00130/00112d D 1.2 92/04/23 16:33:19 nilsson 2 1c New short name regimen. Improved X commandline handling.es 00242/00000/00000d D 1.1 92/04/21 15:27:57 sybalsky 1 0c date and time created 92/04/21 15:27:57 by sybalskyeuUf e 0tTI 1/* %Z% %M% Version %I% (%G%). copyright venue & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%	(venue & Fuji Xerox)";D 2/* %Z% %M% Version %I% (%G%). copyright venue & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%	(venue & Fuji Xerox)";E 2/***D 4* Copyright (C) 1988 by Fuji Xerox Co.,Ltd. All rights reserved.E 4**		Author: Mitsunori Matsuda*		Date  : June 5, 1988*I 2*		Modified Jarl Nilsson 1-apr-92 -Made the Xrm stuff work.E 2*/I 4E 4D 2E 2/************************************************************************//*									*/D 4/*	Copyright 1989, 1990 Venue, Fuji Xerox Co., Ltd, Xerox Corp.	*/E 4I 4/*	(C) Copyright 1989-92 Venue. All Rights Reserved.		*//*	Manufactured in the United States of America.			*/E 4/*									*/D 4/*	This file is work-product resulting from the Xerox/Venue	*//*	Agreement dated 18-August-1989 for support of Medley.		*/E 4I 4/*	The contents of this file are proprietary information 		*//*	belonging to Venue, and are provided to you under license.	*//*	They may not be further distributed or disclosed to third	*//*	parties without the specific permission of Venue.		*/E 4/*									*//************************************************************************/D 2E 2#include <stdio.h>D 2#ifdef ISC#include <strings.h>#elseE 2#include <string.h>D 2#endif /* ISC */E 2I 2#include <sys/file.h>#include <sys/time.h>I 5#ifndef NOETHERI 6#include <sys/types.h>E 6E 5#include <net/nit.h>	/* needed for Ethernet stuff below */I 5#endif /* NOETHER */E 5E 2I 2#include <X11/Xlib.h>#include <X11/Xutil.h>#include <X11/Xresource.h>E 2#include "XVersion.h"D 2#include "Xdeflt.h"E 2I 2#include "MyWindow.h"D 4#include "Xdefaults.h"E 4I 4#include "Xdeflt.h"E 4E 2#include "dbprint.h"#define FALSE 0#define TRUE  !FALSED 2char *Lisp_Window_Geom    , *Display_Name;char *Lisp_Screen_Size="";E 2I 2Display *Xdisplay;XrmDatabase commandlineDB, applicationDB, serverDB, homeDB, rDB;int opTableEntries = 30;extern int Display_Width;extern int Display_Height;E 2D 2int Auto_Repeat = FALSE; /* Turn on Auto-repeat? */int Def_Auto_Repeat = FALSE;int Lisp_Border = DEF_BDRWIDE;E 2I 2XrmOptionDescRec opTable[] = {      {"-help",		"*help",	XrmoptionIsArg, (caddr_t) "help"},      {"-h",		"*help",	XrmoptionIsArg, (caddr_t) "help"},      {"-sysout",	"*sysout",	XrmoptionSepArg, (caddr_t) NULL},      {"-display",	"*display",	XrmoptionSepArg, (caddr_t) NULL},      {"-d",		"*display",	XrmoptionSepArg, (caddr_t) NULL},      {"-borderWidth",	"*borderWidth",	XrmoptionSepArg, (caddr_t) NULL},      {"-bw",		"*borderWidth",	XrmoptionSepArg, (caddr_t) NULL},      {"-screen",	"*geometry",	XrmoptionSepArg, (caddr_t) NULL},      {"-sc",		"*geometry",	XrmoptionSepArg, (caddr_t) NULL},      {"-geometry",	"*geometry",	XrmoptionSepArg, (caddr_t) NULL},      {"-g",		"*geometry",	XrmoptionSepArg, (caddr_t) NULL},      {"-foreground",	"*foreground",	XrmoptionSepArg, (caddr_t) NULL},      {"-fg",		"*foreground",	XrmoptionSepArg, (caddr_t) NULL},      {"-background",	"*background",	XrmoptionSepArg, (caddr_t) NULL},      {"-bg",		"*background",	XrmoptionSepArg, (caddr_t) NULL},      {"-title",	"*title",	XrmoptionSepArg, (caddr_t) NULL},      {"-t",		"*title",	XrmoptionSepArg, (caddr_t) NULL},      {"-icontitle",	"*iconTitle",	XrmoptionSepArg, (caddr_t) NULL},      {"-it",		"*iconTitle",	XrmoptionSepArg, (caddr_t) NULL},      {"-iconbitmap",	"*iconbitmap",	XrmoptionSepArg, (caddr_t) NULL},      {"-ibm",		"*iconbitmap",	XrmoptionSepArg, (caddr_t) NULL},      {"-key",		"*key",		XrmoptionSepArg, (caddr_t) NULL},      {"-k",		"*key",		XrmoptionSepArg, (caddr_t) NULL},      {"-timer",	"*timer",	XrmoptionSepArg, (caddr_t) NULL},I 3      {"-maxpages",	"*maxpages",	XrmoptionSepArg, (caddr_t) NULL},E 3      {"-memory",	"*memory",	XrmoptionSepArg, (caddr_t) NULL},      {"-NF",		"*NoFork",	XrmoptionIsArg,  (caddr_t) NULL},      {"-INIT",		"*Init",	XrmoptionIsArg, (caddr_t) NULL},      {"-EtherNet",	"*EtherNet",	XrmoptionSepArg, (caddr_t) NULL},      {"-E",		"*EtherNet",	XrmoptionSepArg, (caddr_t) NULL},      {"-autorepeat",	"*autorepeat",	XrmoptionSepArg, (caddr_t) NULL},    };      /* autorepeat is a global setting for X, not anything that       Medley has to be concerned with. Item kept for historical       reasons /jarl       */E 2D 2#ifdef ISC	/* Need to define putc for X11 library's use */#undef putcputc(ch, f) int ch,f; {fputc(ch,f); };#endif ISCE 2I 2char Display_Name[128];int Lisp_Border = 2;D 6char *Window_Title[255];char *Icon_Title[255];E 6I 6char Window_Title[255];char Icon_Title[255];E 6extern char iconpixmapfile[];extern MyWindow Lisp_Window;extern char sysout_name[], keystring[];extern int sysout_size, for_makeinit, please_fork, Scroll_Border;I 3		/* diagnostic flag for sysout dumping */extern int maxpages;E 3extern char keystring[];E 2I 2/*** Ethernet stuff (JRB) **/#ifndef NOETHERextern int ether_fd;extern u_char ether_host[6];D 5#endif NOETHERE 5extern struct sockaddr_nit snit;I 5D 6#endif NOETHERE 6I 6#endif /* NOETHER */E 6E 5E 2I 6E 6D 2E 2/************************************************************************//*									*//*			r e a d _ X o p t i o n				*//*									*//*	Parse command-line options related to X windows.		*//*									*//************************************************************************/D 2read_Xoption( argc, argv )   int argc;  char *argv[];E 2I 2void read_Xoption( argc, argv )   int *argc;  char **argv;E 2  {D 2    int i      , option      , pos;E 2I 2    int bitmask;    XrmValue value;    char *str_type[30], tmp[1024], *envname;E 2I 6E 6D 2    TPRINT(( "TRACE: read_Xoption()\n" ));E 2I 2    (void)XrmInitialize();    /* If the first argv lacks '-' in front it is the sysout. */    XrmParseCommand(&commandlineDB, opTable, opTableEntries, argv[0], argc, argv);E 2D 2    for( i=1; i<argc; i++ )E 2I 2    if (XrmGetResource(commandlineDB, "ldex.help", "Ldex.Help",		       str_type, &value) == TRUE) {      print_Xusage( argv[0] );      exit(0);    }    if(*argc == 2)		/* There was probably a sysoutarg */E 2      {D 2	if( (strcmp(argv[i], "-help") == 0)	   || (strcmp(argv[i], "-h"   ) == 0) )	  {	    print_lispusage( argv[0] );	    print_Xusage( argv[0] );	    exit(1);	  }E 2I 2	sysout_name[0] = '\0';	(void)strcat(sysout_name, argv[1]);E 2      }D 2    option = ((argc > 1) && (argv[1][0] != '-')) ? 2 : 1;	    for( i=option ; i<argc; i++ )E 2I 2    else if ((envname = (char *)getenv("LDESRCESYSOUT")) != NULL)E 2      {I 2	strcpy(sysout_name, envname);      }    else if ((envname = (char *)getenv("LDESOURCESYSOUT")) != NULL)      strcpy(sysout_name, envname);    else {      envname = (char *)getenv("HOME");      (void)strcat(sysout_name, envname);      (void)strcat(sysout_name, "/lisp.virtualmem");E 2D 2#ifdef XV11R1	if (argv[i][0] == '=') {			Lisp_Window_Geom = argv[i];			continue;		}#else XV11R1 	if( (strcmp(argv[i], "-g") == 0 )		 || (strcmp(argv[i], "-geometry") == 0 ) ) {			Lisp_Window_Geom = argv[++i];			continue;		}#endif XV11R1E 2I 2      if( access(sysout_name, R_OK) != 0)	{	  (void)strcat(sysout_name, "");	}    }    if (XrmGetResource(commandlineDB,		       "ldex.display", "Ldex.Display",		       str_type, &value) == True) {      (void) strncpy(Display_Name, value.addr, (int)value.size);    } else {      (void) strcpy(Display_Name, "unix:0.0");    }I 6E 6    /* In order to access other DB's we have to open the main display now */    Open_Display(Display_Name);E 2D 2	pos = index( argv[i], ':' ); E 2I 2D 6    /* read the other databases */E 6I 6	/* read the other databases */E 6    /* Start with app-defaults/medley */    (void)strcpy(tmp, "/usr/lib/X11/app-defaults/");    (void)strcat(tmp, "medley");    applicationDB = XrmGetFileDatabase(tmp);    if (applicationDB != NULL){      (void)XrmMergeDatabases(applicationDB, &rDB);    }    /* Then try the displays defaults */    if (XResourceManagerString(Xdisplay) != NULL) {      serverDB = XrmGetStringDatabase(XResourceManagerString(Xdisplay));      if (serverDB != NULL){	(void)XrmMergeDatabases(serverDB, &rDB);      }    }    envname = (char *)getenv("HOME");    (void)strcat(tmp, envname);    (void)strcat(tmp, "/.Xdefaults");    if( access(tmp, R_OK) != 0) {      serverDB = XrmGetFileDatabase(tmp);      if (serverDB != NULL){	(void)XrmMergeDatabases(serverDB, &rDB);      }    }E 2D 2	if(pos != NULL) {			Display_Name = argv[i];			continue;		}E 2I 2    /* Now for the commandline */    (void)XrmMergeDatabases(commandlineDB, &rDB);E 2D 2#ifndef XV11R1	if( (strcmp(argv[i], "-d") == 0 )		 || (strcmp(argv[i], "-display") == 0 ) ) {			pos = index( argv[++i], ':' ); 			if(pos != NULL) {				Display_Name = argv[i];			}			continue;		}#endif XV11R1	/* Border Width */	if(strcmp(argv[i], "-bw") == 0) {			if (++i >= argc) {                        	print_lispusage( argv[0] );                        	print_Xusage( argv[0] );                                exit(1);                        }			Lisp_Border = atoi( argv[i] );			continue;		} E 2I 2    if (XrmGetResource(rDB,		       "ldex.borderWidth",		       "Ldex.BorderWidth",		       str_type, &value) == True) {	(void)strncpy(tmp, value.addr, (int)value.size);	Lisp_Window.border = atoi(tmp);	Scroll_Border = atoi(tmp);	if (Lisp_Window.border < 1){	  Lisp_Window.border = 1;	  Scroll_Border = 1;E 2D 2	/* Keyboad Auto Repeat */	if( (strcmp(argv[i], "-a") == 0 )		 || (strcmp(argv[i], "-autorepeat") == 0 ) ) {			Auto_Repeat = TRUE;			Def_Auto_Repeat = TRUE;			if( (++i < argc) && (argv[i][0] != '-') ) {E 2I 2	}    }	    if (XrmGetResource(rDB,		       "ldex.geometry",		       "Ldex.geometry",		       str_type, &value) == True) {      /* Get Geometry */      (void)strncpy(tmp, value.addr, (int)value.size);    } else {      (void)strcpy(tmp, "");	/* Clear the string */    }    Lisp_Window.width = DEF_WIN_WIDTH;    Lisp_Window.height = DEF_WIN_HEIGHT;    Lisp_Window.x = DEF_WIN_X;    Lisp_Window.y = DEF_WIN_Y;    bitmask = XParseGeometry(tmp , &(Lisp_Window.x) , &(Lisp_Window.y)			     , &(Lisp_Window.width) , &(Lisp_Window.height) );E 2D 2				if( strcmp(argv[i], "on" ) == 0 ) {					Auto_Repeat = TRUE;				} /* end if */E 2I 2    if (Lisp_Window.x < 0) {      Lisp_Window.x += Display_Width - (Lisp_Window.width - 1);    }    if (Lisp_Window.y < 0) {      Lisp_Window.y += Display_Height - (Lisp_Window.height - 1);    }    if (XrmGetResource(rDB,		       "ldex.sysout",		       "Ldex.Sysout",		       str_type, &value) == True) {      /* Get Sysout */      (void)strncpy(sysout_name, value.addr, (int)value.size);    }    if (sysout_name == NULL) {      fprintf(stderr, "Coudn't find a sysout to run;\n");      print_Xusage( argv[0] );      exit(1);    }E 2D 2				if( strcmp(argv[i], "off" ) == 0 ) {					Auto_Repeat = FALSE;				} /* end if */E 2I 2    if (XrmGetResource(rDB,		       "ldex.title",		       "Ldex.Title",		       str_type, &value) == True) {      (void)strncpy(Window_Title, value.addr, (int)value.size);    } else {      (void)strcpy(Window_Title,		   "Medley (C) Copyright 1980-92 by Venue and Fuji Xerox");    }    if (XrmGetResource(rDB,		       "ldex.iconTitle",		       "Ldex.iconTitle",		       str_type, &value) == True) {      (void)strncpy(Icon_Title, value.addr, (int)value.size);    } else {      (void)strcpy(Icon_Title, "Medley");    }E 2D 2			} else {				i--;			} /* end if(i) */E 2I 2    if (XrmGetResource(rDB,		       "ldex.iconbitmap",		       "Ldex.Iconbitmap",		       str_type, &value) == True) {      (void)strncpy(iconpixmapfile, value.addr, (int)value.size);    }E 2D 2			continue;		} /* end if */E 2I 2    if (XrmGetResource(rDB,		       "ldex.NF",		       "Ldex.NF",		       str_type, &value) == True) {      please_fork = 0;I 3    }    if (XrmGetResource(rDB,		       "ldex.maxpages",		       "Ldex.maxpages",		       str_type, &value) == True) {      (void)strncpy(tmp, value.addr, (int)value.size);      maxpages = atoi(tmp);E 3    }E 2D 2	/* ScreenBitMap Size */	if( (strcmp(argv[i], "-sc") == 0 )		 || (strcmp(argv[i], "-screen") == 0 ) ) {			Lisp_Screen_Size = argv[++i];			continue;		} /* end if */E 2I 2    if (XrmGetResource(rDB,		       "ldex.memory",		       "Ldex.memory",		       str_type, &value) == True) {      (void)strncpy(tmp, value.addr, (int)value.size);      sysout_size = atoi(tmp);    }E 2D 2	/* skip Lisp Opition */	if(strcmp(argv[i], "-t") == 0) {			i += 1;			continue;		} 	if(strcmp(argv[i], "-m") == 0) {			i += 1;			continue;		} 	if(strcmp(argv[i], "-NF") == 0) {			i += 1;			continue;		} 	if(strcmp(argv[i], "-k") == 0) {			i += 1;			continue;		} 	if(strcmp(argv[i], "-E") == 0) {			i += 1;			continue;		} 	print_lispusage( argv[0] );	print_Xusage( argv[0] );	exit( 1 );		      } /* end for */  } /* end readXoption */E 2I 2    if (XrmGetResource(rDB,		       "ldex.INIT",		       "Ldex.INIT",		       str_type, &value) == True) {      for_makeinit = 1;    }E 2I 2    if (XrmGetResource(rDB,		       "ldex.key",		       "Ldex.key",		       str_type, &value) == True) {      (void)strncpy(keystring, value.addr, (int)value.size);    }E 2I 2#ifdef NOETHER#else    if (XrmGetResource(rDB,		       "ldex.EtherNet",		       "Ldex.EtherNet",		       str_type, &value) == True) {      int b0, b1, b2, b3, b4, b5;      (void)strncpy(tmp, value.addr, (int)value.size);      if (sscanf(tmp,"%d:%x:%x:%x:%x:%x:%x:%s",&ether_fd,		 &b0, &b1, &b2, &b3, &b4, &b5, snit.snit_ifname) == 8)      {	ether_host[0] = b0; ether_host[1] = b1;	ether_host[2] = b2; ether_host[3] = b3;	ether_host[4] = b4; ether_host[5] = b5;      } else {	fprintf(stderr, "Missing or bogus -E argument\n");	ether_fd = -1;	exit(1);      }    }D 6#endif NOETHERE 6I 6#endif /* NOETHER */E 6  }				/* end readXoption */E 2I 2E 2/************************************************************************//*									*//*			p r i n t _ l i s p u s a g e			*//*									*//*	Print out command-line usage info if user enters wrong stuff.	*//*									*//************************************************************************/print_lispusage( prog )  char *prog;  {    TPRINT(( "TRACE: print_lisp_usage()\n" ));    /* Lisp Option */    fprintf(stderr,"lde[ether] [sysout] [-k access-key]");    fprintf(stderr," [-E <ethernet-info>]");    fprintf(stderr,"\n");  } /* end print_lisp_usage() *//************************************************************************//*									*//*			p r i n t _ X u s a g e				*//*									*//*	Print out command-line options for X, to help user.		*//*									*//************************************************************************/print_Xusage( prog )  char *prog;  {    TPRINT(( "TRACE: print_Xusage()\n" ));    fprintf(stderr,"\t");    /* X Option */#ifdef XV11R1    fprintf(stderr," [-bw <pixels>] [-help] [[<host>]:[<vs>]]");    fprintf(stderr," [=geometry]\n");D 6#else XV11R1E 6I 6#else /* XV11R1 */E 6    fprintf(stderr," [-bw <pixels>] [-h[elp]]" );    fprintf(stderr," [[-d[isplay]] [<host>][:<vs>]]");    fprintf(stderr,"\n\t");D 2    fprintf(stderr," [-g[eometry] <geom>] [-a[utorepeat] [on/off]]");    fprintf(stderr," [-sc[reen]] <w>x<h>]\n");	E 2I 2    fprintf(stderr," [-g[eometry] <geom>] [-sc[reen]] <w>x<h>]\n");	E 2D 6#endif XV11R1E 6I 6#endif /* XV11R1 */E 6  } /* end print_Xusage() */E 1