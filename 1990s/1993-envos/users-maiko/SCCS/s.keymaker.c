h11861s 00009/00011/00242d D 1.12 93/02/08 14:55:06 sybalsky 12 11c Big VM (and new CDR coding) changes for 3.0 \nes 00117/00076/00136d D 1.11 92/07/24 10:46:22 sybalsky 11 10c retrofit of SGI & DEC OSF1 changes \nes 00080/00052/00132d D 1.10 92/06/09 16:44:26 nilsson 10 9c Made keymaker take commandline arguments. It can be used as a filter now! /jarles 00000/00000/00184d D 1.9 92/04/21 17:17:30 sybalsky 9 8c shortening file names for DOS \nes 00000/00000/00184d D 1.8 90/04/20 01:45:05 sybalsky 8 7c AIX:  shortening file names, bulk change.es 00023/00020/00161d D 1.7 89/04/07 13:46:41 shih 7 6c added sccs stampes 00000/00000/00181d D 1.6 88/09/27 16:27:56 krivacic 6 5c merge sun3 & 4es 00032/00023/00149d D 1.5 88/09/27 14:49:21 shih 5 4c I forgetes 00033/00005/00139d D 1.4 88/06/23 10:27:12 sye 4 3c nes 00024/00015/00120d D 1.3 88/06/09 20:42:22 shih 3 2c cleanup, better output formatting (for grep, etc.).es 00043/00021/00092d D 1.2 88/05/20 18:31:04 sye 2 1c noes 00113/00000/00000d D 1.1 88/05/17 18:25:40 sye 1 0c date and time created 88/05/17 18:25:40 by syeeuUtTI 7D 11/* %Z% %M% Version %I% (%G%). copyright envos & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%	(envos & Fuji Xerox)";E 11I 11/* %Z% %M% Version %I% (%G%). copyright Venue  */static char *id = "%Z% %M%	%I% %G%	(Venue)";E 11I 11/************************************************************************//*									*//*	(C) Copyright 1989-92 Venue. All Rights Reserved.		*//*	Manufactured in the United States of America.			*//*									*//*	The contents of this file are proprietary information 		*//*	belonging to Venue, and are provided to you under license.	*//*	They may not be further distributed or disclosed to third	*//*	parties without the specific permission of Venue.		*//*									*//************************************************************************/E 11E 7I 1D 2/* This is G-file %Z% %M% Version %I% (%G%). copyright Xerox & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%";E 2/* =====================================================================	This function is used to generate copyright protection keys forD 7	NewCo's Maiko software.  It prompts for a machine's host id and E 7I 7D 11	Envos's Maiko software.  It prompts for a machine's host id andE 11I 11	enue's Medley software.  It prompts for a machine's host id andE 11E 7	the software's expiration date before generating a set of 3 keys.	The external functions called were stored in file 'keylib.o'.	Creation Date: May, 1988D 7   ===================================================================== */  E 7I 7   ===================================================================== */E 7#include <stdio.h>#include <string.h>#include <ctype.h>#define	GOLDEN_RATIO_HACK			-478700649#define	floadbyte(number,pos)		((number >> pos) & 0xFFFF)#define	hash_unhash(number,hashkey)	(number ^ (GOLDEN_RATIO_HACK * (floadbyte(hashkey,16) + floadbyte(hashkey,0)) ))#define	KEYNUMBERS					3D 2/*   meaning of the symbolic constants used:E 2I 2/*   meaning of symbolic constants used:E 2D 2		FAILURE1	invalid hostid 		FAILURE2	invalid date entered from terminal 		FAILURE3	invalid key 		FAILURE4	key expired           		FAILURE99	invalid date  (* this shouldn't happen unless string format returned by ctime got changed ) */E 2I 2D 3		FAILURE1					invalid hostid 		FAILURE2					invalid date entered from terminal  		FAILUER3					can't open logfile specified in the command line */E 3I 3D 7		FAILURE1	invalid hostid 		FAILURE2	invalid date entered from terminal  E 7I 7		FAILURE1	invalid hostid		FAILURE2	invalid date entered from terminalE 7		FAILURE3	can't open logfile in the command line */E 3E 2#define	FAILURE1					-1#define	FAILURE2					-2#define	FAILURE3					-3D 2#define	FAILURE4					-4#define 	FAILURE99					-99E 2unsigned long make_verification();unsigned long date_integer16();unsigned long idate();unsigned long modify();I 11/************************************************************************//*									*//*			w r i t e r e s u l t s				*//*									*//*	Prints the newly-generated key, along with identifying info	*//*									*//************************************************************************/E 11I 3D 5writeresults( fp, host, expdate, key1, key2, key3 )E 5I 5writeresults( fp, host, expdate, key1, key2, key3, info )E 5D 12	FILE *fp;	char *host, *expdate;	int key1, key2, key3;I 5	char *info;E 5    {D 5	fprintf(fp , "Host ID: %-14s Expiration: %-9s",host, expdate);	fprintf(fp , " Key: %8x %8x %8x\n", key1, key2, key3);E 5I 5	fprintf(fp, "Host ID: %-14s Expiration: %-9s",host, expdate);	fprintf(fp, " Key: %8x %8x %8x", key1, key2, key3);	fprintf(fp, " Doc: %s\n", info);E 5    };E 12I 12  FILE *fp;  char *host, *expdate;  int key1, key2, key3;  char *info;  {    fprintf(fp, "Host ID: %-14s Expiration: %-9s",host, expdate);    fprintf(fp, " Key: %8x %8x %8x", key1, key2, key3);    fprintf(fp, " Doc: %s\n", info);  }E 12I 11/************************************************************************//*									*//*									*//*									*//*									*//*									*//************************************************************************/E 11E 3D 2main() E 2I 2D 5main(argc , argv)E 5I 5main(argc, argv)E 5D 11	int  argc;	char *argv[];E 2 {I 2D 3	int  logfile = 0;		/* set to 1 if user specifies logfile name in the command line */	FILE *fp;				/* file pointer for the logfile */E 2	unsigned long hostid ;E 3I 3	int  logfile = 0;	/* set to 1 if logfile on command line */	FILE *fp;		/* file pointer for the logfile */	unsigned long hostid;E 3	long keyarray[KEYNUMBERS];	char *hexdigits = {"-0123456789abcdefABCDEF"};D 2  	char s[100] , expdate[50] , saveexpdate[50];E 2I 2D 4  	char s[50] , expdate[30] , saveexpdate[30];E 2	char *sptr, *dstr;E 4I 4D 5  	char s[50] , hstr[50] , expdate[30] , saveexpdate[30] , cc;	char *sptr, *ptr , *digitstring;E 5I 5D 7 	char s[50], hstr[50], expdate[30], saveexpdate[30], cc;E 7I 7	char s[50], hstr[50], expdate[30], saveexpdate[30], cc;E 7	char infostring[500];	char *sptr, *ptr, *digitstring;E 5E 4	char *hptr = {" "};	char **hhptr = &hptr;D 4	int  i,c;E 4I 4	int  base = 10;	int  i,j,c;I 10	int commandlineargs;E 11I 11  int  argc;  char *argv[];  {    int  logfile = 0;	/* set to 1 if logfile on command line */    FILE *fp;		/* file pointer for the logfile */    unsigned long hostid;    long keyarray[KEYNUMBERS];       char *hexdigits = {"-0123456789abcdefABCDEF"};    char s[50], hstr[50], expdate[30], saveexpdate[30], cc;    char infostring[500];    char *sptr, *ptr, *digitstring;    char *hptr = {" "};    char **hhptr = &hptr;    int  base = 10;    int  i,j,c;    int commandlineargs;E 11E 10E 4I 10D 11	commandlineargs = (argc > 2);	/* If we have more than one argv we assume this is used as a filter */E 11I 11    commandlineargs = (argc > 2);    /* If we have more than one argv we assume this is used as a filter */E 11E 10I 2   /* == check if user enters logfile name in the command line == */D 10	if (argc > 1)E 10I 10D 11	if ((argc > 1) & !commandlineargs)E 10		{			if ((fp = fopen(*++argv,"a")) == NULL)				{D 5					printf("\n Can't open %s \n", *argv);					exit(FAILURE3);E 5I 5				printf("\n Can't open %s \n", *argv);				exit(FAILURE3);E 5				};			logfile = 1;		};E 11I 11    if ((argc > 1) & !commandlineargs)      {	if ((fp = fopen(*++argv,"a")) == NULL)	  {	    printf("\n Can't open %s \n", *argv);	    exit(FAILURE3);	  };	logfile = 1;      };E 11E 2D 2   /* == prompt for machne's host id and check its validity == */E 2I 2D 3   /* == prompt for machine's host id, check its validity, then perform some modification == */E 3I 3   /* == prompt for machine's host id, verify, then do some modification == */E 3E 2D 2	printf("\n\nEnter Host ID: ");E 2I 2D 10	printf("\n\nEnter Host ID (starts with 0x if the number is hexidecimal): ");E 2	gets(s);	sptr = strtok(s," ");E 10I 10D 11	if (commandlineargs)	  {	    /* assume that the second argument is hex-hostid */	    sptr = *++argv;	    hostid = strtol(sptr,hhptr,16);E 11I 11    if (commandlineargs)      {	/* assume that the second argument is hex-hostid */	sptr = *++argv;	hostid = strtol(sptr,hhptr,16);E 11E 10D 4	hostid = strtol(sptr,hhptr,0);E 4I 4D 10	/* decide the base */D 5	if (((ptr = strchr(sptr,'0')) != NULL) && (*(ptr+1) == 'x' || *(ptr+1) == 'X')) base = 16;E 5I 5	if (((ptr = strchr(sptr,'0')) != NULL) &&	    (*(ptr+1) == 'x' || *(ptr+1) == 'X')) base = 16;E 10I 10D 11	  } else {	    printf("\n\nEnter Host ID (starts with 0x if the number is hexidecimal): ");	    gets(s);	    sptr = strtok(s," ");E 11I 11      }    else      {	printf("\n\nEnter Host ID (starts with 0x if the number is hexidecimal): ");	gets(s);	sptr = strtok(s," ");E 11E 10E 5D 10	hostid = strtol(sptr,hhptr,base);	/* look for syntax error */E 4D 7	if (**hhptr != '\0') E 7I 7	if (**hhptr != '\0')E 7	  {E 10I 10	    /* decide the base */D 11	    if (((ptr = strchr(sptr,'0')) != NULL) &&E 11I 11	if (((ptr = strchr(sptr,'0')) != NULL) &&E 11		(*(ptr+1) == 'x' || *(ptr+1) == 'X')) base = 16;	    D 11	    hostid = strtol(sptr,hhptr,base);E 11I 11#ifdef INDIGO	hostid = strtoul(sptr,hhptr,base);#else	hostid = strtol(sptr,hhptr,base);#endifE 11	    	    /* look for syntax error */D 11	    if (**hhptr != '\0')	      {E 11I 11	if (**hhptr != '\0')	  {E 11E 10		printf("\nInvalid Host ID \n");D 2		exit(-1);E 2I 2		exit(FAILURE1);E 2D 10	  };E 10I 10D 11	      };E 11I 11	  };E 11E 10D 4	hostid = modify(hostid);E 4I 4D 10	/* make sure Host ID  is less than 32 bits */D 7	if (base == 16) E 7I 7	if (base == 16)E 7		{	sprintf(hstr, "%x", hostid);			for (i = 0 ; (cc = *(sptr+i)) != '\0' ; ++i)				if (isupper(cc)) *(sptr+i) = tolower(cc);			for (i = 0 ; (cc = *(hstr+i)) != '\0' ; ++i)				if (isupper(cc)) *(hstr+i) = tolower(cc);			digitstring = "123456789abcdef";		}D 7	  else 		{    sprintf(hstr, "%u", hostid); E 7I 7	  else		{    sprintf(hstr, "%u", hostid);E 7			digitstring = "123456789";		};E 10I 10	    /* make sure Host ID  is less than 32 bits */D 11	    if (base == 16)	      {	sprintf(hstr, "%x", hostid);E 11I 11	if (base == 16)	  {	sprintf(hstr, "%x", hostid);E 11		for (i = 0 ; (cc = *(sptr+i)) != '\0' ; ++i)		  if (isupper(cc)) *(sptr+i) = tolower(cc);		for (i = 0 ; (cc = *(hstr+i)) != '\0' ; ++i)		  if (isupper(cc)) *(hstr+i) = tolower(cc);		digitstring = "123456789abcdef";D 11	      }	    else	      {    sprintf(hstr, "%u", hostid);E 11I 11	  }	else	  {    sprintf(hstr, "%u", hostid);E 11		   digitstring = "123456789";D 11		 };E 11I 11	  };E 11E 10D 10	ptr = strpbrk(sptr,digitstring);D 5	if ((ptr == NULL && *sptr != '0' && *hstr != '0') || (ptr != NULL && strcmp(ptr,hstr) != 0)) E 5I 5	if ((ptr == NULL && *sptr != '0' && *hstr != '0') ||D 7	    (ptr != NULL && strcmp(ptr,hstr) != 0)) E 7I 7	    (ptr != NULL && strcmp(ptr,hstr) != 0))E 7E 5	 {E 10I 10D 11	    ptr = strpbrk(sptr,digitstring);	    if ((ptr == NULL && *sptr != '0' && *hstr != '0') ||E 11I 11	ptr = strpbrk(sptr,digitstring);	if ((ptr == NULL && *sptr != '0' && *hstr != '0') ||E 11		(ptr != NULL && strcmp(ptr,hstr) != 0))	      {E 10D 7		printf("\nInvalid Host ID \n"); E 7I 7		printf("\nInvalid Host ID \n");E 7		exit(FAILURE1);I 10	      }E 10D 7	  }; E 7I 7D 11	  };E 11I 11      };E 11E 7D 12E 12D 11	hostid = modify(hostid);E 11I 11    hostid = modify(hostid);E 11E 4I 5   /* == prompt for the expiration date and validate it == */E 5I 5D 10	printf("\n\nEnter information string (one line only, below)\n:");	gets(infostring);E 10I 10D 11	if (!commandlineargs)E 11I 11    if (!commandlineargs)E 11	  {	    /* assume that info is not needed when we use argc,argv */	    printf("\n\nEnter information string (one line only, below)\n:");	    gets(infostring);	  }E 10E 5D 2   /* == prompt for the expiration date and validat it == */E 2I 2   /* == prompt for the expiration date and validate it == */E 2D 2	printf("Enter Software Expiration Date (dd-mmm-yy): ");E 2I 2D 10	printf("Enter Software Expiration Date (dd-mmm-yy or never): ");E 2D 7	gets(expdate); E 7I 7	gets(expdate);E 10I 10D 11	if (commandlineargs)E 11I 11    if (commandlineargs)E 11	  {	    	    strcpy(expdate,*++argv);	    	  } else {	    	    printf("Enter Software Expiration Date (dd-mmm-yy or never): ");	    gets(expdate);	    	  }E 10E 7D 11	strcpy(saveexpdate,expdate);D 10E 10	/* check for 'never' entry */D 7	if ((expdate[0] == 'N') || (expdate[0] == 'n')) E 7I 7	if ((expdate[0] == 'N') || (expdate[0] == 'n'))E 11I 11    strcpy(saveexpdate,expdate);    /* check for 'never' entry */    if ((expdate[0] == 'N') || (expdate[0] == 'n'))E 11E 7D 10		{		    for (i = 0 ; (c = expdate[i]) != '\0' ; ++i)				if (islower(c)) expdate[i] = toupper(c);D 3		    if ( strcmp(expdate , "NEVER") == 0) strcpy(expdate ,  "29-DEC-77");E 3I 3D 5		    if ( strcmp(expdate, "NEVER") == 0) strcpy(expdate,  "29-DEC-77");E 5I 5		    if ( strcmp(expdate, "NEVER") == 0)			  strcpy(expdate, "29-DEC-77");E 5E 3			  else {D 5					printf("\nInvalid Software Expiration Date\n");D 2					exit(-1);E 2I 2					exit(FAILURE2);E 2				  };E 5I 5				printf("\nInvalid Software Expiration Date\n");				exit(FAILURE2);				};E 5		};D 7	E 7I 7E 10I 10	  {	    for (i = 0 ; (c = expdate[i]) != '\0' ; ++i)	      if (islower(c)) expdate[i] = toupper(c);	    	    if ( strcmp(expdate, "NEVER") == 0)	      strcpy(expdate, "29-DEC-77");	    else {	      printf("\nInvalid Software Expiration Date\n");	      exit(FAILURE2);	    };	  };	E 10E 7	/* validate the date */D 7	if ( idate(expdate) == FAILURE2) E 7I 7D 11	if ( idate(expdate) == FAILURE2)E 11I 11    if ( idate(expdate) == FAILURE2)E 11E 7	  {D 10		printf("\nInvalid Software Expiration Date\n");D 2		exit(-1);E 2I 2		exit(FAILURE2);E 10I 10	    printf("\nInvalid Software Expiration Date\n");	    exit(FAILURE2);E 10E 2	  };D 5	/* E 5I 5 /* == generate 3 keys == */E 5D 12E 12D 5	   /* == generate 3 keys == */E 5I 5D 11	keyarray[0] = hash_unhash(hostid, hostid);D 7	keyarray[1] = hash_unhash( ((date_integer16(expdate) << 16) | 0), hostid); E 7I 7	keyarray[1] = hash_unhash( ((date_integer16(expdate) << 16) | 0), hostid);E 7	keyarray[2] = make_verification(keyarray[0], keyarray[1]);E 11I 11    keyarray[0] = hash_unhash(hostid, hostid);    keyarray[1] = hash_unhash( ((date_integer16(expdate) << 16) | 0), hostid);    keyarray[2] = make_verification(keyarray[0], keyarray[1]);E 11E 5D 5	keyarray[0] = hash_unhash(hostid , hostid);	keyarray[1] = hash_unhash( ((date_integer16(expdate) << 16) | 0) , hostid); 	keyarray[2] = make_verification(keyarray[0] , keyarray[1]);E 5D 5E 5  /* == report the results == */I 10D 11	if (commandlineargs)	  {	    printf("%8x %8x %8x\n", *keyarray, *(keyarray+1), *(keyarray+2));	  } else {E 11I 11    if (commandlineargs)      {	printf("%8x %8x %8x\n", *keyarray, *(keyarray+1), *(keyarray+2));      }    else      {E 11E 10I 2	/* if logfile is open, append the results to the end of the file */	if (logfile == 1)	  {D 7		if (argc > 2) E 7I 7D 11		if (argc > 2)E 7			{D 3				fprintf(fp,"\n\n%s",*++argv);				printf("\n\n%s",*argv);E 3I 3				fprintf(fp,"\n%s",*++argv);				printf("\n%s",*argv);E 3			}D 3		fprintf(fp , "\n\nHost ID: %s            Expiration Date: %s",sptr,saveexpdate);		fprintf(fp , "\nKeys generated: %x    %x    %x\n\n", *keyarray , *(keyarray+1) , *(keyarray+2));E 3I 3D 7		writeresults( fp, sptr, saveexpdate, E 7I 7		writeresults( fp, sptr, saveexpdate,E 7D 5				*keyarray, *(keyarray+1) , *(keyarray+2));E 5I 5D 10				*keyarray, *(keyarray+1), *(keyarray+2),E 10I 10			     *keyarray, *(keyarray+1), *(keyarray+2),E 11I 11	    if (argc > 2)	      {		fprintf(fp,"\n%s",*++argv);		printf("\n%s",*argv);	      }	    writeresults( fp, sptr, saveexpdate,			  *keyarray, *(keyarray+1), *(keyarray+2),E 11E 10				infostring);E 5E 3D 11		fclose(fp);E 11I 11	    fclose(fp);E 11	  };D 3E 3I 3D 7	writeresults( stdout, sptr, saveexpdate, E 7I 7	writeresults( stdout, sptr, saveexpdate,E 7D 5			*keyarray, *(keyarray+1) , *(keyarray+2) );E 5I 5			*keyarray, *(keyarray+1), *(keyarray+2),			infostring);E 5E 3	/* display the results on the terminal */E 2D 3	printf("\n\nHost ID: %s            Expiration Date: %s",sptr,saveexpdate);	printf("\nKeys generated: %x    %x    %x\n\n", *keyarray , *(keyarray+1) , *(keyarray+2));E 3D 2	return 0;E 2I 2D 10E 10I 10      };E 10D 11	exit(0);E 11I 11    exit(0);E 11E 2}E 1