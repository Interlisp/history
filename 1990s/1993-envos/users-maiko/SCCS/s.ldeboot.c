h48835s 00020/00010/00249d D 1.12 92/11/25 21:07:02 sybalsky 12 11c Fixing endif's with extra text => comment. \nes 00000/00000/00259d D 1.11 92/04/21 17:17:47 sybalsky 11 10c shortening file names for DOS \nes 00018/00000/00241d D 1.10 91/10/15 18:16:56 sybalsky 10 9c ISC changeses 00002/00000/00239d D 1.9 91/01/24 22:11:03 sybalsky 9 8c Merge HP9000 changes (HPUX => don't load strings.h)es 00014/00005/00225d D 1.8 90/09/18 23:45:03 sybalsky 8 7c Retrofit changes from AIX, DEC3100, PS/2es 00022/00002/00208d D 1.7 90/07/04 04:01:29 sybalsky 7 6c Bane changes:  Fork unix process earlier.es 00143/00094/00067d D 1.6 90/06/26 15:08:36 sybalsky 6 5c Comments, reformat if clauses, fix copyright.es 00104/00100/00057d D 1.5 90/04/25 10:58:07 osamu 5 4c Fix segmentation fault on sun3 problem.c old: if( Display_Name[0] == '\0' ) c new: if( Display_Name == NULL ) { c if Display_Name == NULL , old code references NULL pointer.es 00000/00000/00157d D 1.4 90/04/20 01:46:00 sybalsky 4 3c AIX:  shortening file names, bulk change.es 00075/00004/00082d D 1.3 90/03/01 12:57:44 osamu 3 2c Mitsunori Matsuda adds XWindow functionality.es 00000/00006/00086d D 1.2 90/02/06 16:59:16 osamu 2 1c es 00092/00000/00000d D 1.1 90/02/06 16:53:38 osamu 1 0c date and time created 90/02/06 16:53:38 by osamueuUf e 0tTI 1D 3static char *id = "@(#) ldeboot.c 1.1  6/29/89 20:36:32 ";E 3I 3D 6/* %Z% %M% Version %I% (%G%). copyright envos & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%		(envos & Fuji Xerox)";	E 6I 6/* %Z% %M% Version %I% (%G%). copyright Venue & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%		(Venue & Fuji Xerox)";	/************************************************************************//*									*//*	Copyright 1989, 1990 Venue, Fuji Xerox Co., Ltd, Xerox Corp.	*//*									*//*	This file is work-product resulting from the Xerox/Venue	*//*	Agreement dated 18-August-1989 for support of Medley.		*//*									*//************************************************************************/E 6E 3D 8/*  (c) CopyRight Fuji Xerox 1989  Maiko Project */D 3/* FILE: ldeether.c REL.1 SCCSID:1.1  *//* SCCS file: /envos/medley/fuji/1.1.3/emul/SCCS/s.ldeether.c  */E 3I 3/* FILE: ldeboot.c REL.1 SCCSID:1.1  *//* SCCS file: /envos/medley/fuji/1.1.3/emul/SCCS/s.ldeboot.c  */E 3E 8D 2/* * *	startlisp.c, Tue Oct 27 17:24:13 1987 *	Copyright (C) 1988 by Xerox Co.  All rights reserved. */E 2D 3E 3#include <stdio.h>#include <ctype.h>#include <sys/ioctl.h>I 8#ifdef sunE 8#include <sun/fbio.h>I 8D 12#endif sunE 12I 12#endif /* sun */E 12E 8#include <fcntl.h>#include <errno.h>I 3#ifdef XWINDOWI 9#ifndef HPUXE 9#include <strings.h>I 9D 12#endif HPUXE 12I 12#endif /* HPUX */E 12E 9#include <X11/Xlib.h>#include <X11/Xutil.h>#include "XVersion.h"#define LDEX "ldex"extern char *getenv();D 12#endif XWINDOWE 12I 12#endif /* XWINDOW */E 12I 12E 12E 3#define LDEMONO "ldesingle"#define LDECOLOR "ldemulti"I 10#define LDETRUECOLOR "ldetruecolor"E 10#define FBTYPE_SUNFAST_COLOR 12char filetorun[30];D 5main(argc, argv, envp) int argc; char **argv, **envp;E 5I 5D 6main(argc, argv) int argc; char **argv;E 5{D 5	char	Earg[30], Ename[30], **newargv;	int i;	struct fbtype my_screen;E 5I 5  char	Earg[30], Ename[30], **newargv;  int i;  struct fbtype my_screen;E 6E 5D 5	int FrameBufferFd;E 5I 5D 6  int FrameBufferFd;E 6E 5D 5	struct	fbinfo FB_info;	struct fbgattr FBattr;/* Kickstart program for the Lisp Development Environment (LDE).	Display Device       emulator	CG3, CG6             lde.multi	BW2, CG2, CG4, CG9   lde.singleE 5I 5D 6  struct	fbinfo FB_info;  struct fbgattr FBattr;E 6I 6/************************************************************************//*									*//*				m a i n					*//*									*//*	Kick-start program for the "Lisp Development Environment" (lde)	*//*									*//************************************************************************/main(argc, argv)  int argc; char **argv;  {    char	Earg[30], Ename[30], **newargv;    int i;I 8#ifdef sunE 8    struct fbtype my_screen;I 8D 12#endif sunE 12I 12#endif /* sun */E 12E 8I 12E 12    int FrameBufferFd;I 8#ifdef sunE 8    struct	fbinfo FB_info;    struct fbgattr FBattr;I 8D 12#endif sunE 12I 12#endif /* sun */E 12I 12E 12E 8E 6  /* Kickstart program for the Lisp Development Environment (LDE).     Display Device       emulator     CG3, CG6             lde.multi     BW2, CG2, CG4, CG9   lde.single          FB-TYPE       REAL-TYPE     BW2      2             x     CG2      3             3     CG3      8             6     CG4      2             8      CG6      8             12I 10     CG8      6             7E 10     CG9(GP1) 4             4    ;gpconfig -f -b     CG9(GP1) 2            13    ;gpconfig gpone0 -f -b cgtwo0      ;We assume This config for GXP model     */E 5D 5	         FB-TYPE       REAL-TYPE 	BW2      2             x	CG2      3             3	CG3      8             6	CG4      2             8 	CG6      8             12	CG9(GP1) 4             4    ;gpconfig -f -b	CG9(GP1) 2            13    ;gpconfig gpone0 -f -b cgtwo0 	                            ;We assume This config for GXP model*/I 3E 5#ifdef XWINDOWD 5/* If X-Server exists on the host specified in -display option  or environment variable DISPLAY, ldex is started. Othewise   ldesingle or ldemulti.*/{ char *Display_Name ;Display *Xdisplay;int i  , option;char *pos;E 5I 5D 6  /* If X-Server exists on the host specified in -display option     or environment variable DISPLAY, ldex is started. Othewise      ldesingle or ldemulti.     */  {     char *Display_Name = (char *)NULL ;    Display *Xdisplay = (Display *)NULL;    int i , option;    char *pos;E 6I 6    /* If X-Server exists on the host specified in -display option       or environment variable DISPLAY, ldex is started. Othewise        ldesingle or ldemulti.       */      { 	char *Display_Name = (char *)NULL ;	Display *Xdisplay = (Display *)NULL;	int i , option;	char *pos;E 6E 5D 5for( i=1; i<argc; i++ ) {E 5I 5D 6    for( i=1; i<argc; i++ ) {E 6I 6	for( i=1; i<argc; i++ )	  {E 6E 5#ifdef XV11R1D 5  pos = index( argv[i], ':' );  if(pos != NULL) {    Display_Name = argv[i];    continue;  }E 5I 5D 6      pos = index( argv[i], ':' );      if(pos != NULL) {	Display_Name = argv[i];	continue;      }E 6I 6	    pos = index( argv[i], ':' );	    if(pos != NULL)	      {		Display_Name = argv[i];		continue;	      }E 6E 5D 12#endif XV11R1E 12I 12#endif /* XV11R1 */E 12#ifndef XV11R1D 5  if( (strcmp(argv[i], "-d") == 0 )   || (strcmp(argv[i], "-display") == 0 ) ) {    pos = index( argv[++i], ':' );    if(pos != NULL) {      Display_Name = argv[i];    }    continue;  }E 5I 5D 6      if( (strcmp(argv[i], "-d") == 0 )	 || (strcmp(argv[i], "-display") == 0 ) ) {	if (i == argc) break;	pos = index( argv[++i], ':' );	if(pos != NULL) {	  Display_Name = argv[i];	}	continue;      }E 6I 6	    if( (strcmp(argv[i], "-d") == 0 )	        || (strcmp(argv[i], "-display") == 0 ) )	      {		if (i == argc) break;		pos = index( argv[++i], ':' );		if(pos != NULL)		  {		    Display_Name = argv[i];		  }		continue;	      }E 6E 5D 12#endif XV11R1E 12I 12#endif /* XV11R1 */E 12D 5} /*end for() */E 5I 5D 6    }				/*end for() */E 6I 6	  }				/*end for() */E 6E 5D 5if( (Xdisplay = XOpenDisplay( Display_Name )) != NULL ) {  /* success to connect X-server */  XCloseDisplay( Xdisplay );  strcpy(filetorun, LDEX);  argv[0] = filetorun;  execvp(filetorun, argv);  perror(filetorun);  exit(1);} else { /* failed to connect X-server */E 5I 5D 6    if( (Xdisplay = XOpenDisplay( Display_Name )) != (Display *)NULL ) {      /* success to connect X-server */      XCloseDisplay( Xdisplay );      strcpy(filetorun, LDEX);      argv[0] = filetorun;      execvp(filetorun, argv);      perror(filetorun);      exit(1);    } else {			/* failed to connect X-server */E 6I 6	if( (Xdisplay = XOpenDisplay( Display_Name )) != (Display *)NULL )	  {D 7      	    /* success to connect X-server */      	    XCloseDisplay( Xdisplay );E 7I 7	    /* success to connect X-server */	    XCloseDisplay( Xdisplay );E 7	    strcpy(filetorun, LDEX);I 7#ifdef FORKCOMM/* JRB - call fork_Unix here, while we're REALLY small, unless -NF is	specified, of course... */	    for(i=0; i<argc; i++)		if(!strcmp(argv[i], "-NF")) break;	    if(i == argc)  /* -NF not in arguments */		fork_Unix();D 8#endifE 8I 8D 12#endif FORKCOMME 12I 12#endif /* FORKCOMM */E 12E 8I 12E 12E 7	    argv[0] = filetorun;	    execvp(filetorun, argv);	    perror(filetorun);	    exit(1);	  }	else	  {			/* failed to connect X-server */E 6E 5#define NAME_LEN 100D 5  char host_name[NAME_LEN];  gethostname( host_name, NAME_LEN );  if( Display_Name[0] == '\0' ) {    if( (Display_Name = getenv("DISPLAY")) != NULL ) {      if( (strncmp( Display_Name                  , host_name                  , strlen( host_name )) ) == NULL ) {        fprintf( stderr, "ldeboot: can't find X-Server\n" );        exit( -1 );      } /* end if */    } /* end if */  } else {    fprintf( stderr, "ldeboot: can't find X-Server\n" );    exit( -1 );  } /* end if */} /* end if */}E 5I 5D 6      char host_name[NAME_LEN];      gethostname( host_name, NAME_LEN );      if( Display_Name == NULL ) {	if( (Display_Name = getenv("DISPLAY")) != NULL ) {	  if( strncmp( Display_Name		      , host_name		      , strlen( host_name )) == 0) {	    fprintf( stderr, "ldeboot: can't find X-Server\n" );	    exit( -1 );	  }			/* end if */	}E 6I 6	    char host_name[NAME_LEN];	    gethostname( host_name, NAME_LEN );	    if( Display_Name == NULL )	      {		if( (Display_Name = getenv("DISPLAY")) != NULL )		  {		    if( strncmp( Display_Name		                 , host_name		               , strlen( host_name )) == 0)		      {			fprintf( stderr, "ldeboot: can't find X-Server\n" );			exit( -1 );		      }			/* end if */		  }E 6	/* end if */D 6      } else {	fprintf( stderr, "ldeboot: can't find X-Server\n" );	exit( -1 );      }				/* end if */    }				/* end if */  }E 6I 6     	      }	    else	      {		fprintf( stderr, "ldeboot: can't find X-Server\n" );		exit( -1 );	      }				/* end if */	  }				/* end if */      }E 6E 5D 12#endif XWINDOWE 12I 12#endif /* XWINDOW */E 12I 12E 12I 8#ifdef sunE 8I 5D 6  if( (FrameBufferFd = open( "/dev/fb", O_RDWR )) < 0){    fprintf( stderr, "ldeboot: can't open FrameBuffer\n");    exit( -1 );  }  if (ioctl(FrameBufferFd, FBIOGTYPE, &my_screen) <0) {    perror("initdisplay0:");    exit( -1 );  }E 6I 6    if( (FrameBufferFd = open( "/dev/fb", O_RDWR )) < 0)      {	fprintf( stderr, "ldeboot: can't open FrameBuffer\n");	exit( -1 );      }    if (ioctl(FrameBufferFd, FBIOGTYPE, &my_screen) <0)      {	perror("initdisplay0:");	exit( -1 );      }E 6E 5E 3D 5if( (FrameBufferFd = open( "/dev/fb", O_RDWR )) < 0){	fprintf( stderr, "ldeboot: can't open FrameBuffer\n");	exit( -1 );}if (ioctl(FrameBufferFd, FBIOGTYPE, &my_screen) <0) {	perror("initdisplay0:");}if( my_screen.fb_type == FBTYPE_SUN4COLOR ){  /*  cg3 or cg6 */  if(ioctl(FrameBufferFd,FBIOGATTR,&FBattr) >= 0){    if( FBattr.real_type == FBTYPE_SUN3COLOR ||     /* cg3 */        FBattr.real_type == FBTYPE_SUNFAST_COLOR ){ /* cg6 */      strcpy(filetorun, LDECOLOR);E 5I 5D 6  if( my_screen.fb_type == FBTYPE_SUN4COLOR ){ /*  cg3 or cg6 */    if(ioctl(FrameBufferFd,FBIOGATTR,&FBattr) >= 0){      if( FBattr.real_type == FBTYPE_SUN3COLOR || /* cg3 */	 FBattr.real_type == FBTYPE_SUNFAST_COLOR ){ /* cg6 */	strcpy(filetorun, LDECOLOR);E 6I 6    if( my_screen.fb_type == FBTYPE_SUN4COLOR )      { /*  cg3 or cg6 */	if(ioctl(FrameBufferFd,FBIOGATTR,&FBattr) >= 0)	  {	    if( FBattr.real_type == FBTYPE_SUN3COLOR || /* cg3 */		FBattr.real_type == FBTYPE_SUNFAST_COLOR ) /* cg6 */	      {		strcpy(filetorun, LDECOLOR);	      }  	  }	else	  {			/* if( ioctl... */	    perror("lde: This Display Model does not supported\n");	    exit( -1 );	  }E 6      }D 6    }else{			/* if( ioctl... */      perror("lde: This Display Model does not supported\n");      exit( -1 );E 5    }D 5  }else{ /* if( ioctl... */    perror("lde: This Display Model does not supported\n");  }}else if( my_screen.fb_type == FBTYPE_SUN2BW  ){ /* bw2, cg4 or cg9  */E 5I 5  }else if( my_screen.fb_type == FBTYPE_SUN2BW  ){ /* bw2, cg4 or cg9  */E 5    strcpy(filetorun, LDEMONO);D 5}else if( my_screen.fb_type == FBTYPE_SUN2COLOR  ){ /* cg2  */E 5I 5  }else if( my_screen.fb_type == FBTYPE_SUN2COLOR  ){ /* cg2  */E 5    strcpy(filetorun, LDEMONO);D 5}else{ E 5I 5  }else{ E 5    perror("lde: This Display Model does not supported\n");D 5}; /* endif( my_screen... */E 5I 5    exit (-1);  };				/* endif( my_screen... */E 6I 6    else if( my_screen.fb_type == FBTYPE_SUN2BW  )      { /* bw2, cg4 or cg9  */	strcpy(filetorun, LDEMONO);      }I 10    else if( my_screen.fb_type == FBTYPE_SUN3COLOR )	{ 	if(ioctl(FrameBufferFd,FBIOGATTR,&FBattr) >= 0)	  {	    if( FBattr.real_type == FBTYPE_MEMCOLOR ) /* cg8 */	      {		strcpy(filetorun, LDETRUECOLOR);	      }  	  }	else	  {			/* if( ioctl... */	    perror("lde: This Display Model does not supported\n");	    exit( -1 );	  }			}E 10    else if( my_screen.fb_type == FBTYPE_SUN2COLOR  )      { /* cg2  */	strcpy(filetorun, LDEMONO);      }    else      { 	perror("lde: This Display Model does not supported\n");	exit (-1);      };				/* endif( my_screen... */E 6E 5D 5 close(FrameBufferFd);E 5I 5D 6  close(FrameBufferFd);E 6I 6    close(FrameBufferFd);I 8D 12#endif sunE 12I 12#endif /* sun */E 12E 8I 7#ifdef FORKCOMM/* JRB - call fork_Unix here, while we're REALLY small, unless -NF is	specified, of course... */   for(i=0; i<argc; i++)	if(!strcmp(argv[i], "-NF")) break;   if(i == argc)  /* -NF not in arguments */	fork_Unix();#endifE 7E 6E 5D 5/* start ldemono or ldecolor */E 5I 5D 6  /* start ldemono or ldecolor */E 6I 6    /* start ldemono or ldecolor */E 6E 5D 5argv[0] = filetorun;	/* or whatever... */E 5I 5D 6  argv[0] = filetorun;		/* or whatever... */E 6I 6    argv[0] = filetorun;		/* or whatever... */E 6E 5D 5/* then execve the LDE executable */ execvp(filetorun, argv);perror(filetorun);E 5I 5D 6  /* then execve the LDE executable */  execvp(filetorun, argv);  perror(filetorun);E 6I 6    /* then execve the LDE executable */    execvp(filetorun, argv);    perror(filetorun);E 6E 5D 5exit(1);E 5I 5D 6  exit(1);E 5}E 6I 6    exit(1);  }E 6E 1