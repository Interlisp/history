h29894s 00016/00011/00099d D 1.2 88/06/15 22:06:12 shih 2 1c now obsoleted by ldeetheres 00110/00000/00000d D 1.1 88/06/13 17:20:17 bane 1 0c date and time created 88/06/13 17:20:17 by baneeuUtTI 1D 2/* This is G-file %Z% %M% Version %I% (%G%). copyright Xerox & Fuji Xerox  */static char *id = "%Z% %M%	%I% %G%";E 2I 2/* This is G-file @(#) ldeether.c Version 1.3 (6/15/88). copyright Xerox & Fuji Xerox  */static char *id = "@(#) ldeether.c	1.3 6/15/88";E 2/* * *	startlisp.c, Tue Oct 27 17:24:13 1987 *	Copyright (C) 1988 by Xerox Co.  All rights reserved. */#include <stdio.h>#include <ctype.h>#include <sys/types.h>#include <sys/time.h>#include <sys/socket.h>#include <net/if.h>#include <netdb.h>#include <netinet/in.h>#include <netinet/if_ether.h>#include <net/nit.h>#include <sys/ioctl.h>#include <nlist.h>int ether_fd = -1;	/* file descriptor for ether socket */unsigned char ether_host[6] = {0,0,0,0,0,0};	/* 48 bit address */D 2char filetorun[30] = "lisp";E 2I 2char filetorun[30] = "lde";E 2main(argc, argv, envp) int argc; char **argv, **envp;{	char	Earg[30], Ename[30], **newargv;	int i;D 2/* Kickstart program for Maiko.  Run this as setuid root to open the	Maiko ether socket.  Passes all arguments through to Maiko	plus -E <ether-info> to communicate open ether socket.E 2I 2/* Kickstart program for the Lisp Development Environment (LDE).	Run this as setuid root to open the LDE ether socket.	Passes all arguments through to LDE plus -E <ether-info>	to communicate open ether socket.E 2	<ether-info> looks like this:	<descriptor-number>:<b1>:<b2>:<b3>:<b4>:<b5>:<b6>:<name>I 2E 2	where <descriptor-number> is the number of the open	socket (decimal), and <b1>-<b6> are hex of the socket's	48-bit Ethernet address, and <name> is the name of the	Ethernet device as found by SIOCGIFCONF.*/	/* JRB - This code will have to be a bit different for SUN 4.0; the		probable differences are in commented-out code below		(not ifdefed because they're untested...)	*/if (getuid() != geteuid()){	if ((ether_fd = socket(AF_NIT, SOCK_RAW, NITPROTO_RAW)) >= 0) {	/* 4.0: socket -> open("/dev/nit", O_BOTH) */	/* it's open, now query it and find out its name and address */D 2	/* JRB - must document that Maiko uses the first net board as foundE 2I 2	/* JRB - must document that LDE uses the first net board as foundE 2	by SIOCGIFCONF (see if(4)).  Maybe we need an option to specifyD 2	which net board (suspect more than one net board on a Maiko machineE 2I 2	which net board (suspect more than one net board on an LDE machineE 2	will be rare, but...).	*/	struct ifconf if_data;	struct ifreq ifbuf[20];	if_data.ifc_len = sizeof(ifbuf);	if_data.ifc_req = ifbuf;	/* 4.0 - before the SIOCGIFCONF, do:		bzero(ifbuf, sizeof(ifbuf))	*/	if(ioctl(ether_fd, SIOCGIFCONF, &if_data) < 0) {		perror("Couldn't GIFCONF socket; Net is off");		close(ether_fd);		ether_fd = -1;		goto I_Give_Up;	}	/* 4.0, before the SIOCGIFADDR, do:		ioctl(ether_fd, NIOCBIND, &if_data.ifc_req[0])	*/	/* now for the address */	if(ioctl(ether_fd, SIOCGIFADDR, &if_data.ifc_req[0]) < 0) {		perror("Couldn't GIFADDR socket: Net is off");		close(ether_fd);		ether_fd = -1;		goto I_Give_Up;	}	bcopy(if_data.ifc_req[0].ifr_addr.sa_data, ether_host, 6);	strcpy(Ename, if_data.ifc_req[0].ifr_name);	/* bind the socket to an interface */	printf("init_ether: **** Ethernet starts ****\n");	} else {I_Give_Up:		printf("init_ether: can't open NIT socket\n");		ether_fd = -1;	}	seteuid(getuid());	}I 2E 2/* OK, right here do other stuff like scan args and fork subshell */D 2/* finally crank up Maiko; first copy the original args*/E 2I 2/* finally crank up LDE; first copy the original args */E 2newargv = (char **) malloc((argc + 1 + (ether_fd > 0)*2) * sizeof (char **));newargv[0] = filetorun;	/* or whatever... */for(i=1; i<argc; i++) newargv[i] = argv[i];/* then if the net is active, spit out the ether info */if(ether_fd > 0) {	newargv[i++] = "-E";	sprintf(Earg, "%d:%x:%x:%x:%x:%x:%x:%s", ether_fd,		ether_host[0], ether_host[1], ether_host[2],		ether_host[3], ether_host[4], ether_host[5], Ename);	newargv[i++] = Earg;}newargv[i] = 0;D 2/* then execve the Maiko executable */E 2I 2/* then execve the LDE executable */E 2execve(filetorun, newargv, envp);D 2printf("ACK! execve returned!!!!\n");E 2I 2printf("ACK! execve returned!!  Couldn't execute 'lde' for some reason!\n");E 2}E 1