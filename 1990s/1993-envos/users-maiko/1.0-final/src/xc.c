/* This is G-file @(#) xc.c Version 2.20 (7/27/88). copyright Xerox & Fuji Xerox  */#include <sys/types.h>#include <sys/time.h>#include <stdio.h>#include "lispemul.h"#include "emulglobal.h"#include "address.h"#include "address68k.h"#include "stack.h"#include "lispglobal.h"#include "lisptypes.h"#include "lispmap.h"#include "cell.h"#include "initatoms.h"#include "gc.h"#include "arith.h"#include "stream.h"#include "tos1defs.h" #include "tosretmacro.h"#include "tosfuncallmacro.h"#include "inlinedefsC.h"#ifndef C_ONLY#include "n_op_inlinedefsC.h"#ifdef mc68020#include "inlinedefs68K.h"#ifdef UNSAFE#include "fastinlinedefs68K.h"#endif#endif#ifdef sparc#include "dummy_entries.h"#include "inlinedefsSPARC.h"#endif#ifdef OPDISP#include "fast_dispatch.h"#endif#endif /* C_ONLY */#include "profile.h"#define PCMAC 		pccache#define CSTKPTR  	((LispPTR *) cspcache)#define	PVAR		((LispPTR *) MachineState.pvar)#define IVAR		((LispPTR *) MachineState.ivar)#define BCE_CURRENTFX	((struct  frameex2 *)((DLword *) PVAR - FRAMESIZE))typedef struct conspage ConsPage;typedef ByteCode *InstPtr;extern ByteCode *PC;extern CFuncPTR OPCODE_entries[];extern int Intrdisable;extern DLword *createcell68k();InstPtr optable[512];int Irq_Stk_Check = 0;		/* Usually contains safe StkLim */int Irq_Stk_End = 0;		/* = real stk lim */int Scratch_CSTK;		/* for N_OP_xx,keeps scratch value				 for exceptions */int n_mask_array[16] = {	1, 3, 7, 0xf, 			0x1f, 0x3f, 0x7f, 0xff,			0x1ff, 0x3ff, 0x7ff, 0xfff,			0x1fff, 0x3fff, 0x7fff, 0xffff};dispatch(){ 	doDispatch();}doDispatch(){	register InstPtr pccache;  	register InstPtr *table;	register LispPTR *cspcache;	register LispPTR tscache;	register int SaveD6;	register int Save_D5_shift_amount;/* OP_FN_COMMON arguments */    DefCell *fn_defcell;    LispPTR fn_atom_index;    int fn_opcode_size;    int fn_num_args;    int fn_apply;    LispPTR fn_loc_defcell;    DLword *fvar_chain;	RET; 	CLR_IRQ;	table = optable;	Save_D5_shift_amount = 15;	SaveD6 = 0;#ifdef OPDISP	goto setup_table;#else	goto nextopcode;#endif	/* INLINE OPCODE FAIL ENTRY POINTS, CALL EXTERNAL ROUTINES HERE */#ifndef C_ONLY	OPCODEFAIL;#endif/* OPCODE FAIL ENTRY POINTS, CALL UFNS HERE */	UFN_CALLS;op_ufn:	{ register UFN *entry68k;						   entry68k = (UFN *)GetUFNEntry(Get_BYTE(PCMAC));			   fn_num_args = entry68k->arg_num;					   fn_opcode_size = entry68k->byte_num+1;				   fn_atom_index = entry68k->atom_name;					   fn_defcell = (DefCell *) GetDEFCELL68k(fn_atom_index);		   fn_apply = 2 + entry68k->byte_num; /* code for UFN entry */   goto op_fn_common;							};/* FUNCTION CALL TAIL ROUTINE */	OP_FN_COMMON;/* DISPATCH "LOOP" */nextopcode :switch (Get_BYTE(PCMAC)) {  case 000 : CASE000: { goto op_ufn; } /* unused */ case 001 : CASE001: OPCAR; case 002 : CASE002: OPCDR; case 003 : CASE003: LISTP; case 004 : CASE004: NTYPEX; case 005 : CASE005: TYPEP(Get_BYTE(PCMAC+1)); case 056 : CASE056:  case 006 : CASE006: DTEST(Get_DLword(PCMAC+1)); case 007 : CASE007: UNWIND(Get_BYTE(PCMAC+1), Get_BYTE(PCMAC+2)); 	    ret_to_fn0: asm("_ret_to_fn0:"); 			asm("	.globl _ret_to_fn0"); 			RET_FROM_NATIVE; case 010 : CASE010: FN0;	    ret_to_fn1: asm("_ret_to_fn1:"); 			asm("	.globl _ret_to_fn1"); 			RET_FROM_NATIVE; case 011 : CASE011: FN1;	    ret_to_fn2: asm("_ret_to_fn2:"); 			asm("	.globl _ret_to_fn2"); 			RET_FROM_NATIVE; case 012 : CASE012: FN2;	    ret_to_fn3: asm("_ret_to_fn3:"); 			asm("	.globl _ret_to_fn3"); 			RET_FROM_NATIVE; case 013 : CASE013: FN3;	    ret_to_fn4: asm("_ret_to_fn4:"); 			asm("	.globl _ret_to_fn4"); 			RET_FROM_NATIVE; case 014 : CASE014: FN4;	    ret_to_fnx: asm("_ret_to_fnx:"); 			asm("	.globl _ret_to_fnx"); 			RET_FROM_NATIVE; case 015 : CASE015: FNX;	    ret_to_apply: asm("_ret_to_apply:"); 			asm("	.globl _ret_to_apply"); 			RET_FROM_NATIVE; case 016 : CASE016: APPLY; case 017 : CASE017: CHECKAPPLY; case 020 : CASE020: RETURN; case 021 : CASE021: BIND; case 022 : CASE022: UNBIND; case 023 : CASE023: DUNBIND; case 024 : CASE024: RPLPTR(Get_BYTE(PCMAC+1)); case 025 : CASE025: GCREF; case 026 : CASE026: ASSOC; case 027 : CASE027: GVAR_(Get_DLword(1+PCMAC)); case 030 : CASE030: RPLACA; case 031 : CASE031: RPLACD; case 032 : CASE032: CONS; case 033 : CASE033: CLASSOC; case 034 : CASE034: FMEMB; case 035 : CASE035: CLFMEMB; case 036 : CASE036: FINDKEY(Get_BYTE(PCMAC+1)); case 037 : CASE037: CREATECELL; case 040 : CASE040: BIN; case 041 : CASE041: { goto op_ufn; } /* BOUT */ case 042 : CASE042: { goto op_ufn; } /* POPDISP - prolog only */ case 043 : CASE043: RESTLIST(Get_BYTE(PCMAC+1)); case 044 : CASE044: { goto op_ufn; }  /* unused */ case 045 : CASE045: { goto op_ufn; }  /* unused */ case 046 : CASE046: RPLCONS; case 047 : CASE047: LISTGET; case 050 : CASE050: { goto op_ufn; }  /* unused */ case 051 : CASE051: { goto op_ufn; }  /* unused */ case 052 : CASE052: { goto op_ufn; }  /* unused */ case 053 : CASE053: { goto op_ufn; }  /* unused */ case 054 : CASE054: EVAL;	    ret_to_envcall: asm("_ret_to_envcall:"); 			asm("	.globl _ret_to_envcall"); 			RET_FROM_NATIVE; case 055 : CASE055: ENVCALL;/*  case 056 : CASE056: @ 006 */ case 057 : CASE057: STKSCAN; case 060 : CASE060: { goto op_ufn; } /* BUSBLT - DLion only */ case 061 : CASE061: { goto op_ufn; } /* MISC8 - no longer used */ case 062 : CASE062: UBFLOAT3(Get_BYTE(1+PCMAC)); case 063 : CASE063: TYPEMASK(Get_BYTE(1+PCMAC)); case 064 : CASE064: { goto op_ufn; } /* rdprologptr */ case 065 : CASE065: { goto op_ufn; } /* rdprologtag */ case 066 : CASE066: { goto op_ufn; } /* writeptr&tag */ case 067 : CASE067: { goto op_ufn; } /* writeptr&0tag */ case 070 : CASE070: { goto op_ufn; }  /* misc7 (pseudocolor) */ case 071 : CASE071: { goto op_ufn; } /* dovemisc - dove only */ case 072 : CASE072: EQLOP; case 073 : CASE073: DRAWLINE; case 074 : CASE074: STOREN(Get_BYTE(1+PCMAC)); case 075 : CASE075: COPYN(Get_BYTE(1+PCMAC)); case 076 : CASE076: { goto op_ufn; } /* RAID */ case 077 : CASE077: { goto op_ufn; } /* \RETURN */ case 0100 : CASE100:  IVARMACRO (0);   case 0101 : CASE101:  IVARMACRO (1);   case 0102 : CASE102:  IVARMACRO (2);   case 0103 : CASE103:  IVARMACRO (3);   case 0104 : CASE104:  IVARMACRO (4);   case 0105 : CASE105:  IVARMACRO (5);   case 0106 : CASE106:  IVARMACRO (6);    case 0107 : CASE107:  IVARX (Get_BYTE(1+PCMAC));    case 0110 : CASE110:  PVARMACRO (0);   case 0111 : CASE111:  PVARMACRO (1);  case 0112 : CASE112:  PVARMACRO (2);   case 0113 : CASE113:  PVARMACRO (3);   case 0114 : CASE114:  PVARMACRO (4);   case 0115 : CASE115:  PVARMACRO (5);   case 0116 : CASE116:  PVARMACRO (6);     case 0117 : CASE117: PVARX(Get_BYTE(1+PCMAC)); case 0120 : CASE120: FVAR(0); case 0121 : CASE121: FVAR(2); case 0122 : CASE122: FVAR(4); case 0123 : CASE123: FVAR(6); case 0124 : CASE124: FVAR(8); case 0125 : CASE125: FVAR(10); case 0126 : CASE126: FVAR(12); case 0127 : CASE127: FVARX(Get_BYTE(1+PCMAC));		 case 0130 : CASE130: PVARSETMACRO (0);  case 0131 : CASE131: PVARSETMACRO (1);  case 0132 : CASE132: PVARSETMACRO (2); case 0133 : CASE133: PVARSETMACRO (3);  case 0134 : CASE134: PVARSETMACRO (4);  case 0135 : CASE135: PVARSETMACRO (5);  case 0136 : CASE136: PVARSETMACRO (6);  case 0137 : CASE137: PVARX_(Get_BYTE(1+PCMAC));  case 0140 : CASE140: GVAR(Get_DLword(1+PCMAC)); case 0141 : CASE141: ARG0; case 0142 : CASE142: IVARX_(Get_BYTE(1+PCMAC)); case 0143 : CASE143: FVARX_(Get_BYTE(1+PCMAC)); case 0144 : CASE144: COPY; case 0145 : CASE145: MYARGCOUNT; case 0146 : CASE146: MYALINK;/******** Aconst	********/ case 0147 : CASE147: { PUSH(Get_DLword(PCMAC+1)); nextop3;} case 0150 : CASE150: { PUSHATOM(NIL_PTR     ); } case 0151 : CASE151: { PUSHATOM(ATOM_T      ); } case 0152 : CASE152: { PUSHATOM(S_POSITIVE  ); } /* '0 */ case 0153 : CASE153: { PUSHATOM(0xE0001     ); } /* '1 *//********* SIC		********/ case 0154 : CASE154: {	 		PUSH(S_POSITIVE | Get_BYTE(PCMAC+1)); 		nextop2;		}/********* SNIC		********/ case 0155 : CASE155: { 			PUSH(S_NEGATIVE | 0xff00 | Get_BYTE(PCMAC+1)); 		nextop2;		}/********* SICX		********/ case 0156 : CASE156:{ 	 		PUSH(S_POSITIVE | Get_DLword(PCMAC+1)); 		nextop3;		}/********* GCONST	********/ case 0157 : CASE157: {		PUSH(	(Get_BYTE(PCMAC + 1) << 16) | 			(Get_BYTE(PCMAC + 2) << 8) | 			Get_BYTE(PCMAC +  3));		nextop4;		}  case 0160 : CASE160: { goto op_ufn; } /* unused */ case 0161 : CASE161: { goto op_ufn; } /* readflags */ case 0162 : CASE162: { goto op_ufn; } /* readrp */ case 0163 : CASE163: { goto op_ufn; } /* writemap */ case 0164 : CASE164: { goto op_ufn; } /* readprinterport */ case 0165 : CASE165: { goto op_ufn; } /* writeprinterport */ case 0166 : CASE166: PILOTBITBLT; case 0167 : CASE167: RCLK; case 0170 : CASE170: { goto op_ufn; } /* MISC1, dorado only */ case 0171 : CASE171: { goto op_ufn; } /* MISC2, dorado only */ case 0172 : CASE172: RECLAIMCELL; case 0173 : CASE173: GCSCAN1; case 0174 : CASE174: GCSCAN2; case 0175 : CASE175: { EXT; OP_subrcall(); RET; NATIVE_NEXTOP0; }; case 0176 : CASE176: { CONTEXTSWITCH; } case 0177 : CASE177: { goto op_ufn; } /* RETCALL *//* JUMP */ case 0200 : CASE200: { JUMPMACRO(2); } case 0201 : CASE201: { JUMPMACRO(3); } case 0202 : CASE202: { JUMPMACRO(4); } case 0203 : CASE203: { JUMPMACRO(5); } case 0204 : CASE204: { JUMPMACRO(6); } case 0205 : CASE205: { JUMPMACRO(7); } case 0206 : CASE206: { JUMPMACRO(8); } case 0207 : CASE207: { JUMPMACRO(9); } case 0210 : CASE210: { JUMPMACRO(10); } case 0211 : CASE211: { JUMPMACRO(11); } case 0212 : CASE212: { JUMPMACRO(12); } case 0213 : CASE213: { JUMPMACRO(13); } case 0214 : CASE214: { JUMPMACRO(14); } case 0215 : CASE215: { JUMPMACRO(15); } case 0216 : CASE216: { JUMPMACRO(16); } case 0217 : CASE217: { JUMPMACRO(17); }/* FJUMP */ case 0220 : CASE220: { FJUMPMACRO(2); } case 0221 : CASE221: { FJUMPMACRO(3); } case 0222 : CASE222: { FJUMPMACRO(4); } case 0223 : CASE223: { FJUMPMACRO(5); } case 0224 : CASE224: { FJUMPMACRO(6); } case 0225 : CASE225: { FJUMPMACRO(7); } case 0226 : CASE226: { FJUMPMACRO(8); } case 0227 : CASE227: { FJUMPMACRO(9); } case 0230 : CASE230: { FJUMPMACRO(10); } case 0231 : CASE231: { FJUMPMACRO(11); } case 0232 : CASE232: { FJUMPMACRO(12); } case 0233 : CASE233: { FJUMPMACRO(13); } case 0234 : CASE234: { FJUMPMACRO(14); } case 0235 : CASE235: { FJUMPMACRO(15); } case 0236 : CASE236: { FJUMPMACRO(16); } case 0237 : CASE237: { FJUMPMACRO(17); }/* TJUMP */ case 0240 : CASE240: { TJUMPMACRO(2); } case 0241 : CASE241: { TJUMPMACRO(3); } case 0242 : CASE242: { TJUMPMACRO(4); } case 0243 : CASE243: { TJUMPMACRO(5); } case 0244 : CASE244: { TJUMPMACRO(6); } case 0245 : CASE245: { TJUMPMACRO(7); } case 0246 : CASE246: { TJUMPMACRO(8); } case 0247 : CASE247: { TJUMPMACRO(9); } case 0250 : CASE250: { TJUMPMACRO(10); } case 0251 : CASE251: { TJUMPMACRO(11); } case 0252 : CASE252: { TJUMPMACRO(12); } case 0253 : CASE253: { TJUMPMACRO(13); } case 0254 : CASE254: { TJUMPMACRO(14); } case 0255 : CASE255: { TJUMPMACRO(15); } case 0256 : CASE256: { TJUMPMACRO(16); } case 0257 : CASE257: { TJUMPMACRO(17); }/******* JUMPX ********/ case 0260 : CASE260: {		CHECK_INTERRUPT;		PCMAC += *(PCMAC+1); nextop0; 		}/******* JUMPXX ********/ case 0261 : CASE261: {		CHECK_INTERRUPT;		PCMAC += (*(PCMAC+1)<<8) | Get_BYTE(PCMAC+2); nextop0; 		}/******* FJumpx *******/ case 0262 : CASE262: {    if(TOPOFSTACK != 0) {goto PopNextop2;}	CHECK_INTERRUPT;	POP;	PCMAC += *(PCMAC+1);	nextop0; 	}/******* TJumpx *******/ case 0263 : CASE263: {	if(TOPOFSTACK == 0) {goto PopNextop2;}	CHECK_INTERRUPT;	POP;	PCMAC += *(PCMAC+1);	nextop0; 	}/******* NFJumpx *******/ case 0264 : CASE264: {	if(TOPOFSTACK != 0) {goto PopNextop2;}	CHECK_INTERRUPT;	PCMAC += *(PCMAC+1);	nextop0; 	}/******* NTJumpx *******/ case 0265 : CASE265: {	if(TOPOFSTACK == 0) {goto PopNextop2;}	CHECK_INTERRUPT;	PCMAC += *(PCMAC+1);	nextop0; 	} case 0266 : CASE266:	AREF1; case 0267 : CASE267:	ASET1; case 0270 : CASE270:	PVARSETPOPMACRO(0); case 0271 : CASE271:	PVARSETPOPMACRO(1); case 0272 : CASE272:	PVARSETPOPMACRO(2); case 0273 : CASE273:	PVARSETPOPMACRO(3); case 0274 : CASE274:	PVARSETPOPMACRO(4); case 0275 : CASE275:	PVARSETPOPMACRO(5); case 0276 : CASE276:	PVARSETPOPMACRO(6); case 0277 : CASE277: 	{ POP; nextop1; } case 0300 : CASE300:  POPN(Get_BYTE(PCMAC+1)); case 0301 : CASE301: 	ATOMCELL_N(Get_BYTE(PCMAC+1)); case 0302 : CASE302: 	GETBASEBYTE; case 0303 : CASE303:  INSTANCEP(Get_DLword(PCMAC+1)); case 0304 : CASE304:  BLT; case 0305 : CASE305:  {goto op_ufn; } /* MISC10 */ case 0306 : CASE306:  {goto op_ufn; } /* P-MISC2 ??? */ case 0307 : CASE307:	PUTBASEBYTE; case 0310 : CASE310:	GETBASE_N(Get_BYTE(PCMAC+1)); case 0311 : CASE311:	GETBASEPTR_N(Get_BYTE(PCMAC+1)); case 0312 : CASE312:	GETBITS_N_M(Get_BYTE(PCMAC+1), Get_BYTE(PCMAC+2)); case 0313 : CASE313:  {goto op_ufn; } /* unused */ case 0314 : CASE314:	CLEQUAL; case 0315 : CASE315:	PUTBASE_N(Get_BYTE(PCMAC+1)); case 0316 : CASE316:	PUTBASEPTR_N(Get_BYTE(PCMAC+1)); case 0317 : CASE317:	PUTBITS_N_M(Get_BYTE(PCMAC+1), Get_BYTE(PCMAC+2)); case 0320 : CASE320:	ADDBASE; case 0321 : CASE321:	VAG2; case 0322 : CASE322:	HILOC; case 0323 : CASE323:	LOLOC; case 0324 : CASE324: 	PLUS2; /* PLUS */ case 0325 : CASE325:  DIFFERENCE;	/* DIFFERENCE */	 case 0326 : CASE326:	TIMES2; /* TIMES2 */ case 0327 : CASE327:  QUOTIENT /* QUOTIENT */ case 0330 : CASE330:  IPLUS2; /* IPLUS2 only while PLUS has no float */ case 0331 : CASE331:  IDIFFERENCE; /* IDIFFERENCE only while no float */ case 0332 : CASE332:	ITIMES2; /* ITIMES2 only while no float */ case 0333 : CASE333:	IQUOTIENT; /* IQUOTIENT */ case 0334 : CASE334:	IREMAINDER; case 0335 : CASE335:	IPLUS_N(Get_BYTE(PCMAC+1)); case 0336 : CASE336:	IDIFFERENCE_N(Get_BYTE(PCMAC+1)); case 0337 : CASE337:  { goto op_ufn; } /* BASE-< */ case 0340 : CASE340:  LLSH1; case 0341 : CASE341:  LLSH8; case 0342 : CASE342:  LRSH1; case 0343 : CASE343:  LRSH8; case 0344 : CASE344:  LOGOR; case 0345 : CASE345:  LOGAND; case 0346 : CASE346:  LOGXOR; case 0347 : CASE347:  LSH; case 0350 : CASE350:  FPLUS2; case 0351 : CASE351:  FDIFFERENCE; case 0352 : CASE352:  FTIMES2; case 0353 : CASE353:  FQUOTIENT; case 0354 : CASE354:  UBFLOAT2(Get_BYTE(PCMAC+1)); case 0355 : CASE355:  UBFLOAT1(Get_BYTE(PCMAC+1)); case 0356 : CASE356:  AREF2; case 0357 : CASE357:  ASET2; case 0360 : CASE360: {		if(TOPOFSTACK == POP_TOS_1)			TOPOFSTACK = ATOM_T;		else	TOPOFSTACK = NIL_PTR;		nextop1;		} case 0361 : CASE361:  IGREATERP; /* IGREATERP if no float */	 case 0362 : CASE362:  FGREATERP; case 0363 : CASE363:	GREATERP; case 0364 : CASE364:  ILEQUAL; case 0365 : CASE365:	MAKENUMBER; case 0366 : CASE366:	BOXIPLUS; case 0367 : CASE367:	BOXIDIFFERENCE; case 0370 : CASE370:  { goto op_ufn; } /* FLOATBLT */ case 0371 : CASE371:  { goto op_ufn; } /* FFTSTEP */ case 0372 : CASE372: 	MISC3(Get_BYTE(PCMAC+1)); case 0373 : CASE373: 	MISC4(Get_BYTE(PCMAC+1)); case 0374 : CASE374:  { goto op_ufn; } /* upctrace */ case 0375 : CASE375: 	SWAP; case 0376 : CASE376: 	NOP; case 0377 : CASE377: 	CLARITHEQUAL; 	 default: 	error("should not default");	FVAR_CODE_HERE;	FVARX_CODE_HERE;	 }	/* switch *//************************************************************************//*	 	NATIVE CODE INTERFACE 					*//************************************************************************//*		FORIEGN -> DISPATCH 					*//*		Return to current frame ext				*/c_ret_to_dispatch:	asm("	.globl	_c_ret_to_dispatch");	asm("_c_ret_to_dispatch:");	PCMAC = (ByteCode *) FuncObj + BCE_CURRENTFX->pc;	goto ret_to_dispatch;		/* assume optimizer will remove *//*		NATIVE -> DISPATCH 					*//*		Return to current frame ext				*/ret_to_dispatch:	asm("	.globl	_ret_to_dispatch");	asm("_ret_to_dispatch:");	RET_FROM_NATIVE;	nextop0;/*		NATIVE -> DISPATCH 					*//*		Execute opcode in current frame ext			*/ret_to_unimpl:	asm("	.globl	_ret_to_unimpl");	asm("_ret_to_unimpl:");	SaveD6 = 0x100;			/* HACK.  Reg. d6 is set to dispatch to native_check */			/* so need to do switch instead of dispatch! */	RET_FROM_NATIVE;	goto nextopcode;/*		NATIVE -> UFN(PC) 					*/ret_to_ufn:	asm("	.globl	_ret_to_ufn");	asm("_ret_to_ufn:");	RET_FROM_NATIVE;	goto op_ufn;/*		DISPATCH -> NATIVE? 					*//*		Return to current frame ext?				*/	native_check:	SaveD6 = 0;	NATIVE_NEXTOP0;/*		NATIVE -> TIMER						*//*		Return to Execute timer interrupt			*/ret_to_timer:	asm("_ret_to_timer:");	asm("	.globl	_ret_to_timer");	SaveD6 = 0x100;	RET_FROM_NATIVE;	goto check_interrupt;	/* assume optimizer will remove *./************************************************************************//*		TIMER INTERRUPT CHECK ROUTINE				*//************************************************************************/check_interrupt:	 if ( (int)CSTKPTR > (int)EndSTKP )		{printf("REAL STK OVERFLOW\n Current = 0x%x\n EndSTKP = 0x\n Irq_Stk_Check: 0x%x\n Irq_Stk_End: 0x%x\n",		CSTKPTR,EndSTKP,Irq_Stk_Check,Irq_Stk_End);		printf("PC: 0x%x, OPCODE: 0x%x\n",PCMAC,Get_BYTE(PCMAC));			error("Unrecoverable stack overflow not detected");		}	/* Check for an IRQ request */{register int need_irq = 0; static int period_cnt=60;extern int	KBDEventFlg;extern LispPTR DOBUFFEREDTRANSITION_index;extern LispPTR INTERRUPTFRAME_index;extern LispPTR *KEYBUFFERING68k;extern LispPTR *PENDINGINTERRUPT68k;extern LispPTR ATOM_STARTED;extern LispPTR *PERIODIC_INTERRUPT68k;extern LispPTR *PERIODIC_INTERRUPT_FREQUENCY68k;extern LispPTR PERIODIC_INTERRUPTFRAME_index;extern LispPTR *Reclaim_cnt_word;extern LispPTR DORECLAIM_index;extern int URaid_req;	/* Check for an Stack Overflow */re_check_stack:	if ( 	((int)(CSTKPTR+1) > Irq_Stk_Check) && 		(Irq_Stk_End > 0) && 		(Irq_Stk_Check > 0) )		{	 	 HARD_PUSH(TOPOFSTACK);		 EXT;		 if (do_stackoverflow(NIL)) {RET; CLR_IRQ; nextop0; }		 RET;		 POP;		 Irq_Stk_Check = (int)EndSTKP-STK_MIN(FuncObj);		 need_irq = (Irq_Stk_End == 0);		 Irq_Stk_End = (int) EndSTKP;		}	/* Check for an IRQ request */	if ((Irq_Stk_End <= 0) || (Irq_Stk_Check <= 0) || need_irq) {		if (StkOffset_from_68K(CSTKPTR) > InterfacePage->stackbase) {	/* Interrupts not Disabled */			EXT; CLR_IRQ;#ifndef KBINT			getsignaldata();#endif			update_timer(); 			if(URaid_req ==T){				URaid_req=NIL;				error("Call URaid by User Interrupt");			}			if((KBDEventFlg>0)&&(*KEYBUFFERING68k==ATOM_T)){				*KEYBUFFERING68k= ATOM_STARTED;				cause_interruptcall(DOBUFFEREDTRANSITION_index);				KBDEventFlg --;			}			else if(*Reclaim_cnt_word == S_POSITIVE)				{  					*Reclaim_cnt_word=NIL;					cause_interruptcall(DORECLAIM_index);				}			else if(*PENDINGINTERRUPT68k!=NIL)				{ 					cause_interruptcall(INTERRUPTFRAME_index);					*PENDINGINTERRUPT68k=NIL;				}			else if(*PERIODIC_INTERRUPT68k!=NIL)				{					if(period_cnt>0)  period_cnt--;					else 					{						cause_interruptcall(PERIODIC_INTERRUPTFRAME_index);						if(*PERIODIC_INTERRUPT_FREQUENCY68k==NIL)							period_cnt=0;						else							period_cnt=(*PERIODIC_INTERRUPT_FREQUENCY68k & 0xffff) -1;					}				}			RET;		} else {			/* Clear out IRQ (loses pending interrupt request 			   if interrupts are disabled) */			CLR_IRQ;			goto re_check_stack;			}		}}	nextop0;/************************************************************************//* Common Jump Tails (they have to jump anyway, so use common Tail) *//************************************************************************/PopNextop1:	POP; 	nextop1;PopNextop2:	POP; 	nextop2;#ifdef OPDISP setup_table:	SaveD6 = 0;	Save_D5_shift_amount = 15;	{int i; for (i = 0; i < 256; i++) { table[i] = (InstPtr) op_ufn; };}	{int i; for (i = 256; i < 512; i++) 		{ table[i] = (InstPtr) native_check; };	}	table[001] = (InstPtr) case001;	table[002] = (InstPtr) case002;	table[003] = (InstPtr) case003;	table[004] = (InstPtr) case004;	table[005] = (InstPtr) case005;	table[006] = (InstPtr) case006;	table[007] = (InstPtr) case007;	table[010] = (InstPtr) case010;	table[011] = (InstPtr) case011;	table[012] = (InstPtr) case012;	table[013] = (InstPtr) case013;	table[014] = (InstPtr) case014;	table[015] = (InstPtr) case015;	table[016] = (InstPtr) case016;	table[017] = (InstPtr) case017;	table[020] = (InstPtr) case020;	table[021] = (InstPtr) case021;	table[022] = (InstPtr) case022;	table[023] = (InstPtr) case023;	table[024] = (InstPtr) case024;	table[025] = (InstPtr) case025;	table[026] = (InstPtr) case026;	table[027] = (InstPtr) case027;	table[030] = (InstPtr) case030;	table[031] = (InstPtr) case031;	table[032] = (InstPtr) case032;	table[033] = (InstPtr) case033;	table[034] = (InstPtr) case034;	table[035] = (InstPtr) case035;	table[036] = (InstPtr) case036;	table[037] = (InstPtr) case037;	table[040] = (InstPtr) case040;	table[041] = (InstPtr) case041;	table[042] = (InstPtr) case042;	table[043] = (InstPtr) case043;	table[044] = (InstPtr) case044;	table[045] = (InstPtr) case045;	table[046] = (InstPtr) case046;	table[047] = (InstPtr) case047;	table[054] = (InstPtr) case054;	table[055] = (InstPtr) case055;	table[056] = (InstPtr) case056;	table[057] = (InstPtr) case057;	table[062] = (InstPtr) case062;	table[063] = (InstPtr) case063;	table[072] = (InstPtr) case072;	table[073] = (InstPtr) case073;	table[074] = (InstPtr) case074;	table[075] = (InstPtr) case075;	table[0100] = (InstPtr) case100;	table[0101] = (InstPtr) case101;	table[0102] = (InstPtr) case102;	table[0103] = (InstPtr) case103;	table[0104] = (InstPtr) case104;	table[0105] = (InstPtr) case105;	table[0106] = (InstPtr) case106;	table[0107] = (InstPtr) case107;	table[0110] = (InstPtr) case110;	table[0111] = (InstPtr) case111;	table[0112] = (InstPtr) case112;	table[0113] = (InstPtr) case113;	table[0114] = (InstPtr) case114;	table[0115] = (InstPtr) case115;	table[0116] = (InstPtr) case116;	table[0117] = (InstPtr) case117;	table[0120] = (InstPtr) case120;	table[0121] = (InstPtr) case121;	table[0122] = (InstPtr) case122;	table[0123] = (InstPtr) case123;	table[0124] = (InstPtr) case124;	table[0125] = (InstPtr) case125;	table[0126] = (InstPtr) case126;	table[0127] = (InstPtr) case127;	table[0130] = (InstPtr) case130;	table[0131] = (InstPtr) case131;	table[0132] = (InstPtr) case132;	table[0133] = (InstPtr) case133;	table[0134] = (InstPtr) case134;	table[0135] = (InstPtr) case135;	table[0136] = (InstPtr) case136;	table[0137] = (InstPtr) case137;	table[0140] = (InstPtr) case140;	table[0141] = (InstPtr) case141;	table[0142] = (InstPtr) case142;	table[0143] = (InstPtr) case143;	table[0144] = (InstPtr) case144;	table[0145] = (InstPtr) case145;	table[0146] = (InstPtr) case146;	table[0147] = (InstPtr) case147;	table[0150] = (InstPtr) case150;	table[0151] = (InstPtr) case151;	table[0152] = (InstPtr) case152;	table[0153] = (InstPtr) case153;	table[0154] = (InstPtr) case154;	table[0155] = (InstPtr) case155;	table[0156] = (InstPtr) case156;	table[0157] = (InstPtr) case157;	table[0160] = (InstPtr) case160;	table[0161] = (InstPtr) case161;	table[0162] = (InstPtr) case162;	table[0163] = (InstPtr) case163;	table[0164] = (InstPtr) case164;	table[0165] = (InstPtr) case165;	table[0166] = (InstPtr) case166;	table[0167] = (InstPtr) case167;	table[0170] = (InstPtr) case170;	table[0171] = (InstPtr) case171;	table[0172] = (InstPtr) case172;	table[0173] = (InstPtr) case173;	table[0174] = (InstPtr) case174;	table[0175] = (InstPtr) case175;	table[0176] = (InstPtr) case176;	table[0177] = (InstPtr) case177;	table[0200] = (InstPtr) case200;	table[0201] = (InstPtr) case201;	table[0202] = (InstPtr) case202;	table[0203] = (InstPtr) case203;	table[0204] = (InstPtr) case204;	table[0205] = (InstPtr) case205;	table[0206] = (InstPtr) case206;	table[0207] = (InstPtr) case207;	table[0210] = (InstPtr) case210;	table[0211] = (InstPtr) case211;	table[0212] = (InstPtr) case212;	table[0213] = (InstPtr) case213;	table[0214] = (InstPtr) case214;	table[0215] = (InstPtr) case215;	table[0216] = (InstPtr) case216;	table[0217] = (InstPtr) case217;	table[0220] = (InstPtr) case220;	table[0221] = (InstPtr) case221;	table[0222] = (InstPtr) case222;	table[0223] = (InstPtr) case223;	table[0224] = (InstPtr) case224;	table[0225] = (InstPtr) case225;	table[0226] = (InstPtr) case226;	table[0227] = (InstPtr) case227;	table[0230] = (InstPtr) case230;	table[0231] = (InstPtr) case231;	table[0232] = (InstPtr) case232;	table[0233] = (InstPtr) case233;	table[0234] = (InstPtr) case234;	table[0235] = (InstPtr) case235;	table[0236] = (InstPtr) case236;	table[0237] = (InstPtr) case237;	table[0240] = (InstPtr) case240;	table[0241] = (InstPtr) case241;	table[0242] = (InstPtr) case242;	table[0243] = (InstPtr) case243;	table[0244] = (InstPtr) case244;	table[0245] = (InstPtr) case245;	table[0246] = (InstPtr) case246;	table[0247] = (InstPtr) case247;	table[0250] = (InstPtr) case250;	table[0251] = (InstPtr) case251;	table[0252] = (InstPtr) case252;	table[0253] = (InstPtr) case253;	table[0254] = (InstPtr) case254;	table[0255] = (InstPtr) case255;	table[0256] = (InstPtr) case256;	table[0257] = (InstPtr) case257;	table[0260] = (InstPtr) case260;	table[0261] = (InstPtr) case261;	table[0262] = (InstPtr) case262;	table[0263] = (InstPtr) case263;	table[0264] = (InstPtr) case264;	table[0265] = (InstPtr) case265;	table[0266] = (InstPtr) case266;	table[0267] = (InstPtr) case267;	table[0270] = (InstPtr) case270;	table[0271] = (InstPtr) case271;	table[0272] = (InstPtr) case272;	table[0273] = (InstPtr) case273;	table[0274] = (InstPtr) case274;	table[0275] = (InstPtr) case275;	table[0276] = (InstPtr) case276;	table[0277] = (InstPtr) case277;	table[0300] = (InstPtr) case300;	table[0301] = (InstPtr) case301;	table[0302] = (InstPtr) case302;	table[0303] = (InstPtr) case303;	table[0304] = (InstPtr) case304;	table[0305] = (InstPtr) case305;	table[0306] = (InstPtr) case306;	table[0307] = (InstPtr) case307;	table[0310] = (InstPtr) case310;	table[0311] = (InstPtr) case311;	table[0312] = (InstPtr) case312;	table[0313] = (InstPtr) case313;	table[0314] = (InstPtr) case314;	table[0315] = (InstPtr) case315;	table[0316] = (InstPtr) case316;	table[0317] = (InstPtr) case317;	table[0320] = (InstPtr) case320;	table[0321] = (InstPtr) case321;	table[0322] = (InstPtr) case322;	table[0323] = (InstPtr) case323;	table[0324] = (InstPtr) case324;	table[0325] = (InstPtr) case325;	table[0326] = (InstPtr) case326;	table[0327] = (InstPtr) case327;	table[0330] = (InstPtr) case330;	table[0331] = (InstPtr) case331;	table[0332] = (InstPtr) case332;	table[0333] = (InstPtr) case333;	table[0334] = (InstPtr) case334;	table[0335] = (InstPtr) case335;	table[0336] = (InstPtr) case336;	table[0337] = (InstPtr) case337;	table[0340] = (InstPtr) case340;	table[0341] = (InstPtr) case341;	table[0342] = (InstPtr) case342;	table[0343] = (InstPtr) case343;	table[0344] = (InstPtr) case344;	table[0345] = (InstPtr) case345;	table[0346] = (InstPtr) case346;	table[0347] = (InstPtr) case347;	table[0350] = (InstPtr) case350;	table[0351] = (InstPtr) case351;	table[0352] = (InstPtr) case352;	table[0353] = (InstPtr) case353;	table[0354] = (InstPtr) case354;	table[0355] = (InstPtr) case355;	table[0356] = (InstPtr) case356;	table[0357] = (InstPtr) case357;	table[0360] = (InstPtr) case360;	table[0361] = (InstPtr) case361;	table[0362] = (InstPtr) case362;	table[0363] = (InstPtr) case363;	table[0364] = (InstPtr) case364;	table[0365] = (InstPtr) case365;	table[0366] = (InstPtr) case366;	table[0367] = (InstPtr) case367;	table[0370] = (InstPtr) case370;	table[0371] = (InstPtr) case371;	table[0372] = (InstPtr) case372;	table[0373] = (InstPtr) case373;	table[0374] = (InstPtr) case374;	table[0375] = (InstPtr) case375;	table[0376] = (InstPtr) case376;	table[0377] = (InstPtr) case377;     goto nextopcode;#endif     }int retfun() {return(0);}do_brk() {}