/* This is G-file @(#) loadsysout.c Version 2.6 (7/27/88). copyright Xerox & Fuji Xerox  */static char *id = "@(#) loadsysout.c	2.6 7/27/88";/* *	loadsysout.c */#include <stdio.h>#include <sys/file.h>#include <sys/types.h>#include <sys/stat.h>#include <errno.h>#include "machineconfig.h"#include "lispemul.h"#include "lispmap.h"#include "lispglobal.h"#include "ifpage.h"#define	IFPAGE_ADDRESS	512#define MBYTE	0x100000 /* 1 Mbyte */extern int	errno;sysout_loader(sysout_file_name, sys_size)char	*sysout_file_name;int	sys_size;   /* sysout size in megabytes */{    int             sysout;	/* SysoutFile descriptor */    char           *malloc();	/* malloc() */    char           *valloc();	/* valloc() */    IFPAGE         ifpage;	/* IFPAGE */    char           *fptovp_scratch;	/* scratch area for FPTOVP */    DLword         fptovp[0x10000];	/* FPTOVP */    long           fptovp_offset;	/* FPTOVP start offset */    char           *lispworld_scratch;	/* scratch area for lispworld */    long            lispworld_offset;	/* lispworld offset */    unsigned        sysout_size;/* sysout size in page */    struct stat     stat_buf;	/* file stat buf */    int             i, vp;    int             machinetype;    machinetype = 0;    /* allocate Virtual Memory Space */    lispworld_scratch = valloc(sys_size * MBYTE);    if (lispworld_scratch == NULL) {		fprintf(stderr,"sysout_loader: can't allocate Lisp %dMBytes VM \n",									   sys_size);		exit(-1);    }    /* now you can access lispworld */    Lisp_world = (DLword *) lispworld_scratch;#ifdef  DEBUG    printf("VM allocated = 0x%x at 0x%x\n",sys_size * MBYTE,lispworld_scratch);    printf("Native Load Address = 0x%x\n",native_load_address);#endif    /*     * first read the IFPAGE(InterfacePage)      */    /* open SysoutFile */    sysout = open(sysout_file_name, O_RDONLY, NULL);    if (sysout == -1) {	printf("sysout_loader: can't open SysoutFile");	exit(-1);    }    /* seek to IFPAGE */    if (lseek(sysout, IFPAGE_ADDRESS, 0) == -1) {	printf("sysout_loader: can't seek to IFPAGE");	exit(-1);    }    /* reads IFPAGE into scratch_page */    if (read(sysout, &ifpage, sizeof(IFPAGE)) == -1) {	printf("sysout_loader: can't read IFPAGE");	exit(-1);    }    /*     * get FPTOVP location and SysoutFile size      */    /* get FPTOVP location from IFPAGE */    fptovp_offset = ifpage.fptovpstart;#ifdef  DEBUG    printf("FPTOVP Location %d \n", fptovp_offset);#endif    /* get sysout file size in halfpage(256) */    if (fstat(sysout, &stat_buf) == -1) {	printf("sysout_loader: can't get SysoutFile size");	exit(-1);    }    sysout_size = stat_buf.st_size / BYTESPER_PAGE * 2;#ifdef  DEBUG    printf("sysout size / 2 = 0x%x\n", sysout_size / 2);    printf("vmem size = 0x%x\n", ifpage.nactivepages);#endif	/* do some simple checks to see if this is really a sysout */	if(ifpage.key != IFPAGE_KEYVAL) {		printf("sysout_loader: %s isn't a sysout:\nkey is %x, should be %x\n",						sysout_file_name, ifpage.key, IFPAGE_KEYVAL);		exit(1);	}    machinetype = ifpage.machinetype;    if(( stat_buf.st_size & 0x1ff) != 0)		printf("CAUTION::sysout & 0x1ff = 0x%x \n", stat_buf.st_size & BYTESPER_PAGE);	if(ifpage.nactivepages != ( sysout_size /2) ) {		printf("sysout_loader:IFPAGE says sysout size is %d \n",ifpage.nactivepages);		printf("But,sysout size from UNIX is %d \n",sysout_size /2);		exit(-1); 	 }    /*     * Now get FPTOVP      */    /* seek to FPTOVP */    fptovp_offset = (fptovp_offset - 1) * BYTESPER_PAGE + 2;    if (lseek(sysout, fptovp_offset, 0) == -1) {		mess_reset();	printf("sysout_loader: can't seek to FPTOVP");	exit(-1);    }    /* read FPTOVP */    if (read(sysout, fptovp, sysout_size) == -1) {		mess_reset();	printf("sysout_loader: can't read FPTOVP");	printf("%d\n", errno);	exit(-1);    }    /*     * Last Build the Lisp VM      */#ifdef MEDLEY    init_display(DISPALY_OFFSET, 65536 * 16 * 2);#else    init_display(DISPALY_OFFSET, 65536 * 16);#endif    /* read SysoutFile to lispworld */    for (i = 0; i < (sysout_size / 2); i++) {	if (fptovp[i] != 0177777) {	    if (lseek(sysout, i * BYTESPER_PAGE, 0) == -1) {		mess_reset();		printf("sysout_loader: can't seek SysoutFile");		exit(-1);	    };	    lispworld_offset = fptovp[i] * BYTESPER_PAGE;	    if (read(sysout, lispworld_scratch + lispworld_offset, BYTESPER_PAGE) == -1) {		mess_reset();		printf("sysout_loader: can't read SysoutFile at %d", i);		exit(-1);	    };	};    }#ifdef  DEBUG    printf("SysoutFile is read completely.\n");#endif    close(sysout);	}