/* @(#) DoRing.c Version 1.1 (3/1/90). copyright venue & Fuji Xerox  */static char *id = "@(#) DoRing.c	1.1 3/1/90	(venue & Fuji Xerox)";/**** Copyright (C) 1988 by Fuji Xerox co.,Ltd. All rights reserved.**		Author: Mitsunori Matsuda*		Date  : September 19, 1988*/#include <stdio.h>#include <sys/time.h>#include "lispemul.h"#define MAXKEYEVENT    4589#define MINKEYEVENT       2#define KEYEVENTSIZE     12#define KB_ALLUP     0xFFFF#define RING_READ(head68k)  (((RING*)(head68k))->read)#define RING_WRITE(head68k) (((RING*)(head68k))->write)#define RCLK(place) { struct timeval time; \			gettimeofday(&time,NULL); \			(place)=(time.tv_sec * 1000000)+time.tv_usec;}typedef struct {	DLword read;	DLword write;} RING;typedef struct {	DLword   W0;	DLword   W1;	DLword   W2;	DLword   W3;	DLword   WU;	DLword   W4;	DLword   W5;	int      time;	unsigned mousestate :3;	unsigned shift1     :1;	unsigned shift2     :1;	unsigned lock       :1;	unsigned ctrl       :1;	unsigned meta       :1;	unsigned font       :1;	unsigned usermode1  :1;	unsigned usermode2  :1;	unsigned usermode3  :1;	unsigned nil        :4;	DLword   mousex;	DLword   mousey;} KBEVENT;extern DLword *EmKbdAd068K	    , *EmKbdAd168K	    , *EmKbdAd268K	    , *EmKbdAd368K	    , *EmKbdAd468K	    , *EmKbdAd568K	    , *EmRealUtilin68K;extern DLword *CTopKeyevent;extern LispPTR *KEYBUFFERING68k;extern int URaid_req	 , KBDEventFlg;DoRing(){#ifdef TRACE	printf( "TRACE: DoRing()\n" );#endif	DLword w	     , r;	KBEVENT *kbevent;do_ring:	if(((*EmKbdAd268K) & 2113) == 0)	 {/*Ctrl-shift-NEXT*/		error("******  EMERGENCY Interrupt ******");		*EmKbdAd268K=KB_ALLUP; /*reset*/		((RING*)CTopKeyevent)->read=0;  /* reset queue */		((RING*)CTopKeyevent)->write=MINKEYEVENT; 		/*return(0);*/	 } 	else if(((*EmKbdAd268K) & 2114) == 0)	     { /* Ctrl-Shift-DEL */		*EmKbdAd268K=KB_ALLUP; /*reset*/		URaid_req=T;		((RING*)CTopKeyevent)->read=0;  /* reset queue */		((RING*)CTopKeyevent)->write=MINKEYEVENT; 		/*return(0);*/	     }	     #ifdef OS4_TYPE4BUG	else if(((*EmKbdAd268K) & 2120) == 0)	     { /* Ctrl-Shift-Return */		*EmKbdAd268K=KB_ALLUP; /*reset*/		URaid_req=T;		((RING*)CTopKeyevent)->read=0;  /* reset queue */		((RING*)CTopKeyevent)->write=MINKEYEVENT; 		     }#endif	r=RING_READ(CTopKeyevent);	w=RING_WRITE(CTopKeyevent);	if(r==w) /* event queqe FULL */		goto KBnext;	kbevent=(KBEVENT*)(CTopKeyevent+ w);#ifndef BYTESWAP	RCLK(kbevent->time);#else		RCLK(kbevent->time_hi, kbevent->time_lo);#endif BYTESWAP	kbevent->W0= *EmKbdAd068K;	kbevent->W1= *EmKbdAd168K;	kbevent->W2= *EmKbdAd268K;	kbevent->W3= *EmKbdAd368K;	kbevent->W4= *EmKbdAd468K;	kbevent->W5= *EmKbdAd568K;	kbevent->WU= *EmRealUtilin68K;	if(r==0) /* Queue was empty */		((RING*)CTopKeyevent)->read=w;	if(w >= MAXKEYEVENT)		((RING*)CTopKeyevent)->write = MINKEYEVENT;	else		((RING*)CTopKeyevent)->write = w + KEYEVENTSIZE;  KBnext:	if(*KEYBUFFERING68k ==NIL)		*KEYBUFFERING68k=ATOM_T;} 