(DEFINE-FILE-INFO READTABLE "INTERLISP" PACKAGE "INTERLISP")(FILECREATED " 5-Feb-97 11:58:04" {DSK}<project>medley2.1>library>UFSNFS.;2 18290        changes to%:  (RECORDS UFSGENFILESTATE)      previous date%: " 3-May-93 22:03:16" {DSK}<project>medley2.1>library>UFSNFS.;1)(* ; "Copyright (c) 1991, 1992, 1993, 1997 by Xerox Corporation.  All rights reserved.")(PRETTYCOMPRINT UFSNFSCOMS)(RPAQQ UFSNFSCOMS       [(FNS \UFS.ADJUST.HOST \UFS.TILDE \UFS.UNPACKFILENAME \UFS.FIX.SLASHES \UFS.FULLNAME              \DSK.HOME.DIR \UFSNFS.HOSTNAMEP \MAKE.UFSNFS.DEVICE)        (P (MOVD? 'CL:STRING-DOWNCASE 'NFS::DOWNCASE-UNQUOTED-CHARS))        (COMS                                                (* ;                   "Need this only because some bozo changed the call to \UFS.FULLNAME to be inline")              (FNS \UFS.NEXTFILEFN)              (DECLARE%: DONTCOPY (RECORDS UFSGENFILESTATE))              (INITRECORDS UFSGENFILESTATE)              (SYSRECORDS UFSGENFILESTATE))        (INITVARS (*NFS-HACK-ENABLED* T)               (*NFS-USE-SLASHES* NIL)               (*NFS-NET-DESIGNATOR* "net")               (*UFS-USER-HOMES*))        (ADDVARS (\SYSTEMCACHEVARS *UFS-USER-HOMES*))        (DECLARE%: EVAL@COMPILE DOCOPY [P (CL:PROCLAIM '(CL:SPECIAL *NFS-HACK-ENABLED*                                                                *NFS-USE-SLASHES*                                                                *DSK-UPPER-CASE-FILE-NAMES*))                                          (CL:PROCLAIM '(GLOBAL *NFS-NET-DESIGNATOR*))                                          [MAPC '(\UFS.REMOVE.HOST.FIELD \UFSDirectoryNameP                                                         \UFSGenerateFiles)                                                (FUNCTION (LAMBDA (FN)                                                                 (CHANGENAME FN                                                                         'UNPACKFILENAME.STRING                                                                        '\UFS.UNPACKFILENAME]                                          (MAPC '(\UFSGetFileInfo \UFSSetFileInfo)                                                (FUNCTION (LAMBDA (FN)                                                                 (CHANGENAME FN '\UFS.FULLNAME                                                                        '\UFS.ADD.HOST.FIELD]               DONTCOPY                                                             (* ; "From UFS")               (GLOBALVARS \DSKtopMonitor \DSK.DEFAULT.DIRECTORY \UFS.DEFAULT.DIRECTORY                       *UFS-USER-HOMES*)               (CONSTANTS (RECOG-NON 5)                      (MAX-PATHNAME-LEN 256))               (MACROS \UFS.DEFAULT.DIR DSKP))        (DECLARE%: DONTEVAL@LOAD DOCOPY (P (\MAKE.UFSNFS.DEVICE])(DEFINEQ(\UFS.ADJUST.HOST
(LAMBDA (FIELDS) (* ; "Edited 15-Mar-91 14:56 by bvm") (LET (HOST) (if (AND *NFS-HACK-ENABLED* (SETQ HOST (LISTGET FIELDS (QUOTE HOST)))) then (LET ((HOSTLEN (NCHARS HOST)) (DIR (LISTGET FIELDS (QUOTE DIRECTORY))) DIRLEN REALHOST GENERICP) (if (OR (SETQ GENERICP (STRING-EQUAL HOST "NFS")) (AND (EQL (CL:CHAR HOST (- HOSTLEN 2)) #\/) (FMEMB (CL:CHAR HOST (- HOSTLEN 1)) (QUOTE (#\N #\n))))) then (* ;; "Change {pooh/n}<stuff> into {dsk}<net>pooh>stuff>.  Note that it is very important that we lowercase the hostname here, otherwise file recognition takes forever!") (SETQ DIR (if (AND DIR (> (SETQ DIRLEN (NCHARS DIR)) 0)) then (* ; "There is a dir to play with") (SETQ DIR (\UFS.FIX.SLASHES DIR)) (LET ((DIRSTART 0) DIREND HOME VOLEND FOUND) (if (EQ (CL:CHAR DIR 0) #\~) then (* ; "Home dir spec") (SETQ GENERICP T) (* ; "We assume that all ~ names want to ignore the actual host given.  This will let ~fred work when fred's home is /net/...") (SETQ DIREND (CL:POSITION #\> DIR)) (if (SETQ HOME (if (OR (< DIRLEN 2) (EQ DIREND 1)) then (* ; "Naked ~ means logged in home dir") (\DSK.HOME.DIR) else (\UFS.TILDE (SUBSTRING DIR 2 DIREND)))) then (SETQ DIR (if (OR (NULL DIREND) (EQ DIREND (SUB1 DIRLEN))) then (* ; "top level of home dir") HOME else (CONCAT HOME (SUBSTRING DIR (ADD1 DIREND) (if (EQ (CL:CHAR DIR (SUB1 DIRLEN)) #\>) then (* ; "No longer relative") (SUB1 DIRLEN) else DIRLEN))))) (SETQ DIRSTART 1))) (SETQ VOLEND (CL:POSITION #\> DIR :START DIRSTART)) (if (EQ VOLEND DIRSTART) then (* ; "%"/%"") "" elseif (AND (OR GENERICP NFS:*USE-VOLUME-MAP*) (SETQ FOUND (NFS:FIND-VOLUME (SUBSTRING DIR (ADD1 DIRSTART) VOLEND)))) then (* ; "Returned (host . path).") (SETQ REALHOST (CAR FOUND)) (LET ((NEWPATH (\UFS.FIX.SLASHES (CDR FOUND)))) (if VOLEND then (CONCAT NEWPATH (SUBSTRING DIR (ADD1 VOLEND))) else NEWPATH)) elseif (EQ DIRSTART 0) then (* ; "Need to get a / in here") (CONCAT ">" DIR) else DIR)) else (* ; "No dir") "")) (LISTPUT FIELDS (QUOTE DIRECTORY) (if (AND GENERICP (NOT REALHOST)) then (* ; "Treat {nfs}<xxx> like {dsk}<xxx> if we couldn't find the volume") (SUBSTRING DIR 2) else (CONCAT *NFS-NET-DESIGNATOR* ">" (OR REALHOST (L-CASE (SUBSTRING HOST 1 (- HOSTLEN 2)))) DIR))) (LISTPUT FIELDS (QUOTE HOST) (QUOTE DSK)))))) FIELDS)
)(\UFS.TILDE
(LAMBDA (UNAME) (* ; "Edited 15-Mar-91 14:55 by bvm") (LET ((VALUE (CL:ASSOC UNAME *UFS-USER-HOMES* :TEST (QUOTE STRING-EQUAL)))) (if (NOT VALUE) then (SETQ VALUE (CONS UNAME (CL:MULTIPLE-VALUE-BIND (UID GID HOMEDIR) (YP:GET-UID UNAME) (AND HOMEDIR (if (EQ (CL:CHAR HOMEDIR 0) #\/) then (CONCAT "<" (CL:SUBSTITUTE #\> #\/ (SUBSTRING HOMEDIR 2))) else (CL:SUBSTITUTE #\> #\/ HOMEDIR)))))) (push *UFS-USER-HOMES* VALUE)) (CDR VALUE)))
)(\UFS.UNPACKFILENAME
(LAMBDA (NAME FIELD FLG) (* ; "Edited 14-Mar-91 20:48 by vanmelle") (* ;; "Effectively to %"advise%" UNPACKFILENAME.STRING in some functions") (if (AND FIELD (NEQ FIELD (QUOTE DIRECTORY))) then (UNPACKFILENAME.STRING NAME FIELD FLG) else (LET ((VALUE (\UFS.ADJUST.HOST (UNPACKFILENAME.STRING NAME)))) (if FIELD then (* ; "Fetch just this field") (LISTGET VALUE FIELD) else VALUE))))
)(\UFS.FIX.SLASHES
(LAMBDA (NAME) (* ; "Edited 14-Mar-91 20:09 by bvm") (if (CL:POSITION #\/ NAME) then (CL:SUBSTITUTE #\> #\/ NAME) else NAME))
)(\UFS.FULLNAME
  [LAMBDA (NAME DEV ATOMP DIRPREFIX)                     (* ; "Edited  3-May-93 22:02 by rmk:")
                                                             (* ; 
                                                           "Edited 14-Mar-91 21:00 by vanmelle")
    (if NAME
        then                                             (* ; "Pass NIL thru transparently")
              (LET ((DEVNAME (fetch (FDEV DEVICENAME) of DEV))
                    (FIRSTPART (OR DIRPREFIX NAME))
                    RESTPOS)
                   (SETQ NAME
                    (if (AND (EQ DEVNAME 'DSK)
                                 *NFS-HACK-ENABLED*
                                 (STRPOS *NFS-NET-DESIGNATOR* FIRSTPART 2 NIL T NIL UPPERCASEARRAY)
                                 (SELCHARQ (NTHCHARCODE FIRSTPART (SETQ RESTPOS (+ (NCHARS 
                                                                                 *NFS-NET-DESIGNATOR*
                                                                                          )
                                                                                   2)))
                                      ((/ >) 
                                           T)
                                      NIL))
                        then (LET [(HOSTEND (STRPOSL (CHARCODE (/ >))
                                                       FIRSTPART
                                                       (CL:INCF RESTPOS]
                                      (CONCAT "{" (SUBSTRING FIRSTPART RESTPOS (AND HOSTEND
                                                                                    (SUB1 HOSTEND)))
                                             "/n}"
                                             [if (NOT HOSTEND)
                                                 then ""
                                               elseif (NOT (STRPOSL (CHARCODE (/ >))
                                                                      FIRSTPART
                                                                      (ADD1 HOSTEND)))
                                                 then    (* ; 
      "No further directory, i.e. this is root on the remote file system.  Thus, make NO directory")
                                                       (OR (SUBSTRING FIRSTPART (ADD1 HOSTEND))
                                                           "")
                                               elseif *NFS-USE-SLASHES*
                                                 then    (* ; "Leave as is")
                                                       (SUBSTRING FIRSTPART HOSTEND)
                                               else      (* ; "Convert to <> syntax")
                                                     (CONCAT "<" (\UFS.FIX.SLASHES
                                                                  (SUBSTRING FIRSTPART (ADD1 HOSTEND]
                                             (if DIRPREFIX
                                                 then NAME
                                               else "")))
                      elseif DIRPREFIX
                        then (CONCAT "{" DEVNAME "}" DIRPREFIX NAME)
                      else (CONCAT "{" DEVNAME "}" NAME)))
                   (if (AND (EQ DEVNAME 'DSK)
                                *DSK-UPPER-CASE-FILE-NAMES*)
                       then 

                             (* ;; 
                    "Following comment is in the lispcore source, last edited 4-May-90 11:07 by nm")

                             (* ;; "DSK code uses *DSK-UPPER-CASE-FILE-NAMES* instead of *UPPER-CASE-FILE-NAMES*.  I think the capability of case insensitive file recognition in Medley-S {DSK} device is essentially optional and implemented only to keep the compatibility with D-Machines.  Actually the case insensitive file recognition is significantly slower than on the correct case (AR 11074).  There is no reasonable way to solve this problem because the underlying UNIX file ysystem is case sensitive. Thus, I introduced the new parameter *DSK-UPPER-CASE-FILE-NAMES* with its default value NIL.")

                             (SETQ NAME (U-CASE NAME)))
                   (if ATOMP
                       then (MKATOM NAME)
                     else NAME])(\DSK.HOME.DIR
(LAMBDA NIL (* ; "Edited 14-Mar-91 20:21 by bvm") (* ;; "Returns the expansion of %"~/%".  Leaves off the trailing / to be consistent with the values in yppasswd.") (WITH.MONITOR \DSKtopMonitor (LET ((NAMEAREA (ALLOCSTRING MAX-PATHNAME-LEN)) RVAL) (AND (FIXP (SETQ RVAL (\DSKGetFileName-C \DSK.DEFAULT.DIRECTORY RECOG-NON NAMEAREA (CREATECELL \FIXP)))) (SUBSTRING NAMEAREA 1 (SUB1 RVAL))))))
)(\UFSNFS.HOSTNAMEP
(LAMBDA (HOST) (* ; "Edited  6-Apr-89 11:27 by bvm") (if (AND (EQ \MACHINETYPE \MAIKO) *NFS-HACK-ENABLED* (OR (EQ HOST (QUOTE NFS)) (AND (EQ (NTHCHARCODE HOST -2) (CHARCODE /)) (FMEMB (NTHCHARCODE HOST -1) (CHARCODE (N n)))))) then (\GETDEVICEFROMNAME (QUOTE DSK) T)))
)(\MAKE.UFSNFS.DEVICE
(LAMBDA NIL (* ; "Edited 28-Feb-89 12:58 by bvm") (\DEFINEDEVICE NIL (create FDEV DEVICENAME _ "UFSNFS" EVENTFN _ (FUNCTION NILL) HOSTNAMEP _ (FUNCTION \UFSNFS.HOSTNAMEP))))
))(MOVD? 'CL:STRING-DOWNCASE 'NFS::DOWNCASE-UNQUOTED-CHARS)(* ; "Need this only because some bozo changed the call to \UFS.FULLNAME to be inline")(DEFINEQ(\UFS.NEXTFILEFN
(LAMBDA (GENFILESTATE NAMEONLY) (* ; "Edited 14-Mar-91 21:04 by vanmelle") (LET* ((FINFOID (fetch (UFSGENFILESTATE FINFOID) of GENFILESTATE)) (FILEID (fetch (UFSGENFILESTATE FILEID) of GENFILESTATE)) (ERRNO (LOCF (fetch (UFSGENFILESTATE ERRONO) of GENFILESTATE))) FILENAME NAMELEN NEWNAME) (AND (> FINFOID -1) (< FILEID (fetch (UFSGENFILESTATE TOTALNUM) of GENFILESTATE)) (CL:UNWIND-PROTECT (if (> (SETQ NAMELEN (\UFSNextFile-C GENFILESTATE)) 0) then (replace (UFSGENFILESTATE THISFILE) of GENFILESTATE with (SETQ FILENAME (\UFS.FULLNAME (SETQ NEWNAME (CL:SUBSEQ (fetch (UFSGENFILESTATE NAME) of GENFILESTATE) 0 NAMELEN)) (fetch (UFSGENFILESTATE DEV) of GENFILESTATE) NIL (fetch (UFSGENFILESTATE DIRECTORY) of GENFILESTATE)))) (if (= (add FILEID 1) (fetch (UFSGENFILESTATE TOTALNUM) of GENFILESTATE)) then (* ; "Generator exhausted. ") (\UFS.UNREGISTER.GFS GENFILESTATE T) else (replace (UFSGENFILESTATE FILEID) of GENFILESTATE with FILEID)) (if NAMEONLY then NEWNAME else FILENAME)) (AND RESETSTATE (\UFS.UNREGISTER.GFS GENFILESTATE T))))))
))(DECLARE%: DONTCOPY (DECLARE%: EVAL@COMPILE(DATATYPE UFSGENFILESTATE (                               (* ;;                    "Holds the file-directory-generator state for %"Unix%" file system enumeration.")                               (FINFOID FIXP)                               (FILEID FIXP)                 (* ;                                                      "Current file in list of 1 to TOTALNUM files.")                               (TOTALNUM FIXP)                               DIRECTORY DEV (PROPP FLAG)                               THISFILE                               (ERRONO FIXP)                               NAME                               (LENGTH FIXP)                               (WDATE FIXP)                               (RDATE FIXP)                               (PROTECTION FIXP)                               AUTHOR                               (AULEN FIXP)                               SUBGENERATORS                 (* ; "A push-down list of generators for subdirectories.  Used to generate to multiple-directory depths.")                               CURRENT-DEPTH                 (* ;                      "Current depth in the directory tree, so we can obey FILING.ENUMERATION.DEPTH")                               MAX-DEPTH                     (* ;                        "Value of FILING.ENUMERATION.DEPTH we were started with, so we can obey it.")                               )))(/DECLAREDATATYPE 'UFSGENFILESTATE       '(FIXP FIXP FIXP POINTER POINTER FLAG POINTER FIXP POINTER FIXP FIXP FIXP FIXP POINTER FIXP               POINTER POINTER POINTER)       '((UFSGENFILESTATE 0 FIXP)         (UFSGENFILESTATE 2 FIXP)         (UFSGENFILESTATE 4 FIXP)         (UFSGENFILESTATE 6 POINTER)         (UFSGENFILESTATE 8 POINTER)         (UFSGENFILESTATE 8 (FLAGBITS . 0))         (UFSGENFILESTATE 10 POINTER)         (UFSGENFILESTATE 12 FIXP)         (UFSGENFILESTATE 14 POINTER)         (UFSGENFILESTATE 16 FIXP)         (UFSGENFILESTATE 18 FIXP)         (UFSGENFILESTATE 20 FIXP)         (UFSGENFILESTATE 22 FIXP)         (UFSGENFILESTATE 24 POINTER)         (UFSGENFILESTATE 26 FIXP)         (UFSGENFILESTATE 28 POINTER)         (UFSGENFILESTATE 30 POINTER)         (UFSGENFILESTATE 32 POINTER))       '34))(/DECLAREDATATYPE 'UFSGENFILESTATE       '(FIXP FIXP FIXP POINTER POINTER FLAG POINTER FIXP POINTER FIXP FIXP FIXP FIXP POINTER FIXP               POINTER POINTER POINTER)       '((UFSGENFILESTATE 0 FIXP)         (UFSGENFILESTATE 2 FIXP)         (UFSGENFILESTATE 4 FIXP)         (UFSGENFILESTATE 6 POINTER)         (UFSGENFILESTATE 8 POINTER)         (UFSGENFILESTATE 8 (FLAGBITS . 0))         (UFSGENFILESTATE 10 POINTER)         (UFSGENFILESTATE 12 FIXP)         (UFSGENFILESTATE 14 POINTER)         (UFSGENFILESTATE 16 FIXP)         (UFSGENFILESTATE 18 FIXP)         (UFSGENFILESTATE 20 FIXP)         (UFSGENFILESTATE 22 FIXP)         (UFSGENFILESTATE 24 POINTER)         (UFSGENFILESTATE 26 FIXP)         (UFSGENFILESTATE 28 POINTER)         (UFSGENFILESTATE 30 POINTER)         (UFSGENFILESTATE 32 POINTER))       '34)(ADDTOVAR SYSTEMRECLST(DATATYPE UFSGENFILESTATE ((FINFOID FIXP)                               (FILEID FIXP)                               (TOTALNUM FIXP)                               DIRECTORY DEV (PROPP FLAG)                               THISFILE                               (ERRONO FIXP)                               NAME                               (LENGTH FIXP)                               (WDATE FIXP)                               (RDATE FIXP)                               (PROTECTION FIXP)                               AUTHOR                               (AULEN FIXP)                               SUBGENERATORS CURRENT-DEPTH MAX-DEPTH)))(RPAQ? *NFS-HACK-ENABLED* T)(RPAQ? *NFS-USE-SLASHES* NIL)(RPAQ? *NFS-NET-DESIGNATOR* "net")(RPAQ? *UFS-USER-HOMES* )(ADDTOVAR \SYSTEMCACHEVARS *UFS-USER-HOMES*)(DECLARE%: EVAL@COMPILE DOCOPY (CL:PROCLAIM '(CL:SPECIAL *NFS-HACK-ENABLED* *NFS-USE-SLASHES* *DSK-UPPER-CASE-FILE-NAMES*))(CL:PROCLAIM '(GLOBAL *NFS-NET-DESIGNATOR*))[MAPC '(\UFS.REMOVE.HOST.FIELD \UFSDirectoryNameP \UFSGenerateFiles)      (FUNCTION (LAMBDA (FN)                  (CHANGENAME FN 'UNPACKFILENAME.STRING '\UFS.UNPACKFILENAME][MAPC '(\UFSGetFileInfo \UFSSetFileInfo)      (FUNCTION (LAMBDA (FN)                  (CHANGENAME FN '\UFS.FULLNAME '\UFS.ADD.HOST.FIELD]DONTCOPY (DECLARE%: DOEVAL@COMPILE DONTCOPY(GLOBALVARS \DSKtopMonitor \DSK.DEFAULT.DIRECTORY \UFS.DEFAULT.DIRECTORY *UFS-USER-HOMES*))(DECLARE%: EVAL@COMPILE (RPAQQ RECOG-NON 5)(RPAQQ MAX-PATHNAME-LEN 256)(CONSTANTS (RECOG-NON 5)       (MAX-PATHNAME-LEN 256)))(DECLARE%: EVAL@COMPILE (PUTPROPS \UFS.DEFAULT.DIR MACRO ((DEV)                                          (SELECTQ (fetch (FDEV DEVICENAME) of DEV)                                              (DSK \DSK.DEFAULT.DIRECTORY)                                              (UNIX \UFS.DEFAULT.DIRECTORY)                                              NIL)))(PUTPROPS DSKP MACRO ((DEV)                              (EQ (fetch (FDEV DEVICENAME) of DEV)                                  'DSK)))))(DECLARE%: DONTEVAL@LOAD DOCOPY (\MAKE.UFSNFS.DEVICE))(PUTPROPS UFSNFS COPYRIGHT ("Xerox Corporation" 1991 1992 1993 1997))(DECLARE%: DONTCOPY  (FILEMAP (NIL (2871 11535 (\UFS.ADJUST.HOST 2881 . 5158) (\UFS.TILDE 5160 . 5610) (\UFS.UNPACKFILENAME 5612 . 6021) (\UFS.FIX.SLASHES 6023 . 6172) (\UFS.FULLNAME 6174 . 10622) (\DSK.HOME.DIR 10624 . 11036) (\UFSNFS.HOSTNAMEP 11038 . 11331) (\MAKE.UFSNFS.DEVICE 11333 . 11533)) (11691 12767 (\UFS.NEXTFILEFN 11701 . 12765)))))STOP