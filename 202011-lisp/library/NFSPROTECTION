(DEFINE-FILE-INFO READTABLE "INTERLISP" PACKAGE "INTERLISP")
(FILECREATED "16-Aug-89 15:14:32" {PIGLET/N}<PIGLET>VANMELLE>LISPUSERS>NFSPROTECTION;4 18943  

      changes to%:  (FNS NFSPROTECTION)

      previous date%: " 2-Aug-89 17:23:51" {PIGLET/N}<PIGLET>VANMELLE>LISPUSERS>NFSPROTECTION;3)


(* "
Copyright (c) 1989 by Xerox Corporation.  All rights reserved.
")

(PRETTYCOMPRINT NFSPROTECTIONCOMS)

(RPAQQ NFSPROTECTIONCOMS ((FNS NFSPROTECTION NFSPROT.MAKE.SUBITEM NFSPROT.ICONFN NFSPROT.HANDLE.DEPTH) (FNS NFSPROT.SHOW NFSPROT.CLEAR NFSPROT.PARSE.FILENAME NFSPROT.SET.HOST NFSPROT.CHANGE.LABEL NFSPROT.GET.FINFO NFSPROT.FETCH.ATTRIBUTE NFSPROT.LINKP) (FNS NFSPROT.APPLY NFSPROT.SET.MULTIPLE NFSPROT.SET.PROTECTION.ONE NFSPROT.SET.PROTECTION) (VARS NFSPROT.ICON) (GLOBALVARS NFSPROT.ICON) (COMS (LOCALVARS . T) (FILES (SYSLOAD) NSPROTECTION) (FNS ADD.NFSPROTECTION) (DECLARE%: DONTEVAL@LOAD DOCOPY (P (ADD.NFSPROTECTION) (ADVISE (QUOTE (FONTCOPY IN ICONW.PRINT-JUSTIFIED)) (QUOTE BEFORE) (QUOTE (COND ((EQ (FONTPROP (ARG U 1) (QUOTE DEVICE)) (QUOTE DISPLAY)) (RETURN (ARG U 1))) (T (SETARG U 3 (QUOTE DISPLAY)))))))))))
(DEFINEQ

(NFSPROTECTION
(LAMBDA NIL (* ; "Edited 16-Aug-89 15:13 by bvm") (* ;; "Main entry--create the NS protection tool main window and prompt window.") (if (EQ (MACHINETYPE) (QUOTE MAIKO)) then (PRINTOUT PROMPTWINDOW T "Sorry, NFSProtection is not implemented on Suns") else (LET* ((PLAINFONT (NSPROT.GET.FONT)) (BOLDFONT (NSPROT.GET.FONT T)) (HEIGHTDIFFERENCE (- (FONTPROP BOLDFONT (QUOTE HEIGHT)) (FONTPROP PLAINFONT (QUOTE HEIGHT)))) (PROTTYPES (QUOTE (("Owner:" "Protections that apply to file's owner
  (owner name is not settable).") ("Group:" "Protections that apply to members of file's group
  (click here to edit group)") ("World:" "Protections that apply to any other user
 (those not covered by Owner or Group)")))) (W (FREEMENU (BQUOTE ((PROPS COLUMNSPACE 14 FONT (\, BOLDFONT)) ((LABEL "Show!" SELECTEDFN NFSPROT.SHOW MESSAGE "
Show the current protection of the specified directory/file.") (LABEL "Apply!" SELECTEDFN NFSPROT.APPLY MESSAGE "Apply the indicated protections to the file,
  or to all files matching the Dir/File pattern.") (LABEL "Clear!" SELECTEDFN NFSPROT.CLEAR MESSAGE "
Set all the protection settings to neutral.") (LABEL "Depth:" LEFT 60 TYPE STATE CHANGESTATE NFSPROT.HANDLE.DEPTH INITSTATE "Infinite" MESSAGE "Enumeration depth when Dir/File is a pattern
  (this field is ignored in all other cases)" ID DEPTH LINKS (DISPLAY DEPTH-VALUE)) (LABEL "Infinite" TYPE NUMBER LIMITCHARS NSPROT.LIMITCHARS ID DEPTH-VALUE FONT (\, PLAINFONT) BOTTOM (\, HEIGHTDIFFERENCE) MAXWIDTH (\, (STRINGWIDTH "Infinite  " PLAINFONT)))) ((PROPS COLUMNSPACE (\, (+ 6 (- (STRINGWIDTH "Dir/File:" BOLDFONT) (STRINGWIDTH "Host:" BOLDFONT))))) (LABEL "Host:" TYPE EDITSTART MESSAGE "Fill in the name of the NFS file server
 (optional for well-known volumes on public servers)" LINKS (EDIT HOST)) (LABEL (\, (CONCAT)) TYPE EDIT ID HOST LIMITCHARS NSPROT.LIMITCHARS FONT (\, PLAINFONT) BOTTOM (\, HEIGHTDIFFERENCE))) ((PROPS COLUMNSPACE 6) (LABEL "Dir/File:" TYPE EDITSTART MESSAGE "
Fill in the name of the desired directory, file or pattern." LINKS (EDIT DIR)) (LABEL (\, (CONCAT)) TYPE EDIT ID DIR LIMITCHARS NSPROT.LIMITCHARS FONT (\, PLAINFONT) BOTTOM (\, HEIGHTDIFFERENCE) MAXWIDTH (\, (TIMES (CHARWIDTH (CHARCODE X) PLAINFONT) 40)))) (\,@ (for TYPE in PROTTYPES as INDEX from 6 by -3 bind (MAXWIDTH _ (MAX (STRINGWIDTH (CAAR PROTTYPES) BOLDFONT) (STRINGWIDTH (CAADR PROTTYPES) BOLDFONT) (STRINGWIDTH (CAADDR PROTTYPES) BOLDFONT))) (NAMEWIDTH _ (STRINGWIDTH "(wwwwwwww)")) collect (NFSPROT.MAKE.SUBITEM TYPE MAXWIDTH INDEX PLAINFONT (CASE INDEX (6 (* ; "Extra owner items") (BQUOTE ((LABEL "set-uid" ID 11 TYPE 3STATE BOX 1 MESSAGE "
File executes with uid set to its owner.") (LABEL (\, (CONCAT)) ID OWNER MAXWIDTH (\, NAMEWIDTH) FONT (\, PLAINFONT))))) (3 (* ; "Extra group items") (BQUOTE ((LABEL "set-gid" ID 10 TYPE 3STATE BOX 1 MESSAGE "File: executes with gid set to its group.
Directory: children inherit parent's group.") (LABEL (\, (CONCAT)) TYPE EDIT ID GROUP LIMITCHARS NSPROT.LIMITCHARS MAXWIDTH (\, NAMEWIDTH) FONT (\, PLAINFONT))))))))))) "NFS File Protection Tool")) (REG (WINDOWREGION W)) PW) (* ;; "The HEIGHTDIFFERENCE hacking is to get the baselines of the bold and plain fonts to line up (odd that they don't already).  (CONCAT) instead of %"%" to ease my pain of debugging--otherwise, the edit items would all be fat, and Lyric's Courier doesn't handle that gracefully.") (WINDOWPROP W (QUOTE FM.DONTRESHAPE) T) (WINDOWPROP W (QUOTE MINSIZE) (CONS (fetch (REGION WIDTH) of REG) (fetch (REGION HEIGHT) of REG))) (* ; "Don't let window shape any smaller than it is.") (WINDOWPROP W (QUOTE ICONFN) (FUNCTION NFSPROT.ICONFN)) (MOVEW W (GETBOXPOSITION (fetch (REGION WIDTH) of REG) (+ (fetch (REGION HEIGHT) of REG) (HEIGHTIFWINDOW (FONTPROP PLAINFONT (QUOTE HEIGHT)))))) (OPENW W) (SETQ PW (GETPROMPTWINDOW W 2 PLAINFONT)) (WINDOWPROP PW (QUOTE PAGEFULLFN) (QUOTE NSPROT.PAGEFULLFN)) (* ; "Arrange for prompt window to expand itself by one line at a time if it overflows") (WINDOWPROP W (QUOTE FM.PROMPTWINDOW) PW) NIL)))
)

(NFSPROT.MAKE.SUBITEM
(LAMBDA (LABELS MAXWIDTH INDEX PLAINFONT OTHERITEMS) (* ; "Edited  5-Jul-89 11:45 by bvm") (* ;; "Make the line in a Freemenu that has Type: Read Write Execute.  MAXWIDTH is how much space for the label, INDEX is the shift which gets you the execute bit (0 for world, 3 for Group, 6 for Owner).") (BQUOTE ((LABEL (\, (CAR LABELS)) MESSAGE (\, (CADR LABELS)) MAXWIDTH (\, MAXWIDTH) (\,@ (AND (EQ INDEX 3) (QUOTE (TYPE EDITSTART LINKS (EDIT GROUP)))))) (LABEL "Read" ID (\, (+ INDEX 2)) TYPE 3STATE BOX 1 MESSAGE "Read: User may read contents.
   (if a directory, must also have Execute to enumerate).") (LABEL "Write" ID (\, (+ INDEX 1)) TYPE 3STATE BOX 1 MESSAGE "Write: For a file: User may change contents or delete file.
   For a directory: User may create or delete files.") (LABEL "Exec | DirOp" ID (\, INDEX) TYPE 3STATE BOX 1 MESSAGE "Execute: For a file: User can execute (also implies type BINARY).
     For a directory: must be on for Read or Write bits to work.") (\,@ OTHERITEMS)))))

(NFSPROT.ICONFN
(LAMBDA (WINDOW OLDICON) (* ; "Edited  2-Aug-89 16:58 by bvm") (LET ((HOST (FM.ITEMPROP (FM.GETITEM (QUOTE HOST) NIL WINDOW) (QUOTE LABEL)))) (if (NULL HOST) then (SETQ HOST "") elseif (STRPOS "/n" HOST -2 NIL NIL NIL UPPERCASEARRAY) then (* ; "Strip /n from end") (SETQ HOST (SUBSTRING HOST 1 -3))) (if OLDICON then (ICONW.TITLE OLDICON HOST) OLDICON else (TITLEDICONW NFSPROT.ICON HOST (NSPROT.GET.FONT)))))
)

(NFSPROT.HANDLE.DEPTH
(LAMBDA (ITEM WINDOW BUTTONS) (* ; "Edited 30-Jun-89 15:35 by bvm") (if (STRING-EQUAL (FM.ITEMPROP (FM.GETITEM (QUOTE DEPTH-VALUE) NIL WINDOW) (QUOTE LABEL)) "Infinite") then "1" else "Infinite"))
)
)
(DEFINEQ

(NFSPROT.SHOW
(LAMBDA (ITEM WINDOW BUTTONS) (* ; "Edited  5-Jul-89 11:25 by bvm") (LET ((DEV&FILESPEC (NFSPROT.PARSE.FILENAME WINDOW)) FINFO DINFO) (if (AND DEV&FILESPEC (CL:MULTIPLE-VALUE-SETQ (FINFO DINFO) (DESTRUCTURING-BIND (DEV . FILESPEC) DEV&FILESPEC (if (STRPOS "*" FILESPEC) then (NSPROT.PROMPT WINDOW T "Can't show protection of a pattern") NIL else (NFSPROT.GET.FINFO WINDOW DEV FILESPEC))))) then (LET ((PROT (NFSPROT.FETCH.ATTRIBUTE FINFO DINFO (QUOTE PROTECTION)))) (for I from 0 to 11 do (OR (EQ I 9) (FM.CHANGESTATE (FM.GETITEM I NIL WINDOW) (CL:IF (ODDP PROT) T (QUOTE OFF)) WINDOW)) (SETQ PROT (LRSH PROT 1))) (NFSPROT.CHANGE.LABEL WINDOW (QUOTE OWNER) (OR (NFSPROT.FETCH.ATTRIBUTE FINFO DINFO (QUOTE AUTHOR)) "")) (NFSPROT.CHANGE.LABEL WINDOW (QUOTE GROUP) (OR (NFSPROT.FETCH.ATTRIBUTE FINFO DINFO (QUOTE GROUP)) ""))) else (* ; "Failed--clear everything") (NFSPROT.CLEAR ITEM WINDOW))))
)

(NFSPROT.CLEAR
(LAMBDA (ITEM WINDOW BUTTONS) (* ; "Edited 30-Jun-89 15:24 by bvm") (* ;; "Clear window to neutral state") (for I from 0 to 11 unless (EQ I 9) do (FM.CHANGESTATE (FM.GETITEM I NIL WINDOW) NIL WINDOW)) (NFSPROT.CHANGE.LABEL WINDOW (QUOTE OWNER) "") (NFSPROT.CHANGE.LABEL WINDOW (QUOTE GROUP) ""))
)

(NFSPROT.PARSE.FILENAME
(LAMBDA (WINDOW) (* ; "Edited 26-Jun-89 17:18 by bvm") (NSPROT.BEGIN.COMMAND WINDOW) (PROG* ((DIRITEM (FM.GETITEM (QUOTE DIR) NIL WINDOW)) (FILENAME (FM.ITEMPROP DIRITEM (QUOTE LABEL))) (HOSTITEM (FM.GETITEM (QUOTE HOST) NIL WINDOW)) (HOST (FM.ITEMPROP HOSTITEM (QUOTE LABEL))) FULLNAME HOST&FILE CANHOST DEV) (if (OR (NULL FILENAME) (EQ (NCHARS FILENAME) 0)) then (NSPROT.PROMPT WINDOW "No directory or file name was specified.") (RETURN NIL)) (if (SETQ HOST&FILE (NSPROT.STRIP.HOST FILENAME)) then (* ;; "User gave a full file name including host in the %"Dir/File%" field.  Separate them out now.") (FM.CHANGELABEL DIRITEM (SETQ FILENAME (CDR HOST&FILE)) WINDOW) (FM.CHANGELABEL HOSTITEM (SETQ HOST (CAR HOST&FILE)) WINDOW)) (if (OR (NULL HOST) (NOT (> (NCHARS HOST) 0))) then (SETQ HOST "nfs") else (if (STRPOS "/n" (SETQ CANHOST HOST) -2 NIL NIL NIL UPPERCASEARRAY) then (* ; "Strip /n from end") (SETQ CANHOST (SUBSTRING HOST 1 -3))) (if (NOT (STREQUAL HOST (SETQ HOST (L-CASE CANHOST)))) then (* ;; "Show the exact host name we're playing with") (FM.CHANGELABEL HOSTITEM HOST WINDOW))) (if (NOT (FMEMB (CHCON1 FILENAME) (CHARCODE ("/" "<")))) then (LET ((DELIM (STRPOSL (CHARCODE ("/" "<")) FILENAME 2))) (SETQ FILENAME (CONCAT (COND ((AND DELIM (EQ (NTHCHARCODE FILENAME DELIM) (CHARCODE /))) (* ; "User is using slash notation, so this looks less weird.") "/") (T "<")) FILENAME)) (if (NOT DELIM) then (* ; "Must be single top level directory?") (SETQ FILENAME (CONCAT FILENAME ">"))) (* ; "Show modified file name") (FM.CHANGELABEL DIRITEM FILENAME WINDOW))) (RETURN (if (SETQ DEV (\GETDEVICEFROMNAME (SETQ FULLNAME (CONCAT "{" HOST "/n}" FILENAME)) T)) then (CONS DEV FULLNAME) else (NSPROT.PROMPT WINDOW "Server ~A not found." HOST) NIL))))
)

(NFSPROT.SET.HOST
(LAMBDA (WINDOW HOSTFIELD) (* ; "Edited 27-Jun-89 12:00 by bvm") (LET ((HOSTITEM (FM.GETITEM (QUOTE HOST) NIL WINDOW)) (STRIPPED-NAME (SUBSTRING HOSTFIELD 1 -3))) (* ; "Sans /N") (if (NOT (STREQUAL STRIPPED-NAME (FM.ITEMPROP HOSTITEM (QUOTE LABEL)))) then (FM.CHANGELABEL HOSTITEM STRIPPED-NAME WINDOW))))
)

(NFSPROT.CHANGE.LABEL
(LAMBDA (WINDOW ID LABEL) (* ; "Edited 28-Jun-89 16:03 by bvm") (FM.CHANGELABEL (FM.GETITEM ID NIL WINDOW) LABEL WINDOW))
)

(NFSPROT.GET.FINFO
(LAMBDA (WINDOW DEV FILENAME OUTPUTP) (* ; "Edited 30-Jun-89 19:08 by bvm") (* ;; "Looks up FILENAME on DEV, returning the full name (sans host).  WINDOW is the window in which FILENAME is the DIR item--we will change it if appropriate.  Returns NIL on file not found.") (CL:MULTIPLE-VALUE-BIND (FINFO DINFO) (NFS::NFS-GETFILE DEV FILENAME NIL (QUOTE OLD) (QUOTE NFS::HANDLE)) (if (NULL FINFO) then (NSPROT.PROMPT WINDOW "~A not found." (if (NSPROT.DIRECTORY.SYNTAXP FILENAME) then "Directory" elseif (STRPOS ">" FILENAME) then (* ; "Looks like a file") "File" else (* ; "Could be either if they were sloppy") "Directory/file")) NIL else (LET* ((PROBLEM (if (NOT OUTPUTP) then (* ; "Follow links during Show! since we give nice feedback") (do (if (NOT (NFSPROT.LINKP FINFO)) then (RETURN NIL) else (LET ((*UPPER-CASE-FILE-NAMES* NIL)) (CL:MULTIPLE-VALUE-BIND (F D) (NFS::FIND-SYMBOLIC-LINK-TARGET DINFO FINFO) (if F then (SETQ FINFO F) (SETQ DINFO D) else (RETURN "File is a link we can't follow.")))))) elseif (NFSPROT.LINKP FINFO) then (* ; "Don't chase links when setting protection") "File is a link.  First use Show! to resolve it.")) (REPARSED (NSPROT.STRIP.HOST (NFS::NFS-NAMESTRING (NFS::FILEINFO-FILEPATH FINFO) NIL (NFS::FILEINFO-FATTR FINFO)))) (STRIPPED-NAME (CDR REPARSED))) (if (NOT (STREQUAL STRIPPED-NAME FILENAME)) then (NFSPROT.CHANGE.LABEL WINDOW (QUOTE DIR) STRIPPED-NAME)) (NFSPROT.SET.HOST WINDOW (CAR REPARSED)) (if PROBLEM then (NSPROT.PROMPT WINDOW PROBLEM) (* ; "We've updated window, but refuse to continue because file is a link") NIL else (CL:VALUES FINFO DINFO))))))
)

(NFSPROT.FETCH.ATTRIBUTE
(LAMBDA (FINFO DINFO ATTRIBUTE) (* ; "Edited 22-Jun-89 19:10 by bvm") (NFS::ATTRIBUTE-FROM-FATTR (NFS::FILEINFO-FATTR FINFO) ATTRIBUTE (NFS::FILEINFO-FILEHANDLE FINFO) DINFO))
)

(NFSPROT.LINKP
(LAMBDA (FINFO) (* ; "Edited 27-Jun-89 11:28 by bvm") (EQ (NFS::FATTR-TYPE (NFS::FILEINFO-FATTR FINFO)) NFS::NFLNK))
)
)
(DEFINEQ

(NFSPROT.APPLY
(LAMBDA (ITEM WINDOW BUTTONS) (* ; "Edited  2-Aug-89 16:28 by bvm") (NFSPROT.CHANGE.LABEL WINDOW (QUOTE OWNER) "") (* ; "Clear owner, since we can't set that") (LET (DEV&FILESPEC PROT) (NSPROT.PROMPT WINDOW T "Click LEFT to confirm setting the displayed protection") (if (AND (MOUSECONFIRM T T) (SETQ DEV&FILESPEC (NFSPROT.PARSE.FILENAME WINDOW))) then (PROG ((PROT 0) (MASK 0) (GROUP (FM.ITEMPROP (FM.GETITEM (QUOTE GROUP) NIL WINDOW) (QUOTE LABEL))) GID) (if (AND (> (NCHARS GROUP) 0) (NULL (SETQ GID (YP:GROUP-GID GROUP)))) then (RETURN (NSPROT.PROMPT WINDOW "Can't find a group named ~A" GROUP))) (for I from 0 to 11 as (BIT _ 1) by (LLSH BIT 1) unless (EQ I 9) do (* ;; "Look at the read/write/execute items, whose id tells the bit position (from right)") (SELECTQ (FM.ITEMPROP (FM.GETITEM I NIL WINDOW) (QUOTE STATE)) (T (* ; "Set this bit") (SETQ PROT (LOGOR PROT BIT))) (OFF (* ; "Turn this bit off --just leave PROT alone")) (NIL (* ; "Leave this bit alone--turn it off in mask") (SETQ MASK (LOGOR MASK BIT))) NIL)) (CL:MULTIPLE-VALUE-BIND (RESULT CONDITION) (IGNORE-ERRORS (DESTRUCTURING-BIND (DEV . FILESPEC) DEV&FILESPEC (NFSPROT.SET.PROTECTION WINDOW DEV FILESPEC PROT MASK GID))) (if CONDITION then (NSPROT.PROMPT WINDOW "~&Failed: ~A" (CL:STRING-TRIM (QUOTE (#\Newline)) (CL:PRINC-TO-STRING CONDITION)))))))))
)

(NFSPROT.SET.MULTIPLE
(LAMBDA (WINDOW DEV FILESPEC PROT MASK GID) (* ; "Edited 30-Jun-89 15:46 by bvm") (NSPROT.PROMPT WINDOW "Enumerating ~A..." (SETQ FILESPEC (DIRECTORY.FILL.PATTERN FILESPEC))) (RESETLST (LET* ((DEPTH (FM.ITEMPROP (FM.GETITEM (QUOTE DEPTH-VALUE) NIL WINDOW) (QUOTE STATE))) (FILING.ENUMERATION.DEPTH (OR (FIXP DEPTH) (PROGN (* ; "set depth to nearly infinity without telling the generator to filter out directories (actually, not an issue currently with nfs)") MAX.SMALLP))) (GEN (\GENERATEFILES FILESPEC NIL (QUOTE (RESETLST)))) (OK 0) (FAILED 0) (UNCHANGED 0) (FIRSTTIME T) (DIRITEM (FM.GETITEM (QUOTE DIR) NIL WINDOW)) FILE STATUS) (DECLARE (CL:SPECIAL FILING.ENUMERATION.DEPTH)) (RESETSAVE NIL (LIST (QUOTE FM.CHANGELABEL) DIRITEM (FM.ITEMPROP DIRITEM (QUOTE LABEL)) WINDOW)) (* ; "Arrange to restore label after we've cycled thru all the files") (while (SETQ FILE (\GENERATENEXTFILE GEN)) do (SETQ FILE (NSPROT.STRIP.HOST FILE)) (if FIRSTTIME then (SETQ FIRSTTIME NIL) (* ; "Fix host field if appropriate") (NFSPROT.SET.HOST WINDOW (CAR FILE))) (FM.CHANGELABEL DIRITEM (SETQ FILE (CDR FILE)) WINDOW) (if (\GENERATEFILEINFO GEN (QUOTE LINK)) then (NSPROT.PROMPT WINDOW "~&~A is a link" FILE) (add FAILED 1) else (CL:MULTIPLE-VALUE-BIND (FINFO DINFO) (\GENERATEFILEINFO GEN (QUOTE NFS::FILEINFO)) (CASE (NFSPROT.SET.PROTECTION.ONE FINFO DINFO PROT MASK GID WINDOW FILE) ((T) (add OK 1)) ((NIL) (add FAILED 1)) ((:NOCHANGE) (add UNCHANGED 1)))))) (if FIRSTTIME then (NSPROT.PROMPT WINDOW "no files match the pattern.") else (NSPROT.PROMPT WINDOW "~&Done~@[, set protection on ~D files~]~@[, failed to set ~D~]~@[, ~D needed no modification~]." (AND (> OK 0) OK) (AND (> FAILED 0) FAILED) (AND (> UNCHANGED 0) UNCHANGED))))))
)

(NFSPROT.SET.PROTECTION.ONE
(LAMBDA (FINFO DINFO PROT MASK GID WINDOW NAME) (* ; "Edited  2-Aug-89 17:04 by bvm") (PROG (STATUS) (if (NULL FINFO) then (* ; "Couldn't get handle.  Act like access error") (SETQ STATUS 13) elseif (OR (NULL GID) (= GID (NFSPROT.FETCH.ATTRIBUTE FINFO DINFO (QUOTE GROUP.ID))) (EQ (SETQ STATUS (NFS::SETFILEINFO-INTERNAL DINFO FINFO (QUOTE GROUP.ID) GID)) T)) then (LET* ((OLDPROT (NFSPROT.FETCH.ATTRIBUTE FINFO DINFO (QUOTE PROTECTION))) (NEWPROT (LOGOR PROT (LOGAND OLDPROT MASK)))) (if (EQ OLDPROT NEWPROT) then (RETURN (OR STATUS :NOCHANGE)) else (if (EQ (SETQ STATUS (NFS::SETFILEINFO-INTERNAL DINFO FINFO (QUOTE PROTECTION) NEWPROT)) T) then (RETURN T))))) (NSPROT.PROMPT WINDOW "~@[~&~A ~]Failed~@[: ~A~]" NAME (NFS::NFS-STATUS-TO-STRING STATUS)) (RETURN NIL)))
)

(NFSPROT.SET.PROTECTION
(LAMBDA (WINDOW DEV FILESPEC PROT MASK GID) (* ; "Edited 28-Jun-89 16:34 by bvm") (if (STRPOS "*" FILESPEC) then (NFSPROT.SET.MULTIPLE WINDOW DEV FILESPEC PROT MASK GID) else (CL:MULTIPLE-VALUE-BIND (FINFO DINFO) (NFSPROT.GET.FINFO WINDOW DEV FILESPEC T) (if FINFO then (CASE (NFSPROT.SET.PROTECTION.ONE FINFO DINFO PROT MASK GID WINDOW) ((T) (NSPROT.PROMPT WINDOW T "Done, set protection to ~O." (NFSPROT.FETCH.ATTRIBUTE FINFO DINFO (QUOTE PROTECTION)))) ((:NOCHANGE) (NSPROT.PROMPT WINDOW T "Protection is already set that way.")))))))
)
)

(RPAQQ NFSPROT.ICON (#*(80 40)OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOL@@@@@@@@@@@@@@@@@@CL@@@@@@@@@@@@@@@@@@CL@@@@@@@@@@@@@@@@@@CL@@@@@@@@@@@@@@@@@@CL@@@@@@@@@@@@@@AN@@CL@@@@@@@@@@@@@@GOH@CL@@@@@@@@@@@@@@OOL@CL@@@@@@@@@@@@@@GCN@CL@@@@@@@@@@@@@@FAN@CL@@@@@@@@@@@@@C@@O@CL@@@@@@@@@@@@@C@@O@CL@@@@@@@@@@@@@GH@G@CL@@@@@@@@@@@@@GH@GHCL@@@@@@@@@@@@@GH@GHCL@@@@@@@@@@@@@O@@CHCL@@@@@@@@@@@@@O@@CHCLAOOOOOOOOOOOOO@@CHCL@OOOOOOOOOOOOO@@@@CL@OOOOOOOOOOOOO@@@@CLAOOOOOOOOOOOOO@@CHCL@GN@@@@@@@@@@O@@CHCL@GNDH@@@@@@@@O@@CHCL@GNDJEE@@@@@@GH@GHCL@FFDKEB@@@@@@GH@GHCL@FFDJMB@@@@@@GH@G@CL@@@CBEE@@@@@@C@@O@CL@@@@@@@@@@@@@C@@O@CL@@@@@@@@@@@@@@FAN@CL@@@@@@@@@@@@@@GCN@CL@@@@@@@@@@@@@@OOL@CL@@@@@@@@@@@@@@GOH@CL@@@@@@@@@@@@@@CO@@CL@@@@@@@@@@@@@@@L@@CL@@@@@@@@@@@@@@@@@@CL@@@@@@@@@@@@@@@@@@CL@@@@@@@@@@@@@@@@@@COOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO NIL (4 22 51 14)))
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS NFSPROT.ICON)
)
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(LOCALVARS . T)
)

(FILESLOAD (SYSLOAD) NSPROTECTION)
(DEFINEQ

(ADD.NFSPROTECTION
(LAMBDA (LST) (* ; "Edited 22-Jun-89 18:45 by bvm") (* ;; "Add an entry for the NSPROTECTION tool to the background menu") (for X in (if LST then (* ; "Mumbling thru sub items") (CDR LST) else (SETQ LST BackgroundMenuCommands)) bind (COM _ (QUOTE ("NFS Protection" (QUOTE (NFSPROTECTION)) "Start up the NFS File protection tool."))) do (if (STRING-EQUAL (CAR X) "NFS Protection") then (RETURN (RPLACD X (CDR COM))) elseif (AND (STRING-EQUAL (CAR X) "System") (CADDDR X)) then (RETURN (ADD.NFSPROTECTION (CADDDR X)))) finally (NCONC1 LST COM)) (SETQ BackgroundMenu NIL) (* ; "also, load fonts") (NSPROT.GET.FONT T) (COND ((CCODEP (QUOTE ADD.NFSPROTECTION)) (* ; "self destruct") (AND (PUTD (QUOTE ADD.NFSPROTECTION))))))
)
)
(DECLARE%: DONTEVAL@LOAD DOCOPY 

(ADD.NFSPROTECTION)

(ADVISE (QUOTE (FONTCOPY IN ICONW.PRINT-JUSTIFIED)) (QUOTE BEFORE) (QUOTE (COND ((EQ (FONTPROP (ARG U 1) (QUOTE DEVICE)) (QUOTE DISPLAY)) (RETURN (ARG U 1))) (T (SETARG U 3 (QUOTE DISPLAY))))))
)
(PUTPROPS NFSPROTECTION COPYRIGHT ("Xerox Corporation" 1989))
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (1134 6881 (NFSPROTECTION 1144 . 5197) (NFSPROT.MAKE.SUBITEM 5199 . 6220) (
NFSPROT.ICONFN 6222 . 6653) (NFSPROT.HANDLE.DEPTH 6655 . 6879)) (6882 12360 (NFSPROT.SHOW 6892 . 7804)
 (NFSPROT.CLEAR 7806 . 8122) (NFSPROT.PARSE.FILENAME 8124 . 9906) (NFSPROT.SET.HOST 9908 . 10237) (
NFSPROT.CHANGE.LABEL 10239 . 10388) (NFSPROT.GET.FINFO 10390 . 12011) (NFSPROT.FETCH.ATTRIBUTE 12013
 . 12219) (NFSPROT.LINKP 12221 . 12358)) (12361 16845 (NFSPROT.APPLY 12371 . 13716) (
NFSPROT.SET.MULTIPLE 13718 . 15470) (NFSPROT.SET.PROTECTION.ONE 15472 . 16274) (NFSPROT.SET.PROTECTION
 16276 . 16843)) (17851 18607 (ADD.NFSPROTECTION 17861 . 18605)))))
STOP
